<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA TRANSPORTES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Carrega a biblioteca Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/resend@3.2.0/dist/index.global.js"></script>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

    <!-- Leaflet (Mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <!-- Ícones Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            color: #1f2937; /* Cor de texto principal escura */
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        /* GRADIENTE DE FUNDO (Como no screenshot) */
        .main-gradient {
             background: linear-gradient(to bottom, #a0feff, #c3e6ff, #e6c3ff, #ffc3f2);
        }
        .button-gradient {
            background: linear-gradient(to right, #6d28d9, #4f46e5);
        }
        .button-gradient:hover {
            background: linear-gradient(to right, #4f46e5, #6d28d9);
        }
        
        /* Botões de card escuros (Como no screenshot) */
        .card-gradient {
             background: linear-gradient(135deg, #1f2937, #374151);
             color: white; /* Garante que o texto dentro seja branco */
        }
        
        /* Ajuste para ícones Phosphor (NOVO) */
        [class*="ph-"] {
            font-size: 1.1em;
            line-height: 1;
            vertical-align: -0.1em;
            margin-right: 0.25em;
        }
        .icon-container {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .icon-container [class*="ph-"] {
            font-size: 1.5rem;
            color: white;
            vertical-align: 0;
            margin-right: 0;
        }
        
        /* Links de "Voltar" (NOVO) */
        .back-link {
             color: #1f2937;
             font-weight: 500;
        }
        .back-link:hover {
             color: #000000;
        }

        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #6d28d9;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ESTILO PARA O AUTOCOMPLETE CUSTOMIZADO */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #374151;
            border: 1px solid #4b5563;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1050;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .autocomplete-list.show {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #4b5563;
            color: white !important;
            transition: background-color 0.2s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #4b5563;
        }

        .autocomplete-item strong {
            color: #00ffff;
        }

        .loading, .no-results {
            padding: 10px 12px;
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
        
        #heatmap-canvas {
            height: 70vh;
            width: 100%;
            border-radius: 0.5rem;
            border: 2px solid #4f46e5;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ef4444;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #22c55e;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
        }
        .status-requested { background-color: #2563eb; color: #ffffff; }
        .status-assigned { background-color: #f59e0b; color: #ffffff; }
        .status-accepted { background-color: #10b981; color: #ffffff; }
        .status-arrived_pickup { background-color: #d946ef; color: #ffffff; }
        .status-in_progress { background-color: #8b5cf6; color: #ffffff; }
        .status-completed { background-color: #10b981; color: #ffffff; }
        .status-canceled { background-color: #ef4444; color: #ffffff; }
        .status-pending_approval { background-color: #a16207; color: #ffffff; }
        .status-approved { background-color: #0d9488; color: #ffffff; }
        .status-rejected { background-color: #991b1b; color: #ffffff; }

        #initial-screen button[onclick="showScreen('user-login-screen')"],
        #initial-screen button[onclick="showScreen('driver-selection-screen')"] {
            display: none;
        }

        /* Ajustes de cor globais */
        h1, h2, h3, h4, label, button, a {
            color: #1f2937; /* Texto escuro por padrão */
        }
        button[onclick^="showScreen"], #admin-login-screen label, #user-login-screen label, #driver-selection-screen h2, #initial-screen h1, #initial-screen p {
             color: #1f2937;
        }
         #initial-screen button span, #initial-screen button svg {
            color: white !important; /* Texto dos botões iniciais branco */
        }
         
         /* Cor dos links "Voltar" */
         button.text-yellow-300 {
             color: #1f2937 !important; /* MUDADO de amarelo para escuro */
             font-weight: 500;
         }
         button.text-yellow-300:hover {
             color: #000000 !important;
         }

         #admin-login-error, #user-login-error {
             color: #dc2626;
         }
         
         /* Texto dentro de cards escuros DEVE ser branco */
         .card-gradient, .card-gradient p, .card-gradient h3, .card-gradient span, .card-gradient label, .card-gradient button, .card-gradient a,
         #admin-requests-list span, #admin-requests-list p, #admin-requests-list h4,
         #admin-ongoing-rides-table th, #admin-ongoing-rides-table td,
         #driver-crud-list th, #driver-crud-list td, #driver-crud-list h3, #driver-crud-list p, #driver-crud-list button,
         #user-crud-list th, #user-crud-list td, #user-crud-list h3, #user-crud-list p, #user-crud-list button,
         #driver-jobs-list p, #driver-jobs-list span,
         #user-ride-history th, #user-ride-history td,
         #driver-ride-history th, #driver-ride-history td,
         #all-records-table th, #all-records-table td,
         #modal p, #modal label, #modal button, #modal select option {
             color: white;
         }
         /* Corrigir cor do texto dos botões Editar/Excluir DENTRO dos cards */
         #driver-crud-list .bg-green-600, #user-crud-list .bg-green-600,
         #driver-crud-list .bg-red-600, #user-crud-list .bg-red-600 {
             color: white !important;
         }
         
         #modal input, #modal select {
             color: white;
         }
         #modal input::placeholder {
             color: #9ca3af;
         }
         
         /* Botões do painel admin (texto branco) */
         #admin-screen .card-gradient span {
             color: white;
         }

         #admin-ongoing-rides-table .text-yellow-300, #admin-requests-list .text-yellow-300 {
              color: #facc15 !important;
         }
         #admin-ongoing-rides-table .text-red-400, #admin-requests-list .text-red-400 {
              color: #f87171 !important;
         }
         #user-status-message, #available-drivers-count {
             color: #1f2937;
         }
         #driver-name-display, #driver-stats-display, #driver-status-label {
              color: #1f2937;
         }
         #driver-status-label.text-green-400 { color: #22c55e !important; }
         #driver-status-label.text-red-400 { color: #ef4444 !important; }

        input[type="date"], input[type="datetime-local"] {
            color-scheme: dark;
        }

        /* ===== ESTILOS RESPONSIVOS PARA MOBILE ===== */
        @media (max-width: 768px) {
            /* Ajustes gerais de texto */
            body {
                font-size: 14px;
            }

            h1 {
                font-size: 1.75rem !important;
            }

            h2 {
                font-size: 1.5rem !important;
            }

            h3 {
                font-size: 1.25rem !important;
            }

            /* Ajustes do header e ícone */
            #initial-screen h1 {
                font-size: 1.5rem !important;
            }

            #app-icon-container {
                height: 2rem !important;
                width: 2rem !important;
            }

            /* Botões mais acessíveis no mobile */
            button {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Ajuste de padding do container */
            #app-container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Cards com melhor espaçamento mobile */
            .card-gradient {
                padding: 1rem !important;
            }

            /* Inputs maiores para mobile */
            input, select, textarea {
                font-size: 16px !important; /* Previne zoom automático no iOS */
                min-height: 44px;
            }

            /* Tabelas responsivas com scroll horizontal */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            table thead {
                display: table-header-group;
            }

            table tbody {
                display: table-row-group;
            }

            table th, table td {
                font-size: 0.875rem;
                padding: 0.5rem !important;
            }

            /* Ajuste de grid para mobile */
            .grid {
                gap: 1rem !important;
            }

            /* Modal responsivo */
            #modal > div {
                max-width: 95% !important;
                margin: 0.5rem;
                max-height: 95vh;
                overflow-y: auto;
            }

            /* Mapa responsivo */
            #heatmap-canvas {
                height: 50vh !important;
            }

            /* Chart responsivo */
            canvas {
                max-height: 300px;
            }

            /* Ajuste de ícones para mobile */
            .icon-container {
                width: 32px !important;
                height: 32px !important;
            }

            .icon-container [class*="ph-"] {
                font-size: 1.25rem !important;
            }

            /* Ajuste dos status badges */
            .status-badge {
                font-size: 0.75rem !important;
                padding: 0.2rem 0.5rem !important;
            }

            /* Relógio digital menor */
            #digital-clock {
                font-size: 1.5rem !important;
            }

            /* Botões de ação com melhor espaçamento */
            .space-y-4 > * {
                margin-top: 0.75rem !important;
            }

            /* Ajuste do countdown timer */
            #countdown-timer {
                top: 0.5rem;
                right: 0.5rem;
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }

            /* Melhor visualização de cards de solicitação */
            #admin-requests-list .card-gradient {
                font-size: 0.875rem;
            }

            /* Ajustes específicos para tabelas de histórico */
            #user-ride-history, #driver-ride-history, #all-records-table {
                font-size: 0.75rem;
            }

            /* Autocomplete list mais visível */
            .autocomplete-list {
                max-height: 150px;
                font-size: 0.875rem;
            }

            .autocomplete-item {
                padding: 0.75rem;
            }

            /* Ajuste de grids específicos */
            .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }

            .grid-cols-1.lg\\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }

            /* Espaçamento entre elementos */
            .mb-8 {
                margin-bottom: 1.5rem !important;
            }

            .mb-6 {
                margin-bottom: 1rem !important;
            }

            /* Ajuste de flex para melhor visualização */
            .flex.flex-row {
                flex-direction: row !important;
                align-items: center !important;
            }

            /* Garantir que SVGs não quebrem layout */
            svg {
                flex-shrink: 0;
            }

            /* Ajuste do toggle switch */
            .toggle-switch {
                width: 44px;
                height: 24px;
            }

            /* Status icons maiores para melhor visualização */
            #status-icon-searching img,
            #status-icon-en-route img,
            #status-icon-arrived-pickup img,
            #status-icon-in-progress img {
                max-width: 100px;
            }

            /* Loader maior para mobile */
            .loader {
                width: 50px;
                height: 50px;
            }

            /* Ajuste de overflow para listas longas */
            .max-h-\[calc\(100vh-250px\)\] {
                max-height: calc(100vh - 200px) !important;
            }

            /* Garantir scroll suave */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }

            /* Ajustes finais para garantir usabilidade */
            * {
                -webkit-tap-highlight-color: transparent;
            }

            /* Melhor visualização de formulários */
            form > div {
                margin-bottom: 1rem;
            }
        }

        /* Ajustes para telas muito pequenas (< 375px) */
        @media (max-width: 375px) {
            #initial-screen h1 {
                font-size: 1.25rem !important;
            }

            h2 {
                font-size: 1.25rem !important;
            }

            button span {
                font-size: 0.875rem;
            }

            table th, table td {
                font-size: 0.75rem;
                padding: 0.375rem !important;
            }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            #app-container {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            .mb-8, .mb-6, .mb-4 {
                margin-bottom: 0.5rem !important;
            }

            h1, h2 {
                font-size: 1.25rem !important;
                margin-bottom: 0.5rem !important;
            }

            button {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        }

    </style>
</head>
<body class="main-gradient text-white min-h-screen flex items-center justify-center p-4">

    <!-- Elemento de áudio removido - agora usa Web Audio API -->

    <div id="countdown-timer" class="fixed top-4 right-4 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded-full"></div>

    <div id="app-container" class="w-full max-w-full mx-auto px-4 sm:px-6 lg:px-8">

        <!-- TELA INICIAL -->
        <div id="initial-screen" class="screen active text-center">
            <div class="flex justify-center items-center gap-4 mb-2">
                <div id="app-icon-container" class="h-12 w-12"></div>
                <h1 class="text-4xl sm:text-5xl font-bold text-black">GARCIA TRANSPORTE</h1>
            </div>

            <p class="mb-12 text-gray-800">Sua viagem segura e rápida.</p>
            <div class="space-y-4 max-w-md mx-auto">
                <button onclick="showScreen('admin-login-screen')" class="w-full flex items-center justify-center gap-3 py-4 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.602-3.751m-.228-1.024A11.953 11.953 0 0012 2.75a11.953 11.953 0 00-8.172 3.024" />
                    </svg>
                    <span>ÁREA DO ADMIN</span>
                </button>
                <button onclick="showScreen('user-login-screen')" class="w-full flex items-center justify-center gap-3 py-4 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>PASSAGEIRO</span>
                </button>
                <button onclick="showScreen('driver-selection-screen')" class="w-full flex items-center justify-center gap-3 py-4 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6m-6 0v-2a1 1 0 011-1h2a1 1 0 011 1v2m-6 0h6" />
                    </svg>
                   <span>MOTORISTA</span>
                </button>
            </div>
        </div>

        <!-- LOGIN ADMIN -->
        <div id="admin-login-screen" class="screen">
            <button onclick="showScreen('initial-screen')" class="mb-4 text-yellow-300">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Login Administrador</h2>
             <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="admin-password" class="block mb-2 text-sm font-medium">Senha</label>
                    <input type="password" id="admin-password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite a senha">
                </div>
                <button onclick="loginAdmin()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg text-white">ENTRAR</button>
                <p id="admin-login-error" class="text-red-500 text-center mt-4 hidden">Senha incorreta!</p>
            </div>
        </div>

        <!-- LOGIN USUÁRIO -->
        <div id="user-login-screen" class="screen">
            <button onclick="showScreen('initial-screen')" class="mb-4 text-yellow-300">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Login do Usuário</h2>
            <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="user-id" class="block mb-2 text-sm font-medium">Matrícula</label>
                    <input type="text" id="user-id" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite sua matrícula">
                </div>
                <div class="mb-4">
                    <label for="user-password" class="block mb-2 text-sm font-medium">Senha</label>
                    <input type="password" id="user-password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite sua senha">
                </div>
                <button onclick="loginUser()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg text-white">ENTRAR</button>
                <p id="user-login-error" class="text-red-500 text-center mt-4 hidden">Matrícula ou senha incorreta!</p>
            </div>
        </div>

        <!-- SELEÇÃO MOTORISTA -->
        <div id="driver-selection-screen" class="screen">
            <button onclick="showScreen('initial-screen')" class="mb-4 text-yellow-300">← Voltar</button>
            <h2 class="text-3xl font-bold mb-1 text-center">Selecionar Motorista</h2>
            <p id="driver-selection-timestamp" class="text-center text-gray-700 text-sm mb-6"></p>
            <div id="driver-list-selection" class="space-y-3 max-w-md mx-auto">
                <!-- Conteúdo gerado por JS -->
            </div>
        </div>

        <!-- TELA USUÁRIO -->
        <div id="user-screen" class="screen">
             <div class="max-w-md mx-auto">
                <button onclick="logout()" class="mb-4 text-yellow-300">← Sair</button>
                <h2 class="text-3xl font-bold mb-6 text-center">Área do Usuário</h2>

                <div id="user-request-form" class="card-gradient p-4 rounded-lg mb-6">
                    <h3 class="font-semibold mb-2 text-xl">Solicitar uma Viagem</h3>
                    <p id="available-drivers-count" class="text-center mb-4 text-lg text-green-400 font-semibold"></p>

                    <div class="mb-4 autocomplete-container">
                        <label for="origin" class="block mb-2 text-sm font-medium">Qual a sua origem?</label>
                        <input type="text" id="origin" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite o endereço de partida completo" readonly>
                    </div>

                    <div class="mb-4 autocomplete-container">
                        <label for="destination" class="block mb-2 text-sm font-medium">Qual o seu destino?</label>
                        <input type="text" id="destination" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite o endereço completo" readonly>
                    </div>

                    <div class="flex items-center mb-4">
                        <input id="schedule-toggle" type="checkbox" onchange="document.getElementById('schedule-datetime-container').classList.toggle('hidden')" class="h-4 w-4 rounded border-gray-300 text-yellow-300 focus:ring-yellow-300">
                        <label for="schedule-toggle" class="ml-2 block text-sm text-gray-300">Agendar para mais tarde?</label>
                    </div>
                    <div id="schedule-datetime-container" class="hidden mb-4">
                        <label for="schedule-datetime" class="block mb-2 text-sm font-medium">Data e Hora do Agendamento</label>
                        <input type="datetime-local" id="schedule-datetime" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" style="color-scheme: dark;">
                    </div>

                    <button onclick="requestRide()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform text-white">
                        SOLICITAR TAXI
                    </button>
                </div>

                <div id="user-status" class="hidden mt-8 text-center">
                    <div id="status-icon-searching" class="hidden mx-auto mb-2">
                        <div class="loader mx-auto"></div>
                    </div>
                    <div id="status-icon-en-route" class="hidden mx-auto mb-2">
                        <!-- Imagem 'aceitou.png' vai aqui via JS -->
                    </div>
                    <div id="status-icon-arrived-pickup" class="hidden mx-auto mb-2">
                        <!-- Imagem 'final.png' vai aqui via JS -->
                    </div>
                    <div id="status-icon-in-progress" class="hidden mx-auto mb-2">
                        <!-- Imagem 'destino.png' vai aqui via JS -->
                    </div>
                    <p id="user-status-message" class="mt-4 text-lg"></p>
                    <button id="cancel-ride-btn" onclick="cancelRide()" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg bg-red-600 hover:bg-red-700 text-white">CANCELAR SOLICITAÇÃO</button>
                </div>
                <div class="card-gradient p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl">Minhas Solicitações</h3>
                        <button onclick="exportUserRidesToExcel()" class="py-1 px-3 text-sm font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">Exportar</button>
                    </div>
                    <div id="user-ride-history" class="overflow-x-auto">
                        <!-- Conteúdo gerado por JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TELA ADMIN -->
        <div id="admin-screen" class="screen">
             <button onclick="showScreen('initial-screen')" class="mb-4 back-link">← Sair</button>
            <h2 class="text-3xl font-bold mb-2 text-center">Painel do Administrador</h2>
            <p id="admin-timestamp" class="text-center text-gray-700 text-sm mb-8"></p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <button onclick="showScreen('admin-requests-screen')" class="w-full text-lg font-semibold rounded-lg shadow-lg flex flex-row items-center gap-4 p-5 card-gradient">
                    <div class="icon-container bg-purple-500"><i class="ph-bold ph-file-text"></i></div>
                    <span>Solicitações de Corrida</span>
                </button>
                <button onclick="showScreen('admin-driver-crud-screen')" class="w-full text-lg font-semibold rounded-lg shadow-lg flex flex-row items-center gap-4 p-5 card-gradient">
                    <div class="icon-container bg-blue-500"><i class="ph-bold ph-steering-wheel"></i></div>
                    <span>Cadastro de Motoristas</span>
                </button>
                <button onclick="showScreen('admin-user-crud-screen')" class="w-full text-lg font-semibold rounded-lg shadow-lg flex flex-row items-center gap-4 p-5 card-gradient">
                    <div class="icon-container bg-pink-500"><i class="ph-bold ph-users"></i></div>
                    <span>Cadastro de Usuários</span>
                </button>
                <button onclick="showScreen('admin-heatmap-screen')" class="w-full text-lg font-semibold rounded-lg shadow-lg flex flex-row items-center gap-4 p-5 card-gradient">
                    <div class="icon-container bg-green-500"><i class="ph-bold ph-map-pin"></i></div>
                    <span>Mapa de Usuários</span>
                </button>
                <button onclick="openRecordsTab()" class="w-full text-lg font-semibold rounded-lg shadow-lg flex flex-row items-center gap-4 p-5 card-gradient">
                    <div class="icon-container bg-orange-500"><i class="ph-bold ph-archive"></i></div>
                    <span>Todos os Registros</span>
                </button>
                <button onclick="showScreen('admin-customize-screen')" class="w-full text-lg font-semibold rounded-lg shadow-lg flex flex-row items-center gap-4 p-5 card-gradient">
                    <div class="icon-container bg-gray-500"><i class="ph-bold ph-gear"></i></div>
                    <span>Personalizar App</span>
                </button>
                <a href="https://dashboard-with-supabase.lumi.ing" target="_blank" rel="noopener noreferrer" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg text-center flex flex-col items-center gap-2 card-gradient hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
            </div>
        </div>

        <!-- TELA ADMIN CORRIDAS -->
        <div id="admin-requests-screen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="promptToGoBack()" class="text-yellow-300">← Voltar ao Painel</button>
                <h2 class="text-3xl font-bold text-center">Painel de Corridas</h2>
                <div class="w-32"></div> <!-- Spacer -->
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                 <div class="card-gradient p-3 rounded-lg w-full" style="height: fit-content;">
                    <h3 class="font-semibold mb-2 text-center">Status das Corridas</h3>
                    <div class="flex justify-around text-center flex-wrap gap-2">
                        <div>
                            <p class="text-2xl font-bold text-orange-400" id="status-agendada-count">0</p>
                            <p class="text-xs text-gray-300">Agendada</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-400" id="status-solicitado-count">0</p>
                            <p class="text-xs text-gray-300">Solicitado</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-yellow-400" id="status-designado-count">0</p>
                            <p class="text-xs text-gray-300">Designado</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-purple-400" id="status-em-andamento-count">0</p>
                            <p class="text-xs text-gray-300">Em Andamento</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400" id="status-concluidas-count">0</p>
                            <p class="text-xs text-gray-300">Concluídas</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-600 text-center">
                        <div id="digital-clock" class="text-3xl font-mono text-cyan-300 mb-2">00:00:00</div>
                        <button onclick="exportDailyReportNow()" class="w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">
                            EXPORTAR
                        </button>
                    </div>
                </div>
                <div class="card-gradient p-3 rounded-lg w-full lg:col-span-2" style="height: fit-content;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div>
                            <h3 class="font-semibold text-2xl mb-4">Motoristas</h3>
                            <div class="space-y-1 text-base">
                                <p>Total: <span id="total-drivers-count" class="font-bold">0</span></p>
                                <p class="text-green-400">Ativos: <span id="active-drivers-count" class="font-bold">0</span></p>
                                <p class="text-red-400">Inativos: <span id="inactive-drivers-count" class="font-bold">0</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-4">
                            <div class="w-32 h-32">
                                <canvas id="driver-status-chart"></canvas>
                            </div>
                            <button onclick="showScreen('admin-driver-crud-screen')" class="w-full py-2 px-3 text-sm font-semibold rounded-lg button-gradient text-white">
                                Gerenciar Motoristas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 max-h-[calc(100vh-250px)] overflow-y-auto pr-2">
                <div class="lg:col-span-1">
                    <h3 class="text-2xl font-bold mb-4">Novas Solicitações</h3>
                    <div id="admin-requests-list" class="space-y-4">
                        <!-- Conteúdo gerado por JS -->
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <h3 class="text-2xl font-bold mb-4">Corridas em Andamento</h3>
                    <div id="admin-ongoing-rides-table" class="card-gradient p-4 rounded-lg overflow-x-auto">
                        <!-- Conteúdo gerado por JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TELA CADASTRO MOTORISTAS -->
        <div id="admin-driver-crud-screen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('admin-screen')" class="back-link">← Voltar</button>
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-center text-black">Cadastro de Motoristas</h2>
                    <p id="driver-count" class="text-gray-700 text-sm mt-1">0 motorista(s) cadastrado(s)</p>
                </div>
                <div class="w-24"></div> <!-- Spacer -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card-gradient p-4 rounded-lg h-fit">
                    <h3 class="font-semibold mb-2">Adicionar Novo Motorista</h3>
                    <input type="text" id="new-driver-name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Nome Completo">
                    <input type="tel" id="new-driver-phone" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Telefone">
                    <input type="text" id="new-driver-plate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Placa do Carro">
                    <input type="text" id="new-driver-model" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Modelo do Carro">
                    <input type="text" id="new-driver-color" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Cor do Carro">
                    <input type="password" id="new-driver-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Senha">
                    <button onclick="addDriver()" class="w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">Adicionar</button>
                </div>
                
                <div class="card-gradient p-4 rounded-lg md:col-span-2 max-h-[80vh] overflow-y-auto">
                    <h3 class="font-semibold mb-4 text-xl">Motoristas Cadastrados</h3>
                    <div id="driver-crud-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Cards de motorista gerados por JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TELA CADASTRO USUÁRIOS -->
        <div id="admin-user-crud-screen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('admin-screen')" class="back-link">← Voltar</button>
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-center text-black">Cadastro de Usuários</h2>
                    <p class="text-gray-700 text-sm mt-1">
                        <span id="user-count-display">0</span> usuário(s) cadastrado(s)
                    </p>
                </div>
                <button onclick="exportUsersToExcel()" class="py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-sm text-white">
                    Exportar Excel
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card-gradient p-4 rounded-lg h-fit">
                    <h3 class="font-semibold mb-2">Adicionar Novo Usuário</h3>
                    <input type="text" id="new-user-id" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Matrícula">
                    <input type="text" id="new-user-name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Nome Completo">
                    <input type="password" id="new-user-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Senha">
                    <input type="text" id="new-user-company" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Empresa">
                    
                    <div class="autocomplete-container mb-2">
                        <input type="text" id="new-user-address" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white" placeholder="Endereço (selecione da lista)" oninput="handleAddressInput(event, 'new-user-addressList')" onfocus="this.removeAttribute('readonly');" readonly>
                        <div class="autocomplete-list" id="new-user-addressList"></div>
                    </div>
                    
                    <input type="tel" id="new-user-phone" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Telefone">
                    <button onclick="addUser()" class="w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">Adicionar</button>
                </div>

                <div class="card-gradient p-4 rounded-lg md:col-span-2 max-h-[80vh] overflow-y-auto">
                    <h3 class="font-semibold text-xl mb-4">
                        Usuários Cadastrados
                    </h3>
                    <div id="user-crud-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Cards de usuário gerados por JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TELA MAPA DE CALOR -->
        <div id="admin-heatmap-screen" class="screen">
            <button onclick="showScreen('admin-screen')" class="mb-4 text-yellow-300">← Voltar ao Painel</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Mapa de Localização de Usuários</h2>
            <div id="heatmap-canvas"></div> 
        </div>

        <!-- TELA PERSONALIZAR -->
        <div id="admin-customize-screen" class="screen">
            <button onclick="showScreen('admin-screen')" class="mb-4 text-yellow-300">← Voltar ao Painel</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Personalizar App</h2>
            <div class="card-gradient p-4 rounded-lg max-w-md mx-auto">
                <h3 class="font-semibold mb-2">Ícone do Aplicativo</h3>
                <p class="text-sm text-gray-300 mb-3">Faça o upload de uma imagem para ser o ícone na tela inicial (recomendado: PNG transparente).</p>
                <input type="file" id="icon-file-input" accept="image/*" onchange="uploadAppIcon()" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
            </div>
        </div>

        <!-- TELA MOTORISTA -->
        <div id="driver-screen" class="screen">
            <div class="max-w-md mx-auto">
                <button onclick="showScreen('driver-selection-screen')" class="mb-4 text-yellow-300">← Trocar Motorista</button>
                <h2 class="text-3xl font-bold mb-2 text-center">Minhas Corridas</h2>
                <p id="driver-name-display" class="text-center mb-1"></p>
                <p id="driver-stats-display" class="text-center font-semibold text-sm mb-6"></p>
                <div class="flex items-center justify-between mb-4 card-gradient p-3 rounded-lg">
                    <span class="font-semibold text-lg">Meu Status</span>
                    <div class="flex items-center gap-3">
                        <span id="driver-status-label" class="font-bold"></span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="driver-status-toggle" onchange="toggleDriverStatus()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <button id="silence-btn" onclick="stopBeeping()" class="hidden w-full mb-4 py-2 px-4 font-semibold rounded-lg bg-yellow-500 text-gray-900">Silenciar Alerta</button>
                <div id="driver-jobs-list" class="space-y-4"></div>
                <div class="card-gradient p-4 rounded-lg mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl">Histórico de Corridas</h3>
                        <button onclick="exportDriverRidesToExcel()" class="py-1 px-3 text-sm font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">Exportar</button>
                    </div>
                    <div id="driver-ride-history" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <!-- TELA REGISTROS -->
        <div id="admin-records-screen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('admin-screen')" class="text-yellow-300">← Voltar ao Painel</button>
                <h2 class="text-3xl font-bold text-center">Todos os Registros</h2>
                <div class="w-32"></div> </div>

            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <div>
                    <label for="records-start-date" class="block mb-2 text-sm font-medium">Data Inicial</label>
                    <input type="date" id="records-start-date" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="records-end-date" class="block mb-2 text-sm font-medium">Data Final</label>
                    <input type="date" id="records-end-date" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="records-company-filter" class="block mb-2 text-sm font-medium">Selecione a Empresa</label>
                    <select id="records-company-filter" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none min-w-[200px] text-white">
                        <option value="" class="text-gray-400">Todas as Empresas</option>
                        </select>
                </div>
                <div class="flex items-end gap-2">
                     <button onclick="filterRecords()" class="py-2 px-4 font-semibold rounded-lg button-gradient h-fit text-white">Filtrar</button>
                     <button onclick="clearRecordsFilter()" class="py-2 px-4 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600 h-fit text-white">Limpar Filtro</button>
                     <button onclick="exportRecordsToExcel()" class="py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 h-fit text-white">Exportar Excel</button>
                </div>
            </div>
            <div class="card-gradient p-4 rounded-lg overflow-x-auto">
                <table id="all-records-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-900/30 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3">Data Solicitação</th>
                            <th scope="col" class="px-4 py-3">Data Agendada</th> <!-- NOVO -->
                            <th scope="col" class="px-4 py-3">Data Aceite</th>   <!-- NOVO -->
                            <th scope="col" class="px-4 py-3">Usuário</th>
                            <th scope="col" class="px-4 py-3">Empresa</th>
                            <th scope="col" class="px-4 py-3">Origem</th>
                            <th scope="col" class="px-4 py-3">Destino</th>
                            <th scope="col" class="px-4 py-3">Observação</th>
                            <th scope="col" class="px-4 py-3">Motorista</th>
                            <th scope="col" class="px-4 py-3">Status</th>
                            <th scope="col" class="px-4 py-3">Distância (km)</th>
                        </tr>
                    </thead>
                    <tbody id="all-records-body">
                        <!-- Conteúdo gerado por JS -->
                    </tbody>
                </table>
            </div>
        </div>
        </div>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <p id="modal-message" class="mb-4 text-lg"></p>
            <div id="modal-input-container" class="hidden mb-4 space-y-2">
                <input type="text" id="modal-input-matricula" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Matrícula">
                <input type="text" id="modal-input-name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Nome">
                <input type="tel" id="modal-input-phone" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Telefone">
                <input type="text" id="modal-input-plate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Placa do Carro">
                <input type="text" id="modal-input-model" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Modelo do Carro">
                <input type="text" id="modal-input-color" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Cor do Carro">
                <input type="password" id="modal-input-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Nova Senha (deixe em branco para manter)">
                <select id="modal-input-status" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none">
                    <option value="active">Ativo</option>
                    <option value="inactive">Inativo</option>
                </select>
                <input type="text" id="modal-input-company" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Empresa">
                <div class="autocomplete-container">
                    <input type="text" id="modal-input-address" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Endereço (selecione da lista)" oninput="handleAddressInput(event, 'modal-input-addressList')" onfocus="this.removeAttribute('readonly');" readonly>
                    <div class="autocomplete-list" id="modal-input-addressList"></div>
                </div>
                <input type="password" id="modal-input-driver-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Senha">
                <input type="password" id="modal-input-admin-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Senha do Admin">
            </div>
            <div id="modal-buttons" class="flex justify-center gap-4">
                 <button id="modal-cancel" onclick="closeModal()" class="py-2 px-6 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">Cancelar</button>
                 <button id="modal-confirm" class="py-2 px-8 font-semibold rounded-lg button-gradient">OK</button>
            </div>
        </div>
    </div>

    <script>
	        // <!-- Funções de renderização atualizadas -->
	        window.showScreen = function(screenId) {
	            const body = document.body;
	            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
	            const targetScreen = document.getElementById(screenId);
	            if (targetScreen) {
	                targetScreen.classList.add('active');
	            } else {
	                console.error('Tela não encontrada:', screenId);
	                return;
	            }
	            stopRingingAdmin();

        // ========================================
        // NOTIFICAÇÕES MOBILE
        // ========================================
        
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return Notification.permission === 'granted';
        }

        function sendMobileNotification(ride) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('🚗 Nova Solicitação!', {
                    body: `${ride.userName || 'Cliente'}\nOrigem: ${ride.originaddress || 'N/A'}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/3097/3097134.png',
                    vibrate: [300, 100, 300],
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Vibrar celular
            if ('vibrate' in navigator) {
                navigator.vibrate([300, 100, 300]);
            }
        }

        // Solicitar permissão ao primeiro toque
        document.addEventListener('DOMContentLoaded', () => {
            const requestOnce = async () => {
                await requestNotificationPermission();
                document.removeEventListener('click', requestOnce);
                document.removeEventListener('touchstart', requestOnce);
            };
            document.addEventListener('click', requestOnce, { once: true });
            document.addEventListener('touchstart', requestOnce, { once: true });
        });


            if(clockInterval) clearInterval(clockInterval);

            const container = document.getElementById('app-container');
            const needsExtraPadding = ['admin-requests-screen', 'admin-driver-crud-screen', 'admin-user-crud-screen', 'admin-heatmap-screen', 'admin-records-screen', 'admin-screen']; // 'admin-screen' adicionado
            if (needsExtraPadding.includes(screenId)) {
                container.classList.add('pt-8');
            } else {
                container.classList.remove('pt-8');
            }

            const fullHeightScreens = ['admin-requests-screen', 'admin-driver-crud-screen', 'admin-user-crud-screen', 'admin-heatmap-screen', 'admin-records-screen', 'admin-screen']; // 'admin-screen' adicionado
            if (fullHeightScreens.includes(screenId)) {
                body.classList.remove('items-center');
                body.classList.add('justify-start');
            } else {
                if (!body.classList.contains('items-center')) {
                    body.classList.add('items-center');
                }
                body.classList.remove('justify-start');
            }

            // Atualizações específicas da tela
            if (screenId === 'admin-screen') {
                const timestampEl = document.getElementById('admin-timestamp');
                if (timestampEl) {
                    timestampEl.textContent = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                }
            }
            if (screenId === 'admin-requests-screen') {
                loadAdminRequests();
                renderOngoingRidesTable();
                startDigitalClock('digital-clock');
            }
            if (screenId === 'admin-driver-crud-screen') renderDriverCrudList();
            if (screenId === 'admin-user-crud-screen') renderUserCrudList();
            if (screenId === 'admin-heatmap-screen') initHeatmap();
            if (screenId === 'driver-selection-screen') populateDriverSelection();
            if (screenId === 'driver-screen') {
                loadDriverJobs(); 
                renderDriverRideHistory(); 
            }
            if (screenId === 'user-screen') {
                checkUserRideStatus(); 
                updateAvailableDriversCount(); 
                renderUserRideHistory(); 
            }
            if (screenId === 'admin-records-screen') {
                loadAllRecords(); 
                document.getElementById('records-start-date').value = '';
                document.getElementById('records-end-date').value = '';
                document.getElementById('records-company-filter').value = '';
            }
        }
        function renderDriverCrudList() {
            const listContainer = document.getElementById('driver-crud-list');
            listContainer.innerHTML = '';
            
            const countEl = document.getElementById('driver-count');
            if (countEl) {
                countEl.textContent = `${state.drivers.length} motorista(s) cadastrado(s)`;
            }

            if (state.drivers.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum motorista cadastrado.</p>';
                return;
            }

            state.drivers.forEach(driver => {
                const card = document.createElement('div');
                card.className = 'card-gradient p-4 rounded-lg shadow-lg text-white';
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-xl">${driver.name}</h3>
                        <span class="text-xs font-semibold py-1 px-3 rounded-full ${driver.status === 'active' ? 'bg-green-500' : 'bg-gray-500'}">
                            ${driver.status === 'active' ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-300">
                        <p><i class="ph ph-phone"></i> ${driver.phone}</p>
                        <p><i class="ph ph-car"></i> ${driver.plate}</p>
                        <p><i class="ph ph-lightning"></i> ${driver.car_model || 'N/A'}</p>
                        <p><i class="ph ph-paint-brush"></i> ${driver.car_color || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="editDriver(${driver.id})" class="w-full py-2 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 bg-green-600 text-white hover:bg-green-700"> <!-- COR VERDE -->
                            <i class="ph ph-pencil-simple"></i> Editar
                        </button>
                        <button onclick="promptDeleteDriver(${driver.id})" class="w-full py-2 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 bg-red-600 text-white hover:bg-red-700">
                            <i class="ph ph-trash-simple"></i> Excluir
                        </button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }
        function renderUserCrudList() {
            const listContainer = document.getElementById('user-crud-list');
            listContainer.innerHTML = ''; 

            const userCountEl = document.getElementById('user-count-display');
            if (userCountEl) {
                userCountEl.textContent = state.users.length;
            }

            if (state.users.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum usuário cadastrado.</p>';
                return;
            }

            state.users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'card-gradient p-4 rounded-lg shadow-lg text-white';
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-xl">${user.name}</h3>
                        <span class="text-xs font-semibold py-1 px-3 rounded-full bg-purple-600">
                            ${user.matricula || 'N/A'}
                        </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-300">
                        <p><i class="ph ph-building"></i> ${user.company || 'N/A'}</p>
                        <p><i class="ph ph-phone"></i> ${user.phone}</p>
                        <p><i class="ph ph-map-pin"></i> ${user.address || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="editUser(${user.id})" class="w-full py-2 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 bg-green-600 text-white hover:bg-green-700"> <!-- COR VERDE -->
                            <i class="ph ph-pencil-simple"></i> Editar
                        </button>
                        <button onclick="deleteUser(${user.id})" class="w-full py-2 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 bg-red-600 text-white hover:bg-red-700">
                            <i class="ph ph-trash-simple"></i> Excluir
                        </button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }
        // <!-- Fim das funções de renderização -->

        const GEOAPIFY_API_KEY = '3bd73ecada1d478a8c9473ad4115be38';
        
        // --- CORREÇÃO: Mover a definição de loadAppIcon e uploadAppIcon para antes do DOMContentLoaded ---
        function loadAppIcon() {
            const iconContainer = document.getElementById('app-icon-container');
            if (!iconContainer) return; // Adiciona verificação
            iconContainer.innerHTML = ''; 
            if (state.appIcon) {
                const img = document.createElement('img');
                img.src = state.appIcon; img.className = 'h-12 w-12 object-contain';
                iconContainer.appendChild(img);
            } else {
                // Se não houver ícone customizado, mostra um ícone padrão (pode ajustar o SVG se quiser)
                const defaultIconContainer = document.getElementById('app-icon-container');
                if (defaultIconContainer.innerHTML === '') { // Evita adicionar múltiplas vezes
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('class', 'h-12 w-12 text-black'); // Ícone preto
                    svg.setAttribute('fill', 'currentColor');
                    svg.setAttribute('viewBox', '0 0 20 20');
                    svg.innerHTML = `<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />`; // Ícone de usuário simples
                    defaultIconContainer.appendChild(svg);
                }
            }
        }

        function uploadAppIcon() {
            const fileInput = document.getElementById('icon-file-input');
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                state.appIcon = event.target.result;
                localStorage.setItem('appIcon', state.appIcon);
                loadAppIcon(); 
                showModal('Ícone atualizado com sucesso!');
            };
            reader.readAsDataURL(file);
        }
        // --- FIM DA CORREÇÃO ---


        let driverWatchId = null; 
        let map;
        let heatmap;
        let tempDriverId = null;
        let driverChart = null;
        let countdownInterval = null;
        let countdownSeconds = 5;
        let clockInterval = null;

        let state = {
            rides: [],
            drivers: [],
            users: [],
            appIcon: localStorage.getItem('appIcon') || null,
            currentDriverId: null,
            currentUserRideId: null,
            currentUserId: null,
            userStatusInterval: null,
            currentUserOrigin: null, 
            currentUserDestination: null
        };

        const SUPABASE_URL = 'https://jowsbmuqbzxukbbxbeqv.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w';
        
        // Define supabaseClient globalmente, mas será inicializado depois
        let supabaseClient; 

        // --- INÍCIO DAS FUNÇÕES DE ÁUDIO CORRIGIDAS (Web Audio API) ---
        let adminRingInterval = null;
        let adminAudioUnlocked = false;
        let audioContext = null;

        // Inicializa o AudioContext
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("🎵 AudioContext inicializado");
            }
            return audioContext;
        }

        // Desbloqueia áudio com interação do usuário
        function unlockAdminAudio() {
            if (adminAudioUnlocked) return;
            
            try {
                const ctx = initAudioContext();
                // Resume o contexto se estiver suspenso
                if (ctx.state === 'suspended') {
                    ctx.resume().then(() => {
                        adminAudioUnlocked = true;
                        console.log("✅ Áudio do Admin desbloqueado com sucesso!");
                        document.body.removeEventListener('click', unlockAdminAudio);
                        document.body.removeEventListener('touchstart', unlockAdminAudio);
                    });
                } else {
                    adminAudioUnlocked = true;
                    console.log("✅ Áudio do Admin já estava desbloqueado!");
                    document.body.removeEventListener('click', unlockAdminAudio);
                    document.body.removeEventListener('touchstart', unlockAdminAudio);
                }
            } catch (error) {
                console.error("❌ Erro ao desbloquear áudio:", error);
            }
        }

        document.body.addEventListener('click', unlockAdminAudio);
        document.body.addEventListener('touchstart', unlockAdminAudio);

        // Toca som de notificação usando Web Audio API
        function playAdminRingSound() {
            if (!adminAudioUnlocked) {
                console.warn("⚠️ Áudio bloqueado. Clique na tela para desbloquear.");
                return;
            }

            try {
                const ctx = initAudioContext();
                
                // Cria oscilador para som de notificação
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // Configurações do som (toque de telefone)
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, ctx.currentTime); // Frequência inicial
                oscillator.frequency.setValueAtTime(1000, ctx.currentTime + 0.1); // Sobe tom
                
                // Envelope de volume
                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.1);
                
                // Toca por 0.5 segundos
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
                
                // Segunda nota (cria efeito de campainha)
                setTimeout(() => {
                    const osc2 = ctx.createOscillator();
                    const gain2 = ctx.createGain();
                    
                    osc2.connect(gain2);
                    gain2.connect(ctx.destination);
                    
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(800, ctx.currentTime);
                    osc2.frequency.setValueAtTime(1000, ctx.currentTime + 0.1);
                    
                    gain2.gain.setValueAtTime(0, ctx.currentTime);
                    gain2.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.01);
                    gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    
                    osc2.start(ctx.currentTime);
                    osc2.stop(ctx.currentTime + 0.5);
                }, 200);
                
                console.log("🔔 Som de notificação tocado!");
                
            } catch (error) {
                console.error("❌ Erro ao tocar som:", error);
            }
        }

        function startRingingAdmin() {
            console.log("🔔 Iniciando alerta sonoro...");
            stopRingingAdmin(); 
            playAdminRingSound(); 
            adminRingInterval = setInterval(playAdminRingSound, 3000); // Toca a cada 3 segundos

            const silenceBtnContainer = document.querySelector('#admin-requests-screen .lg\\:col-span-1');
            if (silenceBtnContainer && !document.getElementById('admin-silence-btn')) {
                const silenceBtn = document.createElement('button');
                silenceBtn.id = 'admin-silence-btn';
                silenceBtn.textContent = '🔕 Silenciar Alerta';
                silenceBtn.className = 'w-full mb-4 py-2 px-4 font-semibold rounded-lg bg-yellow-500 text-gray-900 hover:bg-yellow-600';
                silenceBtn.onclick = stopRingingAdmin;
                silenceBtnContainer.prepend(silenceBtn);
            }
            const btn = document.getElementById('admin-silence-btn');
            if (btn) btn.classList.remove('hidden');
        }

        function stopRingingAdmin() {
            console.log("🔕 Parando alerta sonoro...");
            if (adminRingInterval) {
                clearInterval(adminRingInterval);
                adminRingInterval = null;
            }
            const btn = document.getElementById('admin-silence-btn');
            if (btn) btn.classList.add('hidden');
        }
                // ========================================
        // NOTIFICAÇÕES MOBILE
        // ========================================
        
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return Notification.permission === 'granted';
        }

        function sendMobileNotification(ride) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('🚗 Nova Solicitação!', {
                    body: `${ride.userName || 'Cliente'}\nOrigem: ${ride.pickupAddress || 'N/A'}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/3097/3097134.png',
                    vibrate: [300, 100, 300],
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Vibrar celular
            if ('vibrate' in navigator) {
                navigator.vibrate([300, 100, 300]);
            }
        }

        // Solicitar permissão ao primeiro toque
        document.addEventListener('DOMContentLoaded', () => {
            const requestOnce = async () => {
                await requestNotificationPermission();
                document.removeEventListener('click', requestOnce);
                document.removeEventListener('touchstart', requestOnce);
            };
            document.addEventListener('click', requestOnce, { once: true });
            document.addEventListener('touchstart', requestOnce, { once: true });
        });

        // --- FIM DAS FUNÇÕES DE ÁUDIO CORRIGIDAS ---

        function showModal(message, onConfirm, showCancel = false, content = {}) {
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            const inputContainer = document.getElementById('modal-input-container');

            Array.from(inputContainer.children).forEach(child => {
                if (child.tagName === 'INPUT' || child.tagName === 'SELECT' || child.classList.contains('autocomplete-container')) {
                    child.style.display = 'none';
                    if (child.tagName !== 'DIV') child.value = '';
                }
            });

            const modalAddressInput = document.getElementById('modal-input-address');
            if (modalAddressInput) modalAddressInput.value = '';

            if (content.type) {
                inputContainer.classList.remove('hidden');
                if(content.type === 'edit-driver') {
                    document.getElementById('modal-input-name').style.display = 'block';
                    document.getElementById('modal-input-phone').style.display = 'block';
                    document.getElementById('modal-input-plate').style.display = 'block';
                    document.getElementById('modal-input-model').style.display = 'block';
                    document.getElementById('modal-input-color').style.display = 'block';
                    document.getElementById('modal-input-password').style.display = 'block'; 
                    document.getElementById('modal-input-status').style.display = 'block';
                    document.getElementById('modal-input-name').value = content.name;
                    document.getElementById('modal-input-phone').value = content.phone;
                    document.getElementById('modal-input-plate').value = content.plate;
                    document.getElementById('modal-input-model').value = content.car_model || '';
                    document.getElementById('modal-input-color').value = content.car_color || '';
                    document.getElementById('modal-input-status').value = content.status;
                } else if (content.type === 'edit-user') {
                    document.getElementById('modal-input-matricula').style.display = 'block';
                    document.getElementById('modal-input-name').style.display = 'block';
                    document.getElementById('modal-input-password').style.display = 'block'; 
                    document.getElementById('modal-input-company').style.display = 'block';
                    document.getElementById('modal-input-address').parentElement.style.display = 'block';
                    document.getElementById('modal-input-phone').style.display = 'block';
                    
                    document.getElementById('modal-input-matricula').value = content.matricula;
                    document.getElementById('modal-input-name').value = content.name;
                    document.getElementById('modal-input-company').value = content.company;
                    const modalAddressInput = document.getElementById('modal-input-address');
                    modalAddressInput.value = content.address;
                    if (content.address) {
                        modalAddressInput.setAttribute('data-address-valid', 'true');
                    }
                    document.getElementById('modal-input-phone').value = content.phone;

                } else if(content.type === 'driver-password') {
                    document.getElementById('modal-input-driver-password').style.display = 'block';
                } else if(content.type === 'delete-with-password') {
                    document.getElementById('modal-input-admin-password').style.display = 'block';
                }
            } else {
                 inputContainer.classList.add('hidden'); 
            }

            confirmBtn.onclick = onConfirm;
            cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
            confirmBtn.textContent = showCancel ? 'Confirmar' : 'OK';
            if (!showCancel) {
                confirmBtn.onclick = closeModal;
            }

            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex'); 
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            Array.from(document.getElementById('modal-input-container').children).forEach(child => {
                if (child.tagName === 'INPUT' || child.tagName === 'SELECT') {
                    child.value = '';
                    child.style.display = 'none'; 
                }
                if (child.classList.contains('autocomplete-container')) {
                    child.style.display = 'none';
                }
            });
        }

        function logout() {
            state.currentUserId = null;
            state.currentDriverId = null;
            localStorage.removeItem('sessionType');
            localStorage.removeItem('loggedInUserId');
            localStorage.removeItem('loggedInDriverId');
            showScreen('initial-screen');
        }

        async function loginAdmin() { 
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (password === '789512') { 
                errorEl.classList.add('hidden');
                document.getElementById('admin-password').value = ''; 
                localStorage.setItem('sessionType', 'admin');
                showScreen('admin-screen'); 
            } else {
                errorEl.classList.remove('hidden'); 
            }
        }

        async function loginUser() {
            const matricula = document.getElementById('user-id').value;
            const password = document.getElementById('user-password').value;
            const errorEl = document.getElementById('user-login-error');

            const { data: user, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('matricula', matricula)
                .eq('password', password)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('Erro no Supabase ao tentar login:', error);
                errorEl.textContent = 'Erro de comunicação com o servidor. Por favor, tente novamente.';
                errorEl.classList.remove('hidden');
                return; 
            }

            if (user) {
                state.currentUserId = user.id;
                localStorage.setItem('sessionType', 'user');
                localStorage.setItem('loggedInUserId', user.id);
                errorEl.classList.add('hidden');
                document.getElementById('user-id').value = ''; 
                document.getElementById('user-password').value = '';
                showScreen('user-screen'); 
            } else {
                errorEl.textContent = 'Matrícula ou senha incorreta!';
                errorEl.classList.remove('hidden');
            }
        }

        function startDigitalClock(elementId) {
            const clockElement = document.getElementById(elementId);
            if (!clockElement) return;

            if (clockInterval) clearInterval(clockInterval);

            clockInterval = setInterval(() => {
                const now = new Date();
                clockElement.textContent = now.toLocaleTimeString('pt-BR');
            }, 1000);
        }

        function promptToGoBack() {
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            cancelBtn.textContent = 'Apenas Voltar';
            cancelBtn.onclick = () => {
                closeModal();
                showScreen('admin-screen');
            };

            confirmBtn.textContent = 'Exportar e Voltar';
            confirmBtn.onclick = () => {
                if (state.rides.length === 0) {
                    showModal("Nenhuma corrida para exportar. Voltando ao painel...");
                    setTimeout(() => {
                        closeModal();
                        showScreen('admin-screen');
                    }, 2000);
                } else {
                    exportDailyReportNow();
                    closeModal();
                    showScreen('admin-screen');
                }
            };

            showModal('Deseja exportar o relatório diário antes de sair?', null, true);
        }

        // --- CORREÇÃO: Restaurar a função cleanAddressString ---
        function cleanAddressString(address) {
            if (typeof address !== 'string') return '';
            // Remove colchetes e aspas do início/fim, se presentes
            return address.replace(/^\["|"\]$/g, '').trim(); 
        }
        // --- FIM DA CORREÇÃO ---

        async function requestRide() {
            const originAddress = document.getElementById('origin').value;
            const destinationAddress = document.getElementById('destination').value;
            
            if (!state.currentUserOrigin || state.currentUserOrigin.properties.formatted !== originAddress) {
                showModal('Por favor, selecione um endereço de ORIGEM válido da lista de sugestões.');
                return;
            }
            if (!state.currentUserDestination || state.currentUserDestination.properties.formatted !== destinationAddress) {
                showModal('Por favor, selecione um endereço de DESTINO válido da lista de sugestões.');
                return;
            }

            const isScheduled = document.getElementById('schedule-toggle').checked;
            const scheduledTimeValue = document.getElementById('schedule-datetime').value;
            let scheduledTime = null;

            if (isScheduled) {
                if (!scheduledTimeValue) {
                    showModal('Por favor, selecione a data e hora para o agendamento.');
                    return;
                }
                scheduledTime = new Date(scheduledTimeValue).toISOString();
                if (new Date(scheduledTime) < new Date()) {
                    showModal('A data de agendamento não pode ser no passado.');
                    return;
                }
            }

            document.getElementById('user-request-form').classList.add('hidden');
            document.getElementById('user-status').classList.remove('hidden');
            document.getElementById('user-status-message').textContent = 'Solicitando corrida...';

            try {
                const originCoords = state.currentUserOrigin.properties;
                const userLocation = { lat: originCoords.lat, lon: originCoords.lon };
                const currentUser = state.users.find(u => u.id === state.currentUserId);

                const newRide = {
                    destination: destinationAddress,
                    origin_address: originAddress,
                    status: 'requested',
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userCompany: currentUser.company,
                    requestTime: new Date().toISOString(),
                    userLocation: userLocation,
                    request_type: isScheduled ? 'scheduled' : 'immediate', 
                    scheduled_datetime: scheduledTime 
                };

                const { data, error } = await supabaseClient.from('rides').insert([newRide]).select().single();

                if (error) {
                    console.error("Erro ao solicitar corrida:", error);
                    showModal("Não foi possível solicitar a corrida. Verifique os endereços.");
                    document.getElementById('user-request-form').classList.remove('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                    return;
                }

                state.currentUserRideId = data.id;
                document.getElementById('user-status-message').textContent = 'Aguardando um motorista aceitar...';
                startUserStatusCheck();
                
                state.currentUserOrigin = null;
                state.currentUserDestination = null;

            } catch (error) {
                console.error("Erro ao processar solicitação de corrida:", error);
                showModal('Não foi possível processar sua solicitação.');
                document.getElementById('user-request-form').classList.remove('hidden');
                document.getElementById('user-status').classList.add('hidden');
            }
        }

        function checkUserRideStatus() {
            if (state.currentUserRideId) {
                const myRide = state.rides.find(r => r.id === state.currentUserRideId);
                if (myRide) {
                    document.getElementById('user-request-form').classList.add('hidden');
                    document.getElementById('user-status').classList.remove('hidden');
                    updateUserStatusMessage(myRide); 
                    startUserStatusCheck(); 
                } else {
                    state.currentUserRideId = null; 
                    document.getElementById('user-request-form').classList.remove('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                    document.getElementById('user-status-message').textContent = 'Sua viagem foi finalizada ou cancelada.';
                }
            }
        }

        function startUserStatusCheck() {
            if (state.userStatusInterval) clearInterval(state.userStatusInterval);
            state.userStatusInterval = setInterval(async () => {
                if (!state.currentUserRideId) { 
                    clearInterval(state.userStatusInterval);
                    return;
                }
                const { data: myRide, error } = await supabaseClient.from('rides').select('*').eq('id', state.currentUserRideId).single();
                if (myRide) {
                    updateUserStatusMessage(myRide); 
                } else {
                    clearInterval(state.userStatusInterval);
                    state.currentUserRideId = null; 
                    document.getElementById('user-request-form').classList.remove('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                    document.getElementById('user-status-message').textContent = 'Sua viagem foi finalizada ou cancelada (pelo sistema).';
                }
            }, 5000);
        }

        async function updateUserStatusMessage(ride) {
            const searchingIconContainer = document.getElementById('status-icon-searching');
            const enRouteIconContainer = document.getElementById('status-icon-en-route');
            const arrivedPickupIconContainer = document.getElementById('status-icon-arrived-pickup');
            const inProgressIconContainer = document.getElementById('status-icon-in-progress');

            const cancelRideBtn = document.getElementById('cancel-ride-btn');
            let message = 'Aguardando um motorista...';

            searchingIconContainer.classList.add('hidden');
            enRouteIconContainer.classList.add('hidden');
            arrivedPickupIconContainer.classList.add('hidden');
            inProgressIconContainer.classList.add('hidden');
            enRouteIconContainer.innerHTML = ''; 
            arrivedPickupIconContainer.innerHTML = '';
            inProgressIconContainer.innerHTML = '';

            if (ride.status === 'requested' || ride.status === 'assigned' || ride.status === 'accepted' || ride.status === 'arrived_pickup') {
                cancelRideBtn.classList.remove('hidden');
            } else {
                cancelRideBtn.classList.add('hidden');
            }

            switch(ride.status) {
                case 'assigned':
                    message = `Motorista ${ride.driverName} foi designado. Aguardando aceite...`;
                    searchingIconContainer.classList.remove('hidden'); 
                    break;
                case 'accepted':
                    message = `Motorista ${ride.driverName} está a caminho!`;
                    
                    if (ride.driverCurrentLocation && ride.userLocation) {
                        const distance = await getDrivingDistanceByCoords(
                            ride.userLocation,
                            ride.driverCurrentLocation
                        );
                        
                        if (distance !== null) {
                            message += ` Distância: ${distance.toFixed(2)} km`;
                        } else {
                            message += ` (Calculando distância...)`;
                        }
                    }

                    const acceptedImg = document.createElement('img');
                    acceptedImg.src = 'images/aceitou.png'; 
                    acceptedImg.alt = 'Motorista Aceitou';
                    acceptedImg.className = 'h-20 w-20 mx-auto'; 
                    enRouteIconContainer.appendChild(acceptedImg);
                    enRouteIconContainer.classList.remove('hidden');
                    break;
                case 'arrived_pickup':
                    message = `Seu motorista, ${ride.driverName}, chegou no local de embarque.`;
                    const arrivedImg = document.createElement('img');
                    arrivedImg.src = 'images/final.png'; 
                    arrivedImg.alt = 'Motorista Chegou';
                    arrivedImg.className = 'h-20 w-20 mx-auto';
                    arrivedPickupIconContainer.appendChild(arrivedImg);
                    arrivedPickupIconContainer.classList.remove('hidden');
                    break;
                case 'in_progress':
                    message = `Viagem para ${formatDestination(ride.destination)} em andamento.`;
                    const inProgressImg = document.createElement('img');
                    inProgressImg.src = 'images/destino.png'; 
                    inProgressImg.alt = 'Viagem Iniciada';
                    inProgressImg.className = 'h-20 w-20 mx-auto animate-bounce'; 
                    inProgressIconContainer.appendChild(inProgressImg);
                    inProgressIconContainer.classList.remove('hidden');
                    cancelRideBtn.classList.add('hidden');
                    break;
                case 'completed':
                    message = `Viagem finalizada! Obrigado por escolher a GARCIA TAXI.`;
                    clearInterval(state.userStatusInterval); 
                    state.currentUserRideId = null; 
                    setTimeout(() => {
                        document.getElementById('user-request-form').classList.remove('hidden');
                        document.getElementById('user-status').classList.add('hidden');
                        document.getElementById('destination').value = ''; 
                        renderUserRideHistory();
                    }, 5000);
                    break;
                case 'canceled':
                    message = `Sua viagem foi cancelada.`;
                    clearInterval(state.userStatusInterval); 
                    state.currentUserRideId = null; 
                    setTimeout(() => {
                        document.getElementById('user-request-form').classList.remove('hidden');
                        document.getElementById('user-status').classList.add('hidden');
                        document.getElementById('destination').value = ''; 
                        renderUserRideHistory();
                    }, 3000); 
                    break;
            }
            document.getElementById('user-status-message').textContent = message;
        }

        async function cancelRide() {
            if (state.currentUserRideId) {
                if (driverWatchId) {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
                const { error } = await supabaseClient.from('rides').update({ status: 'canceled' }).eq('id', state.currentUserRideId);
                if (error) {
                    showModal('Não foi possível cancelar a corrida.');
                }
            }
        }

        async function loadAdminRequests() {
            const list = document.getElementById('admin-requests-list');
            list.innerHTML = '';

            const requestedRides = state.rides.filter(r => r.status === 'requested' || r.status === 'approved' || r.status === 'pending_approval' || r.status === 'scheduled');

         // Verificar se há solicitações do tipo 'immediate' ou 'scheduled' para tocar o som
         const newRequestsWithSound = requestedRides.filter(ride => 
             (ride.request_type === 'immediate' || ride.request_type === 'scheduled') && 
             !ride.driver_id // Ainda não tem motorista designado
         );

         // Tocar som de notificação se houver solicitações pendentes
         if (newRequestsWithSound.length > 0) {
    startRingingAdmin();
    // Notificar também no celular
    if (newRequestsWithSound[0]) {
        sendMobileNotification(newRequestsWithSound[0]);
    }
}


            requestedRides.sort((a, b) => new Date((a.request_type === 'scheduled' && a.scheduled_datetime) || a.requestTime) - new Date((b.request_type === 'scheduled' && b.scheduled_datetime) || b.requestTime));

            const solicitadoCount = state.rides.filter(r => ['requested', 'approved', 'pending_approval'].includes(r.status)).length;
            const agendadaCount = state.rides.filter(r => r.status === 'scheduled').length;
            const designadoCount = state.rides.filter(r => r.status === 'assigned').length;
            const emAndamentoCount = state.rides.filter(r => ['accepted', 'arrived_pickup', 'in_progress'].includes(r.status)).length;
            const concluidasCount = state.rides.filter(r => r.status === 'completed').length;

            document.getElementById('status-agendada-count').textContent = agendadaCount;
            document.getElementById('status-solicitado-count').textContent = solicitadoCount;
            document.getElementById('status-designado-count').textContent = designadoCount;
            document.getElementById('status-em-andamento-count').textContent = emAndamentoCount;
            document.getElementById('status-concluidas-count').textContent = concluidasCount;

            const activeDriversCount = state.drivers.filter(d => d.status === 'active').length;
            const totalDriversCount = state.drivers.length;

            document.getElementById('total-drivers-count').textContent = totalDriversCount;
            document.getElementById('active-drivers-count').textContent = activeDriversCount;
            document.getElementById('inactive-drivers-count').textContent = totalDriversCount - activeDriversCount;

            renderDriverStatusChart(activeDriversCount, totalDriversCount - activeDriversCount);

            if (requestedRides.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400">Nenhuma nova solicitação.</p>';
            } else {
                for (const ride of requestedRides) {
                    const card = document.createElement('div');
                    card.className = 'card-gradient p-4 rounded-lg shadow-md';

	                    const originAddress = cleanAddressString(ride.origin_address);
	                    
	                    // --- INÍCIO DA LÓGICA DE MÚLTIPLOS DESTINOS ---
	                    let destinationsHTML = '';
	                    const destinationString = ride.destination;
	                    
	                    if (typeof destinationString === 'string' && destinationString.startsWith('[{') && destinationString.endsWith('}]')) {
	                        try {
	                            const destinationsArray = JSON.parse(destinationString);
	                            if (Array.isArray(destinationsArray) && destinationsArray.length > 0) {
	                                const addresses = destinationsArray
	                                    .map(dest => dest.address || null) // Pega o endereço ou null
	                                    .filter(Boolean); // Filtra os nulos/vazios
	                                    
	                                    // Lógica ajustada: Se for um array de destinos, sempre exibe a lista.
	                                    destinationsHTML = `
	                                        <p class="font-semibold">Destinos:</p>
	                                        <ul class="list-disc list-inside pl-2 text-sm">
	                                            ${addresses.map(addr => `<li><span class="font-normal">${addr}</span></li>`).join('')}
	                                        </ul>
	                                    `;
	                            } else {
	                                // JSON array está vazio
	                                destinationsHTML = `<p class="font-semibold">Destino: <span class="font-normal">-</span></p>`;
	                            }
	                        } catch (e) {
	                            // Falha no parse do JSON, trata como string única
	                            destinationsHTML = `<p class="font-semibold">Destino: <span class="font-normal">${formatDestination(destinationString)}</span></p>`;
	                        }
	                    } else {
	                        // Não é um array JSON, trata como string única
	                        destinationsHTML = `<p class="font-semibold">Destino: <span class="font-normal">${formatDestination(destinationString)}</span></p>`;
	                    }
	                    // --- FIM DA LÓGICA DE MÚLTIPLOS DESTINOS ---
	
	                    const distanceInfo = ride.km ? `<p class="text-sm text-gray-400">Distância: ${ride.km} km</p>` : `<p class="text-sm text-gray-500">Distância será calculada ao finalizar</p>`;

	                    let rideTypeInfo = '';
                    if (ride.request_type === 'scheduled' && ride.scheduled_datetime) {
                        const scheduledDate = new Date(ride.scheduled_datetime);
                        const formattedTime = scheduledDate.toLocaleString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        rideTypeInfo = `<span class="text-xs font-bold py-1 px-2 rounded-full bg-orange-500 text-white">AGENDADA ${formattedTime}</span>`;
                    } else {
                        rideTypeInfo = '<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white">IMEDIATA</span>';
                    }

                    let actionContent = '';
                    if (ride.status === 'pending_approval') {
                        actionContent = `
                            <div class="mt-4 text-center p-2 rounded-lg bg-yellow-700 text-white font-semibold">
                                Aguardando Aprovação
                            </div>
                        `;
                    } else {
                        const activeDrivers = state.drivers.filter(d => d.status === 'active');
                        let driverOptions = activeDrivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                        if (activeDrivers.length === 0) {
                            driverOptions = `<option value="" disabled>Nenhum motorista ativo</option>`;
                        }
                        actionContent = `
                            <div class="mt-4 flex gap-2">
                                <select id="driver-select-${ride.id}" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white">
                                    <option value="" class="text-gray-400">Selecione um motorista</option>
                                    ${driverOptions}
                                </select>
                                <button onclick="assignDriver(${ride.id})" class="py-2 px-4 font-semibold rounded-lg button-gradient whitespace-nowrap text-white">Marcar</button>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
	                        <h4 class="font-semibold text-lg">Nova Solicitação</h4>
	                            ${rideTypeInfo}
	                        </div>
	                        <p class="font-semibold">Origem: <span class="font-normal">${originAddress || 'Não informado'}</span></p>
	                        ${destinationsHTML}
	                        <p class="font-semibold">Observação: <span class="font-normal text-yellow-300">${ride.observation || 'Nenhuma'}</span></p>
                        ${distanceInfo}
                        <p class="text-sm text-gray-400">De: ${ride.userName} ${ride.userCompany ? `(${ride.userCompany})` : ''}</p>
                        <p class="text-sm text-gray-300">Solicitado em: ${new Date(ride.requestTime).toLocaleTimeString()}</p>
                        ${actionContent}
                    `;

                    list.appendChild(card);
                };
            }
        }
        
        async function renderOngoingRidesTable() {
            const tableContainer = document.getElementById('admin-ongoing-rides-table');
            tableContainer.innerHTML = '<div class="loader mx-auto"></div>';

            const ongoingRides = state.rides.filter(r => !['requested', 'approved', 'pending_approval', 'rejected', 'completed', 'canceled'].includes(r.status));

            if (ongoingRides.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-400">Nenhuma corrida em andamento no momento.</p>';
                return;
            }

            const ridesWithDistance = ongoingRides.map((ride) => {
                const originAddress = cleanAddressString(ride.origin_address);
                const formattedDestination = formatDestination(ride.destination);
                const distanceKm = ride.km || 'Ao finalizar';
                return { ...ride, distanceKm: distanceKm, cleanedOrigin: originAddress, formattedDestination: formattedDestination };
            });

            let tableHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" class="px-4 py-3">Usuário</th>
                            <th scope="col" class="px-4 py-3">Origem</th>
                            <th scope="col" class="px-4 py-3">Destino</th>
                            <th scope="col" class="px-4 py-3">Observação</th>
                            <th scope="col" class="px-4 py-3">Distância (km)</th>
                            <th scope="col" class="px-4 py-3">Motorista</th>
                            <th scope="col" class="px-4 py-3">Status</th>
                            <th scope="col" class="px-4 py-3">Tipo</th>
                            <th scope="col" class="px-4 py-3">Data/Hora</th>
                            <th scope="col" class="px-4 py-3">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            ridesWithDistance.sort((a, b) => {
                const dateA = (a.request_type === 'scheduled' && a.scheduled_datetime) ? new Date(a.scheduled_datetime) : new Date(a.requestTime);
                const dateB = (b.request_type === 'scheduled' && b.scheduled_datetime) ? new Date(b.scheduled_datetime) : new Date(b.requestTime);
                return dateA - dateB;
            });

            ridesWithDistance.forEach(ride => {
                const statusInfo = translateStatus(ride.status); 

                let rideTypeInfo = '';
                if (ride.request_type === 'scheduled') {
                    rideTypeInfo = `<span class="text-xs font-bold py-1 px-2 rounded-full bg-orange-500 text-white">AGENDADA</span>`;
                } else {
                    rideTypeInfo = '<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white">IMEDIATA</span>';
                }

                let dateTimeString = '';
                const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                if (ride.request_type === 'scheduled' && ride.scheduled_datetime) {
                    dateTimeString = new Date(ride.scheduled_datetime).toLocaleString('pt-BR', options);
                } else { 
                    dateTimeString = new Date(ride.requestTime).toLocaleString('pt-BR', options);
                }

                let driverCellHTML = ride.driverName || 'N/A';
                let actionsCellHTML = `<div class="flex items-center gap-2">`;

                if (ride.status !== 'in_progress' && ride.status !== 'arrived_pickup') {
                    const activeDrivers = state.drivers.filter(d => d.status === 'active');
                    let driverOptions = activeDrivers.map(d => `<option value="${d.id}" ${ride.driverId == d.id ? 'selected' : ''}>${d.name}</option>`).join('');

                    driverCellHTML = `
                        <select id="ongoing-driver-select-${ride.id}" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-xs text-white">
                            <option value="" class="text-gray-400">Selecione...</option>
                            ${driverOptions}
                        </select>
                    `;

                    actionsCellHTML += `<button onclick="updateRideDriver(${ride.id})" class="py-1 px-2 text-xs font-semibold rounded-lg button-gradient whitespace-nowrap text-white">Salvar</button>`;
                }

                actionsCellHTML += `
                    <button onclick="adminCompleteRide(${ride.id})" title="Marcar como Finalizada" class="p-1 rounded-lg bg-green-600 hover:bg-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                    <button onclick="adminDeleteRide(${ride.id})" title="Excluir Corrida" class="p-1 rounded-lg bg-red-600 hover:bg-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>`;

                tableHTML += `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/20">
                        <td class="px-4 py-3 font-medium">${ride.userName}</td>
                        <td class="px-4 py-3">${ride.cleanedOrigin || '-'}</td> 
                        <td class="px-4 py-3">${ride.formattedDestination}</td> 
                        <td class="px-4 py-3 text-yellow-300">${ride.observation || '-'}</td>
                        <td class="px-4 py-3 font-semibold">${ride.distanceKm}</td>
                        <td class="px-4 py-3">${driverCellHTML}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge ${statusInfo.colorClass}">${statusInfo.text}</span>
                        </td>
                        <td class="px-4 py-3">${rideTypeInfo}</td>
                        <td class="px-4 py-3">${dateTimeString}</td> 
                        <td class="px-4 py-3">${actionsCellHTML}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        }

        async function updateRideDriver(rideId) {
            const selectElement = document.getElementById(`ongoing-driver-select-${rideId}`);
            if (!selectElement) return;

            const selectedDriverId = selectElement.value;

            if (!selectedDriverId) {
                showModal("Por favor, selecione um motorista para salvar.");
                return;
            }

            const driver = state.drivers.find(d => d.id == selectedDriverId);
            if (!driver) {
                showModal("Motorista selecionado não encontrado.");
                return;
            }

            const { error } = await supabaseClient
                .from('rides')
                .update({ 
                    status: 'assigned', 
                    driverId: parseInt(driver.id), 
                    driverName: driver.name 
                })
                .eq('id', rideId);

            if (error) {
                console.error("Erro ao atualizar motorista da corrida:", error);
                showModal("Não foi possível atualizar o motorista.");
            } else {
                showModal("Motorista atribuído com sucesso!");
            }
        }

        async function assignDriver(rideId) {
            const selectedDriverId = document.getElementById(`driver-select-${rideId}`).value;
            if (!selectedDriverId) {
                showModal('Por favor, selecione um motorista.');
                return;
            }
            const driver = state.drivers.find(d => d.id == selectedDriverId);
            const { error } = await supabaseClient.from('rides').update({ status: 'assigned', driverId: parseInt(driver.id), driverName: driver.name }).eq('id', rideId);
            if (error) { 
                console.error("Erro ao designar motorista:", error);
                showModal("Não foi possível designar o motorista.");
            }
        }

        async function addDriver() {
            const nameInput = document.getElementById('new-driver-name');
            const phoneInput = document.getElementById('new-driver-phone');
            const plateInput = document.getElementById('new-driver-plate');
            const modelInput = document.getElementById('new-driver-model');
            const colorInput = document.getElementById('new-driver-color');
            const passwordInput = document.getElementById('new-driver-password');

            const name = nameInput.value.trim(); 
            const phone = phoneInput.value.trim();
            const plate = plateInput.value.trim();
            const model = modelInput.value.trim();
            const color = colorInput.value.trim();
            const password = passwordInput.value.trim();

            if (!name || !phone || !plate || !password || !model || !color) { 
                showModal('Todos os campos são obrigatórios.'); 
                return; 
            }
            const { error } = await supabaseClient.from('drivers').insert([{ 
                name, phone, plate, password, status: 'inactive', car_model: model, car_color: color 
            }]);

            if (error) { 
                console.error('Error adding driver:', error); 
                showModal('Erro ao adicionar motorista.'); 
            } else { 
                nameInput.value = phoneInput.value = plateInput.value = passwordInput.value = modelInput.value = colorInput.value = ''; 
                showModal('Motorista adicionado com sucesso!'); 
            }
        }

        function editDriver(driverId) {
            const driver = state.drivers.find(d => d.id === driverId);
            if (!driver) return;
            const onConfirm = async () => {
                const newName = document.getElementById('modal-input-name').value.trim();
                const newPhone = document.getElementById('modal-input-phone').value.trim();
                const newPlate = document.getElementById('modal-input-plate').value.trim();
                const newModel = document.getElementById('modal-input-model').value.trim();
                const newColor = document.getElementById('modal-input-color').value.trim();
                const newPassword = document.getElementById('modal-input-password').value.trim();
                const newStatus = document.getElementById('modal-input-status').value;

                if (newName && newPhone && newPlate && newModel && newColor) {
                    const updateData = { 
                        name: newName, 
                        phone: newPhone, 
                        plate: newPlate, 
                        status: newStatus,
                        car_model: newModel,
                        car_color: newColor
                    };
                    if (newPassword) updateData.password = newPassword;
                    const { error } = await supabaseClient.from('drivers').update(updateData).eq('id', driverId);
                    if (error) { 
                        console.error('Error updating driver:', error); 
                        showModal('Erro ao atualizar motorista.'); 
                    } else { 
                        closeModal(); 
                    }
                } else { 
                    showModal('Nome, Telefone, Placa, Modelo e Cor são obrigatórios.'); 
                }
            };
            showModal('Editar dados do motorista:', onConfirm, true, { 
                type: 'edit-driver', 
                name: driver.name, 
                phone: driver.phone, 
                plate: driver.plate, 
                car_model: driver.car_model,
                car_color: driver.car_color,
                status: driver.status 
            });
        }

        function promptDeleteDriver(driverId) {
            const onConfirm = async () => {
                const password = document.getElementById('modal-input-admin-password').value;
                if (password === '789512') { deleteDriver(driverId); } 
                else { showModal('Senha incorreta!'); }
            };
            showModal('Digite a senha do admin para excluir:', onConfirm, true, { type: 'delete-with-password' });
        }

        async function deleteDriver(driverId) {
            const { error } = await supabaseClient.from('drivers').delete().eq('id', driverId);
            if (error) { console.error('Error deleting driver:', error); showModal('Erro ao excluir motorista.'); } 
            else { closeModal(); }
        }

        async function addUser() {
            const idInput = document.getElementById('new-user-id');
            const nameInput = document.getElementById('new-user-name');
            const passwordInput = document.getElementById('new-user-password');
            const companyInput = document.getElementById('new-user-company');
            const addressInput = document.getElementById('new-user-address');
            const phoneInput = document.getElementById('new-user-phone');
            
            const matricula = idInput.value.trim();
            const name = nameInput.value.trim();
            const password = passwordInput.value.trim();
            const company = companyInput.value.trim();
            const address = addressInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (!matricula || !name || !password || !phone) {
                showModal('Matrícula, Nome, Senha e Telefone são obrigatórios.');
                return;
            }
            
            if (address && !addressInput.getAttribute('data-address-valid')) {
                showModal('Por favor, selecione um endereço válido da lista de sugestões.');
                return;
            }
            
            const { error } = await supabaseClient.from('users').insert([{ matricula, name, password, company, address, phone }]);
            
            if (error) {
                console.error('Error adding user:', error);
                showModal('Erro ao adicionar usuário.');
            } else {
                idInput.value = nameInput.value = passwordInput.value = companyInput.value = addressInput.value = phoneInput.value = '';
                addressInput.removeAttribute('data-address-valid');
                showModal('Usuário adicionado com sucesso!');
            }
        }

        function editUser(userId) {
            const user = state.users.find(u => u.id === userId);
            if (!user) return;
            const onConfirm = async () => {
                const newMatricula = document.getElementById('modal-input-matricula').value.trim();
                const newName = document.getElementById('modal-input-name').value.trim();
                const newPassword = document.getElementById('modal-input-password').value.trim();
                const newCompany = document.getElementById('modal-input-company').value.trim();
                const addressInput = document.getElementById('modal-input-address');
                const newAddress = addressInput.value.trim();
                const newPhone = document.getElementById('modal-input-phone').value.trim();

                if (newName && newPhone) {
                    if (newAddress && !addressInput.getAttribute('data-address-valid')) {
                        showModal('Por favor, selecione um endereço válido da lista de sugestões.');
                        return;
                    }
                    
                    const updateData = { matricula: newMatricula, name: newName, company: newCompany, address: newAddress, phone: newPhone };
                    if (newPassword) updateData.password = newPassword;
                    const { error } = await supabaseClient.from('users').update(updateData).eq('id', userId);
                    if (error) { console.error('Error updating user:', error); showModal('Erro ao atualizar usuário.'); } 
                    else { closeModal(); }
                } else { showModal('Nome completo e telefone são obrigatórios.'); }
            };
            showModal('Editar dados do usuário:', onConfirm, true, { type: 'edit-user', matricula: user.matricula, name: user.name, company: user.company, address: user.address, phone: user.phone });
        }

        async function deleteUser(userId) {
            const onConfirm = async () => {
                const { error } = await supabaseClient.from('users').delete().eq('id', userId);
                if (error) { console.error('Error deleting user:', error); showModal('Erro ao excluir usuário.'); } 
                else { closeModal(); }
            };
            showModal('Tem certeza que deseja excluir este usuário?', onConfirm, true);
        }

        function exportUsersToExcel() {
            if (state.users.length === 0) {
                showModal("Nenhum usuário cadastrado para exportar.");
                return;
            }

            const dataToExport = state.users.map(user => ({
                'Matrícula': user.matricula,
                'Nome Completo': user.name,
                'Empresa': user.company || 'N/A',
                'Endereço': user.address || 'N/A',
                'Telefone': user.phone
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Lista de Usuários");

            worksheet['!cols'] = [
                { wch: 15 },
                { wch: 35 },
                { wch: 20 },
                { wch: 40 },
                { wch: 20 }
            ];

            XLSX.writeFile(workbook, "relatorio_usuarios.xlsx");
        }

        function populateDriverSelection() {
            const list = document.getElementById('driver-list-selection');
            const timestampEl = document.getElementById('driver-selection-timestamp');
            list.innerHTML = '';
            const timestamp = new Date().toLocaleString('pt-BR');
            timestampEl.textContent = `Status atualizado em ${timestamp}`;

            state.drivers.forEach(driver => {
                const isDriverBusy = state.rides.some(ride => 
                    ride.driverId === driver.id && 
                    ride.status !== 'completed' && 
                    ride.status !== 'canceled'
                );
                const button = document.createElement('button');
                button.className = 'w-full py-3 px-6 text-lg font-semibold rounded-lg card-gradient shadow-lg transform hover:scale-105 transition-transform flex justify-between items-center';
                button.onclick = () => selectDriver(driver.id);
                button.innerHTML = `
                    <span class="text-white">${driver.name}</span>
                    <span class="text-sm font-bold py-1 px-3 rounded-full ${driver.status === 'active' && !isDriverBusy ? 'bg-green-500 text-white' : 'bg-red-600 text-white'}">
                        ${driver.status === 'active' && !isDriverBusy ? 'Livre' : 'Ocupado'}
                    </span>
                `;
                list.appendChild(button);
            });
        }

        function selectDriver(driverId) {
            tempDriverId = driverId;
            const driver = state.drivers.find(d => d.id === driverId);
            if (!driver) return;
            const onConfirm = () => {
                const passwordInput = document.getElementById('modal-input-driver-password');
                if (passwordInput.value === driver.password) { 
                    state.currentDriverId = driverId;
                    localStorage.setItem('sessionType', 'driver');
                    localStorage.setItem('loggedInDriverId', driverId);
                    document.getElementById('driver-name-display').textContent = `Bem-vindo, ${driver.name}`;
                    updateDriverStatusButton();
                    showScreen('driver-screen');
                    closeModal();
                } else {
                    document.getElementById('modal-message').textContent = "Senha Incorreta!";
                }
            };
            showModal(`Login para ${driver.name}`, onConfirm, true, { type: 'driver-password' });
        }

        function loadDriverJobs() {
            if (!state.currentDriverId) return;
            const list = document.getElementById('driver-jobs-list');
            list.innerHTML = '';
            const myJobs = state.rides.filter(r => r.driverId === state.currentDriverId && r.status !== 'completed' && r.status !== 'canceled');
            const statsDisplay = document.getElementById('driver-stats-display');
            const jobCount = myJobs.length;
            const timestamp = new Date().toLocaleString('pt-BR');
            statsDisplay.textContent = `${jobCount} solicitações carregadas em ${timestamp}`;

            if (myJobs.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400">Nenhuma corrida para você no momento.</p>';
                stopRingingAdmin();
                if (driverWatchId) {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
                return;
            }

            let hasAssignedJob = false;
            myJobs.forEach(ride => {
                const card = document.createElement('div');
                card.className = 'card-gradient p-4 rounded-lg shadow-md';
                const requestDateTime = new Date(ride.requestTime).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                let content = `
                    <div class="flex justify-between items-start mb-1">
                        <p class="font-semibold pr-2">Destino Final: <span class="font-normal">${formatDestination(ride.destination)}</span></p>
                        <p class="text-sm text-gray-300">Solicitado por: ${ride.userName} ${ride.userCompany ? `(${ride.userCompany})` : ''}</p>
                        <p class="text-xs text-gray-400 whitespace-nowrap">${requestDateTime}</p>
                    </div>
                    <p class="text-sm text-gray-300 mb-4">Status: <span class="font-semibold text-yellow-300">${translateStatus(ride.status).text}</span></p>
                `;
                if (ride.status === 'assigned') {
                    hasAssignedJob = true;
                    content += `<button onclick="acceptRide(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">ACEITAR CORRIDA</button>`;
                } else if (ride.status === 'accepted') {
                    content += `<button onclick="arriveAtPickup(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">CHEGUEI NO LOCAL DE EMBARQUE</button>`;
                } else if (ride.status === 'arrived_pickup') {
                    content += `<button onclick="startTrip(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">INICIAR VIAGEM PARA O DESTINO</button>`;
                } else if (ride.status === 'in_progress') {
                    content += `<button onclick="completeRide(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">FINALIZAR CORRIDA</button>`;
                }
                card.innerHTML = content;
                list.appendChild(card);
            });
            if (hasAssignedJob) startRingingAdmin(); else stopRingingAdmin();
        }

        async function acceptRide(rideId) {
            stopRingingAdmin();
            startDriverTracking(rideId); 

            const { error } = await supabaseClient.from('rides').update({ status: 'accepted', acceptTime: new Date().toISOString() }).eq('id', rideId);
            if (error) { 
                console.error("Erro ao aceitar corrida:", error);
                showModal("Não foi possível aceitar a corrida.");
            } else { 
                const ride = state.rides.find(r => r.id === rideId);
                
                if (ride && ride.userLocation && ride.userLocation.lat && ride.userLocation.lon) {
                    const { lat, lon } = ride.userLocation;
                    window.open(`waze://?ll=${lat},${lon}&navigate=yes`, '_blank');
                } else if (ride && ride.origin_address) {
                    window.open(`waze://?q=${encodeURIComponent(ride.origin_address)}&navigate=yes`, '_blank');
                } else {
                    showModal("Não foi possível obter a localização do usuário ou endereço de origem para navegação.");
                }
            }
        }

        async function arriveAtPickup(rideId) {
            const { error } = await supabaseClient.from('rides').update({ status: 'arrived_pickup' }).eq('id', rideId);
            if (error) {
                console.error("Erro ao atualizar status para 'chegou no local':", error);
                showModal("Não foi possível marcar como 'chegou no local'.");
            }
        }

        async function startTrip(rideId) {
            const ride = state.rides.find(r => r.id === rideId);
            if (ride) {
                const { error } = await supabaseClient.from('rides').update({ status: 'in_progress' }).eq('id', rideId);
                if (error) { 
                    console.error("Erro ao iniciar viagem:", error);
                    showModal("Não foi possível iniciar a viagem.");
                } else { 
                    const destinationAddress = formatDestination(ride.destination);
                    window.open(`waze://?q=${encodeURIComponent(destinationAddress)}&navigate=yes`, '_blank'); 
                }
            }
        }

        async function completeRide(rideId) {
            const ride = state.rides.find(r => r.id === rideId);
            let finalDistance = null;

            if (ride && ride.origin_address && ride.destination) {
                try {
                    const distance = await getDrivingDistance(ride.origin_address, formatDestination(ride.destination));
                    if (distance !== null) {
                        finalDistance = distance.toFixed(2);
                    }
                } catch (e) {
                    console.error("Erro ao calcular distância final:", e);
                }
            }

            const { error } = await supabaseClient
                .from('rides')
                .update({ 
                    status: 'completed', 
                    km: finalDistance
                })
                .eq('id', rideId);
            
            if (error) { 
                console.error("Erro ao completar corrida:", error); 
                showModal("Não foi possível finalizar a corrida.");
            } else {
                if (driverWatchId) {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
            }
        }

        function startDriverTracking(rideId) {
            if (driverWatchId) {
                navigator.geolocation.clearWatch(driverWatchId);
            }

            driverWatchId = navigator.geolocation.watchPosition(async (position) => {
                const driverLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                const currentRide = state.rides.find(r => r.id === rideId && r.status !== 'completed' && r.status !== 'canceled');
                if (currentRide) {
                    await supabaseClient.from('rides').update({ driverCurrentLocation: driverLocation }).eq('id', rideId);
                } else {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
            }, (error) => { 
                console.error("Erro ao rastrear localização do motorista:", error); 
            }, { 
                enableHighAccuracy: true, 
                timeout: 5000, 
                maximumAge: 0 
            });
        }

        async function fetchAllData() {
            const { data: drivers, error: driversError } = await supabaseClient.from('drivers').select('*');
            if (driversError) console.error('Error fetching drivers:', driversError); else state.drivers = drivers;
            const { data: users, error: usersError } = await supabaseClient.from('users').select('*');
            if (usersError) console.error('Error fetching users:', usersError); else state.users = users;
            const { data: rides, error: ridesError } = await supabaseClient.from('rides').select('*');
            if (ridesError) console.error('Error fetching rides:', ridesError); else state.rides = rides;
        }

	        async function sendNewRideEmailNotification(ride) {
	            console.log('Tentando enviar e-mail para a nova corrida:', ride);
	            
	            // 1. Usa a chave API fornecida pelo usuário e inicializa o cliente Resend
	            const RESEND_API_KEY = 're_Zz22Tx4D_E9SBeJHkQ94R8V18uk7nWidg';
	            const resend = new Resend(RESEND_API_KEY);
	
	            // 2. Obtém o e-mail de destino configurado (ou o padrão)
	            const destinationEmail = getNotificationEmail();
	
	            try {
	                const subject = `Nova Solicitação de Corrida: ${ride.userName}`;
	                const htmlBody = `
	                    <p>Uma nova solicitação de corrida foi registrada no sistema:</p>
	                    <ul>
	                        <li><strong>Usuário:</strong> ${ride.userName} (${ride.userCompany || 'N/A'})</li>
	                        <li><strong>Origem:</strong> ${ride.origin_address}</li>
	                        <li><strong>Destino:</strong> ${formatDestination(ride.destination)}</li>
	                        <li><strong>Tipo:</strong> ${ride.request_type === 'scheduled' ? 'Agendada' : 'Imediata'}</li>
	                        ${ride.scheduled_datetime ? `<li><strong>Data/Hora Agendada:</strong> ${new Date(ride.scheduled_datetime).toLocaleString('pt-BR')}</li>` : ''}
	                        <li><strong>Observação:</strong> ${ride.observation || 'Nenhuma'}</li>
	                    </ul>
	                    <p>Acesse o painel administrativo para designar um motorista.</p>
	                `;
	                
	                const { data, error } = await resend.emails.send({
	                    from: 'Sistema de Notificação <onboarding@resend.dev>', // Use um e-mail verificado no Resend
	                    to: destinationEmail,
	                    subject: subject,
	                    html: htmlBody,
	                });
	
	                if (error) {
	                    console.error('Erro ao enviar e-mail pelo Resend:', error);
	                } else {
	                    console.log('E-mail de notificação enviado com sucesso:', data);
	                }
	
	            } catch (error) {
	                console.error('Erro ao tentar enviar e-mail:', error);
	            }
	        }

        function setupRealtimeSubscriptions() {
            supabaseClient.channel('public:drivers').on('postgres_changes', { event: '*', schema: 'public', table: 'drivers' }, payload => {
                fetchAllData().then(() => { 
                    const activeScreen = document.querySelector('.screen.active')?.id;
                    if (activeScreen === 'admin-driver-crud-screen') renderDriverCrudList();
                    else if (activeScreen === 'driver-selection-screen') populateDriverSelection();
                    if (activeScreen === 'user-screen') updateAvailableDriversCount();
                });
            }).subscribe();

            supabaseClient.channel('public:users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload => {
                fetchAllData().then(() => {
                    if (document.querySelector('.screen.active')?.id === 'admin-user-crud-screen') renderUserCrudList();
                });
            }).subscribe();

            supabaseClient.channel('public:rides').on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, payload => {

                if (localStorage.getItem('sessionType') === 'admin') {
                    if (payload.eventType === 'INSERT' && (payload.new.status === 'requested' || payload.new.status === 'scheduled')) {
                        startRingingAdmin();
                        sendNewRideEmailNotification(payload.new);
                    }
                    else if (payload.eventType === 'UPDATE' && payload.new.status === 'approved' && payload.old.status !== 'approved') {
                        startRingingAdmin();
                    }
                }

                fetchAllData().then(() => {
                    const activeScreenId = document.querySelector('.screen.active')?.id;
                    if (activeScreenId === 'admin-requests-screen') {
                        loadAdminRequests();
                        renderOngoingRidesTable();
                    }
                    else if (activeScreenId === 'driver-screen') loadDriverJobs();
                    else if (activeScreenId === 'user-screen') {
                        checkUserRideStatus(); 
                        updateAvailableDriversCount(); 
                        renderUserRideHistory(); 
                    }
                    else if (activeScreenId === 'driver-selection-screen') {
                        populateDriverSelection(); 
                    }
                    // Adicionado para atualizar a tela de registros se ela estiver ativa
                    else if (activeScreenId === 'admin-records-screen') {
                        loadAllRecords();
                    }
                });
            }).subscribe();
        }

        function updateDriverStatusButton() {
            const driver = state.drivers.find(d => d.id === state.currentDriverId);
            if (!driver) return;
            const toggle = document.getElementById('driver-status-toggle');
            const label = document.getElementById('driver-status-label');
            if (driver.status === 'active') {
                toggle.checked = true; 
                label.textContent = 'ATIVO'; 
                label.className = 'font-bold text-green-400';
            } else {
                toggle.checked = false; 
                label.textContent = 'INATIVO'; 
                label.className = 'font-bold text-red-400';
            }
        }

        async function toggleDriverStatus() {
            const driver = state.drivers.find(d => d.id === state.currentDriverId);
            if (driver) {
                const newStatus = driver.status === 'active' ? 'inactive' : 'active';
                const { error } = await supabaseClient.from('drivers').update({ status: newStatus }).eq('id', driver.id);
                if (error) console.error("Error updating driver status:", error);
            }
        }

        async function toggleDriverStatusAdmin(driverId) {
            const driver = state.drivers.find(d => d.id === driverId);
            if (driver) {
                const newStatus = driver.status === 'active' ? 'inactive' : 'active';
                const { error } = await supabaseClient.from('drivers').update({ status: newStatus }).eq('id', driver.id);
                if (error) console.error("Error updating driver status:", error);
            }
        }

        function updateAvailableDriversCount() {
            const availableDrivers = state.drivers.filter(driver => {
                const hasActiveRide = state.rides.some(ride => 
                    ride.driverId === driver.id && 
                    ride.status !== 'completed' && 
                    ride.status !== 'canceled'
                );
                return driver.status === 'active' && !hasActiveRide;
            });
            const countEl = document.getElementById('available-drivers-count');
            if (countEl) { 
                countEl.className = 'text-center mb-4 text-lg text-green-400 font-semibold';
                countEl.textContent = `Motoristas disponíveis agora: ${availableDrivers.length}`;
            }
        }

        const customDataLabels = {
            id: 'customDataLabels',
            afterDraw(chart, args, options) {
                const { ctx, data } = chart;
                const total = data.datasets[0].data.reduce((acc, current) => acc + current, 0);

                if (total === 0) return;

                const centerX = chart.getDatasetMeta(0).data[0].x;
                const centerY = chart.getDatasetMeta(0).data[0].y;

                ctx.save();
                ctx.font = 'bold 40px Poppins';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(total, centerX, centerY);
                ctx.restore();
            }
        };

        function renderDriverStatusChart(active, inactive) {
            const chartElement = document.getElementById('driver-status-chart');
             if (!chartElement) return; // Add check
             const ctx = chartElement.getContext('2d');
            if (driverChart) driverChart.destroy();
            driverChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ativos', 'Inativos'],
                    datasets: [{
                        data: [active, inactive],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderColor: '#374151',
                        borderWidth: 5,
                        hoverBorderWidth: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [customDataLabels]
            });
        }

        function translateStatus(status) {
            if (!status) {
                return { text: 'INDEFINIDO', colorClass: 'status-canceled' };
            }
            switch (status) {
                case 'pending_approval': return { text: 'PEND. APROVAÇÃO', colorClass: 'status-pending_approval' };
                case 'approved': return { text: 'APROVADA', colorClass: 'status-approved' };
                case 'rejected': return { text: 'REJEITADA', colorClass: 'status-rejected' };
                case 'requested': return { text: 'SOLICITADO', colorClass: 'status-requested' };
                case 'assigned': return { text: 'DESIGNADO', colorClass: 'status-assigned' };
                case 'accepted': return { text: 'ACEITO', colorClass: 'status-accepted' };
                case 'arrived_pickup': return { text: 'NO EMBARQUE', colorClass: 'status-arrived_pickup' };
                case 'in_progress': return { text: 'EM ANDAMENTO', colorClass: 'status-in_progress' };
                case 'completed': return { text: 'FINALIZADA', colorClass: 'status-completed' };
                case 'canceled': return { text: 'CANCELADA', colorClass: 'status-canceled' };
                default: return { text: status.toUpperCase(), colorClass: '' }; 
            }
        }

        function exportDailyReportNow() {
            if (state.rides.length === 0) {
                showModal("Nenhuma corrida encontrada para exportar.");
                return;
            }

            const dataToExport = state.rides.map(ride => ({
                'ID da Corrida': ride.id,
                'Usuário': ride.userName,
                'Empresa': ride.userCompany,
                'Destino': formatDestination(ride.destination),
                'Motorista': ride.driverName || 'N/A',
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Data do Aceite': ride.acceptTime ? new Date(ride.acceptTime).toLocaleString('pt-BR') : 'N/A',
                'Status': translateStatus(ride.status).text
            }));

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Relatorio de Corridas");
            XLSX.writeFile(workbook, `Relatorio_Diario_${dateStr}.xlsx`);
        }
        
        function renderUserRideHistory() {
            const historyContainer = document.getElementById('user-ride-history');
            historyContainer.innerHTML = '';
            const userRides = state.rides.filter(r => r.userId === state.currentUserId);
            if (userRides.length === 0) {
                historyContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum histórico de corrida.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `
                <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                    <tr>
                        <th scope="col" class="px-4 py-3">Data</th>
                        <th scope="col" class="px-4 py-3">Destino</th>
                        <th scope="col" class="px-4 py-3">Status</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            userRides.sort((a, b) => new Date(b.requestTime) - new Date(a.requestTime));
            userRides.forEach(ride => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${new Date(ride.requestTime).toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3">${formatDestination(ride.destination)}</td>
                    <td class="px-4 py-3">${translateStatus(ride.status).text}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            historyContainer.appendChild(table);
        }

        function renderDriverRideHistory() {
            const historyContainer = document.getElementById('driver-ride-history');
            historyContainer.innerHTML = '';
            const driverRides = state.rides.filter(r => r.driverId === state.currentDriverId && r.status === 'completed');
            if (driverRides.length === 0) {
                historyContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum histórico de corrida.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `
                <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                    <tr>
                        <th scope="col" class="px-4 py-3">Data</th>
                        <th scope="col" class="px-4 py-3">Usuário</th>
                        <th scope="col" class="px-4 py-3">Destino</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            driverRides.sort((a, b) => new Date(b.requestTime) - new Date(a.requestTime));
            driverRides.forEach(ride => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${new Date(ride.requestTime).toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3">${ride.userName}</td>
                    <td class="px-4 py-3">${formatDestination(ride.destination)}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            historyContainer.appendChild(table);
        }

        function exportUserRidesToExcel() {
            const userRides = state.rides.filter(r => r.userId === state.currentUserId);
            if (userRides.length === 0) { showModal("Nenhum histórico de corrida para exportar."); return; }

            const dataToExport = userRides.map(ride => ({
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Destino': formatDestination(ride.destination),
                'Motorista': ride.driverName || 'N/A',
                'Status': translateStatus(ride.status).text
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Minhas Corridas");
            XLSX.writeFile(workbook, "meu_historico_corridas.xlsx");
        }

        function exportDriverRidesToExcel() {
            const driverRides = state.rides.filter(r => r.driverId === state.currentDriverId && r.status === 'completed');
            if (driverRides.length === 0) { showModal("Nenhum histórico de corrida para exportar."); return; }

            const dataToExport = driverRides.map(ride => ({
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Usuário': ride.userName,
                'Empresa': ride.userCompany,
                'Destino': formatDestination(ride.destination),
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Minhas Corridas Concluídas");
            XLSX.writeFile(workbook, "meu_historico_corridas_concluidas.xlsx");
        }

        function openRecordsTab() {
            showScreen('admin-records-screen');
        }

        async function loadAllRecords() {
            const tableBody = document.getElementById('all-records-body');
            tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>'; // Colspan atualizado para 11

            const { data, error } = await supabaseClient.from('rides').select('*').order('requestTime', { ascending: false });
            if (error) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-red-500">Erro ao carregar registros.</td></tr>'; // Colspan atualizado
                return;
            }
            state.rides = data;

            const companySelect = document.getElementById('records-company-filter');
            if (companySelect) {
                companySelect.innerHTML = '<option value="" class="text-gray-400">Todas as Empresas</option>'; 
                const companies = [...new Set(data.map(ride => ride.userCompany || '-').filter(Boolean))];
                companies.sort().forEach(company => {
                    if (company && company !== '-') { // Evita adicionar '-' como opção
                        companySelect.innerHTML += `<option value="${company}" class="text-white">${company}</option>`;
                    }
                });
            }
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-400">Nenhum registro encontrado.</td></tr>'; // Colspan atualizado
                return;
            }
            
            // Função auxiliar para formatar datas
            const formatRideDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    return new Date(dateString).toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                } catch (e) {
                    return 'Data Inválida';
                }
            };

            const rowsHTML = data.map((ride) => {
                let distanceKm = ride.km || 'N/A';
                const originAddress = cleanAddressString(ride.origin_address) || '-'; 
                const destinationAddress = formatDestination(ride.destination);
                const statusInfo = translateStatus(ride.status);
                const requestDateTime = formatRideDate(ride.requestTime);
                const scheduledDateTime = formatRideDate(ride.scheduled_datetime); // Formata data agendada
                const acceptDateTime = formatRideDate(ride.acceptTime);        // Formata data aceite
                const observation = ride.observation || '-';
                const requestTimestamp = ride.requestTime ? new Date(ride.requestTime).getTime() : 0; 

                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/20" data-request-time="${requestTimestamp}">
                        <td class="px-4 py-3">${requestDateTime}</td> 
                        <td class="px-4 py-3">${scheduledDateTime}</td> <!-- NOVO -->
                        <td class="px-4 py-3">${acceptDateTime}</td>   <!-- NOVO -->
                        <td class="px-4 py-3">${ride.userName}</td>
                        <td class="px-4 py-3">${ride.userCompany || '-'}</td>
                        <td class="px-4 py-3">${originAddress}</td>
                        <td class="px-4 py-3">${destinationAddress}</td> 
                        <td class="px-4 py-3">${observation}</td>
                        <td class="px-4 py-3">${ride.driverName || '-'}</td>
                        <td class="px-4 py-3"><span class="status-badge ${statusInfo.colorClass}">${statusInfo.text}</span></td>
                        <td class="px-4 py-3">${distanceKm}</td> 
                    </tr>
                `;
            });

            tableBody.innerHTML = rowsHTML.join('');
        }

        function filterRecords() {
            const startDate = document.getElementById('records-start-date').value;
            const endDate = document.getElementById('records-end-date').value;
            const selectedCompany = document.getElementById('records-company-filter').value;
            const tableBody = document.getElementById('all-records-body');
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            const start = startDate ? new Date(startDate).getTime() : null;
            const end = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : null;

            rows.forEach(row => {
                const requestTimestamp = row.dataset.requestTime;
                const companyCell = row.cells[4]; // Índice da coluna Empresa atualizado para 4
                
                if (requestTimestamp && companyCell) {
                    const recordDate = parseInt(requestTimestamp);
                    let dateMatch = true;
                    if (start && recordDate < start) dateMatch = false;
                    if (end && recordDate > end) dateMatch = false;

                    const rowCompany = companyCell.textContent.trim();
                    let companyMatch = (selectedCompany === "" || rowCompany === selectedCompany || (selectedCompany === '-' && rowCompany === '-')); // Inclui '-' se selecionado

                    row.style.display = (dateMatch && companyMatch) ? '' : 'none';
                } else {
                     row.style.display = 'none'; // Esconde linhas sem data ou empresa (ex: linha de loading)
                }
            });
        }

        function exportRecordsToExcel() {
            const table = document.getElementById('all-records-table');
            const rows = table.querySelectorAll('tbody tr');
            const dataToExport = [];

            // Pega os cabeçalhos da tabela HTML
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            dataToExport.push(headers); 

            let visibleRows = 0;
            rows.forEach(row => {
                if (row.style.display !== 'none') { // Exporta apenas linhas visíveis
                    const cells = Array.from(row.querySelectorAll('td')).map(td => {
                        // Trata a célula de status para pegar só o texto
                        if (td.querySelector('.status-badge')) {
                            return td.querySelector('.status-badge').textContent.trim();
                        }
                        return td.textContent.trim();
                    });
                    dataToExport.push(cells);
                    visibleRows++;
                }
            });

            if (visibleRows === 0) {
                showModal("Nenhum registro (visível) encontrado para exportar. Verifique seus filtros.");
                return;
            }

            const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Registros");

            // Ajusta a largura das colunas (adiciona larguras para as novas colunas)
            worksheet['!cols'] = [
                { wch: 20 }, // Data Solicitação
                { wch: 20 }, // Data Agendada (NOVO)
                { wch: 20 }, // Data Aceite (NOVO)
                { wch: 25 }, // Usuário
                { wch: 20 }, // Empresa
                { wch: 40 }, // Origem
                { wch: 40 }, // Destino
                { wch: 30 }, // Observação
                { wch: 25 }, // Motorista
                { wch: 15 }, // Status
                { wch: 15 }  // Distância (km)
            ];

            XLSX.writeFile(workbook, "relatorio_de_registros.xlsx");
        }

        function clearRecordsFilter() {
            document.getElementById('records-start-date').value = '';
            document.getElementById('records-end-date').value = '';
            document.getElementById('records-company-filter').value = '';

            const tableBody = document.getElementById('all-records-body');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            rows.forEach(row => {
                row.style.display = ''; // Mostra todas as linhas
            });
        }

        async function adminCompleteRide(rideId) {
            if (!confirm('Tem certeza que deseja finalizar esta corrida?')) return;
            
            const ride = state.rides.find(r => r.id === rideId);
            let finalDistance = null;

            if (ride && ride.origin_address && ride.destination) {
                try {
                    const distance = await getDrivingDistance(ride.origin_address, formatDestination(ride.destination));
                    if (distance !== null) {
                        finalDistance = distance.toFixed(2);
                    }
                } catch (e) {
                    console.error("Erro ao calcular distância final (admin):", e);
                }
            }

            const { error } = await supabaseClient
                .from('rides')
                .update({ 
                    status: 'completed', 
                    km: finalDistance
                })
                .eq('id', rideId);

            if (error) alert('Não foi possível finalizar a corrida.');
            else alert('Corrida finalizada com sucesso!');
        }

        async function adminDeleteRide(rideId) {
            if (!confirm('ATENÇÃO: Ação irreversível. Deseja realmente excluir esta corrida?')) return;
            const { error } = await supabaseClient.from('rides').delete().eq('id', rideId);
            if (error) alert('Não foi possível excluir a corrida.');
            else alert('Corrida excluída com sucesso!');
        }
        
        async function initApp() {
            // Garante que o supabaseClient está inicializado antes de prosseguir
            if (!supabaseClient) {
                 console.error("Supabase client not initialized yet in initApp!");
                 return; 
            }
            await fetchAllData(); 
            setupRealtimeSubscriptions(); 
            loadAppIcon();

            const sessionType = localStorage.getItem('sessionType');
            if (sessionType === 'admin') {
                showScreen('admin-screen');
            } else if (sessionType === 'user') {
                const userId = localStorage.getItem('loggedInUserId');
                if (userId && state.users.some(u => u.id == userId)) {
                    state.currentUserId = parseInt(userId);
                    showScreen('user-screen');
                } else {
                    logout();
                }
            } else if (sessionType === 'driver') {
                const driverId = localStorage.getItem('loggedInDriverId');
                if (driverId && state.drivers.some(d => d.id == driverId)) {
                    state.currentDriverId = parseInt(driverId);
                    const driver = state.drivers.find(d => d.id === state.currentDriverId);
                    if(driver) { // Adiciona verificação se driver existe
                         document.getElementById('driver-name-display').textContent = `Bem-vindo, ${driver.name}`;
                         updateDriverStatusButton();
                         showScreen('driver-screen');
                    } else {
                         logout(); // Driver não encontrado, deslogar
                    }
                } else {
                    logout();
                }
            } else {
                showScreen('initial-screen');
            }
        }
        // --- FIM DAS FUNÇÕES RESTAURADAS ---

        // Incluindo a função geocodeAddress modificada
        async function geocodeAddress(address) {
            if (!address || typeof address !== 'string' || address.trim().length < 3) {
                console.warn(`Tentativa de geocodificar endereço inválido ou vazio: '${address}'`);
                return null; 
            }
            
            const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(address)}&filter=countrycode:br&lang=pt&apiKey=${GEOAPIFY_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const coords = data.features[0].geometry.coordinates;
                    return { lat: coords[1], lon: coords[0] };
                } else {
                    const newAddress = `${address}, Guaíba, RS`;
                    console.log(`Primeira tentativa falhou para '${address}', tentando com '${newAddress}'`);
                    const fallbackUrl = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(newAddress)}&filter=countrycode:br&lang=pt&apiKey=${GEOAPIFY_API_KEY}`;
                    
                    const fallbackResponse = await fetch(fallbackUrl);
                    const fallbackData = await fallbackResponse.json();

                    if (fallbackData.features && fallbackData.features.length > 0) {
                        const coords = fallbackData.features[0].geometry.coordinates;
                        return { lat: coords[1], lon: coords[0] };
                    } else {
                        console.warn(`A segunda geocodificação (fallback) também falhou para: '${newAddress}'. Endereço original: '${address}'`);
                        return null; 
                    }
                }
            } catch (error) {
                console.error(`Erro na chamada da API de geocodificação para: '${address}'`, error);
                return null;
            }
        }
        
        // Incluindo a função initHeatmap modificada
        async function initHeatmap() {
            const mapDiv = document.getElementById('heatmap-canvas');
            if (!mapDiv) {
                console.error('Elemento do mapa não encontrado');
                return;
            }

            // Remove o mapa anterior, se existir
            if (map && map.remove) {
                map.off();
                map.remove();
                map = null; // Garante que a variável seja limpa
            }
            
            const center = [-30.1118, -51.3255]; // Centro de Guaíba
            
            try {
                // Inicializa o mapa Leaflet
                map = L.map(mapDiv, { preferCanvas: true }).setView(center, 13); // preferCanvas pode ajudar

                // Adiciona a camada base do mapa (tiles)
                L.tileLayer(`https://maps.geoapify.com/v1/tile/dark-matter/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_API_KEY}`, {
                    attribution: 'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a>',
                    maxZoom: 19 // Definir zoom máximo pode ajudar
                }).addTo(map);

                console.log('Mapa Leaflet inicializado, aguardando...');

                // CORREÇÃO: Adiciona um pequeno delay antes de adicionar o heatmap
                setTimeout(async () => {
                    try {
                        console.log('Buscando endereços dos usuários para heatmap...');
                        
                        // Busca e geocodifica os endereços dos usuários
                        const geocodePromises = state.users
                            .filter(user => user.address && user.address.trim() !== '')
                            .map(user => geocodeAddress(user.address)); 

                        const results = await Promise.all(geocodePromises);
                        
                        // Filtra resultados válidos e formata para o heatmap
                        const locationsData = results
                            .filter(coords => coords !== null) 
                            .map(coords => [coords.lat, coords.lon]);

                        console.log(`Total de coordenadas válidas para o heatmap: ${locationsData.length}`);

                        // Adiciona a camada de calor (heatmap) se houver dados
                        if (locationsData.length > 0) {
                            if (heatmap && map.hasLayer(heatmap)) { // Remove o heatmap anterior se existir
                                map.removeLayer(heatmap);
                                heatmap = null;
                            }
                            
                            heatmap = L.heatLayer(locationsData, {
                                radius: 50, 
                                blur: 25,   
                                maxZoom: 18, // Manter consistente com o tileLayer
                                gradient: { 0.2: 'blue', 0.4: 'cyan', 0.6: 'lime', 0.8: 'yellow', 1: 'red' },
                                minOpacity: 0.1 // Adiciona opacidade mínima
                            }).addTo(map);
                            
                            // Ajusta a visão do mapa para conter os pontos
                            if (locationsData.length > 1) {
                                try {
                                    const bounds = L.latLngBounds(locationsData);
                                    if(bounds.isValid()){ // Verifica se os bounds são válidos
                                         map.fitBounds(bounds.pad(0.1)); 
                                    } else {
                                         console.warn("Bounds inválidos calculados, centrando no primeiro ponto.");
                                         map.setView(locationsData[0], 15);
                                    }
                                } catch (boundsError) {
                                     console.warn("Erro ao calcular bounds, mantendo visão inicial:", boundsError);
                                     map.setView(center, 13);
                                }
                            } else if (locationsData.length === 1) {
                                 map.setView(locationsData[0], 15); // Centraliza no único ponto
                            } else {
                                 map.setView(center, 13); // Caso raro, mas seguro
                            }

                        } else {
                            console.warn('Nenhuma coordenada válida encontrada para gerar o mapa de calor.');
                            // showModal('Não foi possível geocodificar nenhum endereço dos usuários para gerar o mapa de calor.'); 
                        }
                    } catch (heatmapError) {
                         console.error('Erro ao processar dados ou adicionar heatmap:', heatmapError);
                         showModal('Erro ao gerar a camada de calor. Verifique o console.');
                    }
                }, 500); // Atraso de 500ms (meio segundo)

            } catch (error) {
                console.error('Erro ao inicializar o mapa Leaflet:', error);
                showModal('Erro ao carregar o mapa base. Verifique o console para detalhes.');
            }
        }
        
        
        // Incluir getDrivingDistance e formatDestination antes de serem chamadas
        async function getDrivingDistance(originAddress, destinationAddress) {
            let originCoords, destCoords;
            try {
                 // Limpa os endereços antes de geocodificar
                 const cleanOrigin = cleanAddressString(originAddress);
                 const cleanDestination = formatDestination(destinationAddress); // formatDestination já limpa
                 
                 if (!cleanOrigin || !cleanDestination || cleanDestination === '-') {
                      throw new Error('Endereço de origem ou destino inválido após limpeza');
                 }

                originCoords = await geocodeAddress(cleanOrigin);
                if (!originCoords) throw new Error(`Falha ao geocodificar origem: ${cleanOrigin}`);
                
                destCoords = await geocodeAddress(cleanDestination);
                if (!destCoords) throw new Error(`Falha ao geocodificar destino: ${cleanDestination}`);

            } catch (error) {
                console.error('Erro na geocodificação para cálculo de distância:', error.message);
                return null;
            }
            
            return await getDrivingDistanceByCoords(originCoords, destCoords);
        }

        async function getDrivingDistanceByCoords(originCoords, destCoords) {
            if (!originCoords || typeof originCoords.lat === 'undefined' || typeof originCoords.lon === 'undefined' ||
                !destCoords || typeof destCoords.lat === 'undefined' || typeof destCoords.lon === 'undefined') {
                console.warn("getDrivingDistanceByCoords: Coordenadas inválidas.", originCoords, destCoords);
                return null;
            }

            const waypoints = `${originCoords.lat},${originCoords.lon}|${destCoords.lat},${destCoords.lon}`;
            const url = `https://api.geoapify.com/v1/routing?waypoints=${encodeURIComponent(waypoints)}&mode=drive&units=metric&apiKey=${GEOAPIFY_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const distanceInMeters = data.features[0].properties.distance;
                    return distanceInMeters / 1000; // Retorna em KM
                } else {
                    console.error('Erro na API de Roteamento Geoapify:', data);
                     // Tenta calcular distância em linha reta como fallback
                     const R = 6371; // Raio da Terra em km
                     const dLat = (destCoords.lat - originCoords.lat) * Math.PI / 180;
                     const dLon = (destCoords.lon - originCoords.lon) * Math.PI / 180;
                     const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                               Math.cos(originCoords.lat * Math.PI / 180) * Math.cos(destCoords.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                     const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                     const fallbackDistance = R * c;
                     console.warn(`API de roteamento falhou, usando distância em linha reta: ${fallbackDistance.toFixed(2)} km`);
                     return fallbackDistance; 
                }
            } catch (error) {
                console.error('Erro ao buscar a distância (Geoapify):', error);
                return null;
            }
        }
        
        function formatDestination(destinationString) {
            if (typeof destinationString !== 'string' || !destinationString.trim()) return '-';

            let formattedAddress = '-';
            const trimmedString = destinationString.trim();

            // Lógica para tratar JSON complexo ou string simples
            if (trimmedString.startsWith('[{') && trimmedString.endsWith('}]')) {
                try {
                    const destinationsArray = JSON.parse(trimmedString);
                    if (Array.isArray(destinationsArray)) {
                        const addresses = destinationsArray
                            .map(dest => dest.address || '')
                            .filter(Boolean);
                        if (addresses.length > 0) {
                            formattedAddress = addresses.join(' - ');
                        }
                    }
                } catch (e) {
                    console.warn("Could not parse complex destination JSON, falling back:", trimmedString, e);
                    // Tentativa de fallback mais robusta
                    const regexAddresses = trimmedString.match(/"address":"(.*?)"/g);
                    if (regexAddresses) {
                        formattedAddress = regexAddresses.map(match => match.replace(/"address":"(.*)"/,'$1')).join(' - ');
                    } else {
                        // Fallback final: remove caracteres especiais e tenta juntar
                        formattedAddress = trimmedString.replace(/[\[\]\{\}"]/g, '').replace(/name:.*?,address:/g, '').replace(/,/g, ' - ').trim();
                    }
                }
            } 
            else { // Trata como string simples, removendo colchetes e aspas se houver
                formattedAddress = trimmedString.replace(/^\["|"\]$/g, '').trim();
            }

            return formattedAddress || '-'; // Garante que nunca retorne string vazia
        }
        
        let debounceTimer;

        function handleAddressInput(event, listId) {
            clearTimeout(debounceTimer);
            const query = event.target.value;
            debounceTimer = setTimeout(() => {
                searchAddress(query, listId);
            }, 300);
        }

        async function searchAddress(query, listId) {
            if (query.length < 3) {
                hideList(listId);
                return;
            }

            const list = document.getElementById(listId);
            if (!list) return;
            
            const inputId = listId.replace('List', '');
            const input = document.getElementById(inputId);
            if (input) {
                input.removeAttribute('data-address-valid');
            }
            
            list.innerHTML = '<div class="loading">Buscando...</div>';
            list.classList.add('show');

            try {
                const response = await fetch(
                    `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&lang=pt&limit=5&apiKey=${GEOAPIFY_API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    displayResults(data.features, listId);
                } else {
                    list.innerHTML = '<div class="no-results">Nenhum resultado encontrado</div>';
                }
            } catch (error) {
                console.error('Erro ao buscar endereços:', error);
                list.innerHTML = '<div class="no-results">Erro ao buscar endereços</div>';
            }
        }

        function displayResults(features, listId) {
            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = '';

            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                
                const formatted = feature.properties.formatted;
                const city = feature.properties.city || '';
                const state = feature.properties.state || '';
                
                item.innerHTML = `
                    <strong>${formatted}</strong>
                    ${city || state ? `<br><small style="color: #999;">${city}${city && state ? ', ' : ''}${state}</small>` : ''}
                `;
                
                item.onclick = () => selectAddress(feature, listId);
                list.appendChild(item);
            });

            list.classList.add('show');
        }

        function selectAddress(feature, listId) {
            const inputId = listId.replace('List', '');
            const input = document.getElementById(inputId);
            
            if (input) {
                input.value = feature.properties.formatted;
                input.setAttribute('data-address-valid', 'true');
                 // Armazena a feature selecionada no estado global (se for o input de usuário)
                 if (inputId === 'origin') {
                     state.currentUserOrigin = feature;
                 } else if (inputId === 'destination') {
                     state.currentUserDestination = feature;
                 }
            }
            hideList(listId);
        }

        function hideList(listId) {
            const list = document.getElementById(listId);
            if (list) {
                list.classList.remove('show');
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-list').forEach(list => list.classList.remove('show'));
            }
        });


        // --- Inicialização do Supabase dentro do DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
             loadAppIcon(); // Carrega o ícone primeiro

             // Verifica se a biblioteca Supabase foi carregada
             if (typeof supabase === 'undefined') {
                 console.error("Supabase library not loaded!");
                 // Mostra um erro amigável na tela
                 const container = document.getElementById('app-container') || document.body;
                 container.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100 border border-red-400 rounded">Erro crítico: Não foi possível carregar a biblioteca de banco de dados (Supabase). Verifique sua conexão com a internet e atualize a página.</div>`;
             } else {
                 // Inicializa o cliente Supabase AQUI, depois que a biblioteca carregou
                 supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 
                 
                 // Só continua a inicialização do app se o Supabase carregou com sucesso
                 initApp(); 
             }
        });
        // --- FIM DA CORREÇÃO ---

    </script>
</body>
</html>
