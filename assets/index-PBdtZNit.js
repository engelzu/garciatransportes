(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const S="3bd73ecada1d478a8c9473ad4115be38";async function V(t,e){let s,o;try{if(s=await H(t),!s)throw new Error("Falha ao geocodificar origem");if(o=await H(e),!o)throw new Error("Falha ao geocodificar destino")}catch(n){return console.error("Erro na geocodificação para cálculo de distância:",n),null}return await le(s,o)}async function le(t,e){if(!t||typeof t.lat>"u"||typeof t.lon>"u"||!e||typeof e.lat>"u"||typeof e.lon>"u")return console.warn("getDrivingDistanceByCoords: Coordenadas inválidas.",t,e),null;const s=`${t.lat},${t.lon}|${e.lat},${e.lon}`,o=`https://api.geoapify.com/v1/routing?waypoints=${encodeURIComponent(s)}&mode=drive&units=metric&apiKey=${S}`;try{const r=await(await fetch(o)).json();return r.features&&r.features.length>0?r.features[0].properties.distance/1e3:(console.error("Erro na API de Roteamento Geoapify:",r),null)}catch(n){return console.error("Erro ao buscar a distância (Geoapify):",n),null}}function T(t){return typeof t!="string"?"":t.replace(/^\["|"\]$/g,"").trim()}function E(t){if(typeof t!="string"||!t.trim())return"-";let e="-";const s=t.trim();if(s.startsWith("[{")&&s.endsWith("}]"))try{const o=JSON.parse(s);if(Array.isArray(o)){const n=o.map(r=>r.address||"").filter(Boolean);n.length>0&&(e=n.join(" - "))}}catch(o){console.warn("Could not parse complex destination JSON, falling back:",s,o);const n=s.match(/"address":"(.*?)"/g);n?e=n.map(r=>r.replace(/"address":"(.*)"/,"$1")).join(" - "):e=s.replace(/[\[\]\{\}"]/g,"").replace(/name:.*?,address:/g,"").replace(/,/g," - ").trim()}else e=s.replace(/^\["|"\]$/g,"").trim();return e||"-"}function J(t){if(typeof t!="string"||!t.trim())return null;const e=t.trim();if(e.startsWith("[{")&&e.endsWith("}]"))try{const s=JSON.parse(e);if(Array.isArray(s)&&s.length>0)return s[s.length-1].address||null}catch(s){return console.warn("Não foi possível analisar o JSON de destino para cálculo de distância:",e,s),T(e)}return T(e)}async function H(t){if(!t||typeof t!="string"||t.trim().length<3)return console.warn(`Tentativa de geocodificar endereço inválido: ${t}`),Promise.reject("Endereço inválido");const e=`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(t)}&filter=countrycode:br&lang=pt&apiKey=${S}`;try{const o=await(await fetch(e)).json();if(o.features&&o.features.length>0){const n=o.features[0].geometry.coordinates;return{lat:n[1],lon:n[0]}}else{const n=`${t}, Guaíba, RS`,r=`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(n)}&filter=countrycode:br&lang=pt&apiKey=${S}`,c=await(await fetch(r)).json();if(c.features&&c.features.length>0){const u=c.features[0].geometry.coordinates;return{lat:u[1],lon:u[0]}}else throw console.error(`A segunda geocodificação também falhou para: ${n}`),new Error("ZERO_RESULTS")}}catch(s){throw console.error(`Geocodificação falhou para: ${t}`,s),s}}let y=null,x,U,O=null,D=null,W,a={rides:[],drivers:[],users:[],appIcon:localStorage.getItem("appIcon")||null,currentDriverId:null,currentUserRideId:null,currentUserId:null,userStatusInterval:null,currentUserOrigin:null,currentUserDestination:null,isOriginSelected:!1,isDestinationSelected:!1,isNewUserAddressSelected:!1,isEditUserAddressSelected:!1};const de="https://jowsbmuqbzxukbbxbeqv.supabase.co",ce="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w",g=supabase.createClient(de,ce),w=document.getElementById("admin-ringtone");let A=null,X=!1;function N(){X||w&&(w.muted=!0,w.play().then(()=>{w.pause(),w.currentTime=0,w.muted=!1,X=!0,console.log("Áudio do Admin desbloqueado."),document.body.removeEventListener("click",N),document.body.removeEventListener("touchstart",N)}).catch(()=>{w.muted=!1}))}document.body.addEventListener("click",N);document.body.addEventListener("touchstart",N);function K(){if(!X){console.warn("Áudio do admin bloqueado, aguardando interação do usuário.");return}w.currentTime=0,w.play().catch(t=>console.error("Erro ao tocar som do admin:",t))}function P(){var e;b(),K(),A=setInterval(K,6e3);const t=document.querySelector("#admin-requests-screen .lg\\:col-span-1");if(t&&!document.getElementById("admin-silence-btn")){const s=document.createElement("button");s.id="admin-silence-btn",s.textContent="Silenciar Alerta",s.className="w-full mb-4 py-2 px-4 font-semibold rounded-lg bg-yellow-500 text-gray-900",s.onclick=b,t.prepend(s)}(e=document.getElementById("admin-silence-btn"))==null||e.classList.remove("hidden")}function b(){var t;A&&(clearInterval(A),A=null),w&&(w.pause(),w.currentTime=0),(t=document.getElementById("admin-silence-btn"))==null||t.classList.add("hidden")}function d(t,e,s=!1,o={}){document.getElementById("modal-message").textContent=t;const n=document.getElementById("modal-confirm"),r=document.getElementById("modal-cancel"),l=document.getElementById("modal-input-container");Array.from(l.children).forEach(i=>{(i.tagName==="INPUT"||i.tagName==="SELECT"||i.classList.contains("autocomplete-container"))&&(i.style.display="none",i.tagName!=="DIV"&&(i.value=""))});const c=document.getElementById("modal-input-address");c&&(c.value=""),o.type?(l.classList.remove("hidden"),o.type==="edit-driver"?(document.getElementById("modal-input-name").style.display="block",document.getElementById("modal-input-phone").style.display="block",document.getElementById("modal-input-plate").style.display="block",document.getElementById("modal-input-model").style.display="block",document.getElementById("modal-input-color").style.display="block",document.getElementById("modal-input-password").style.display="block",document.getElementById("modal-input-status").style.display="block",document.getElementById("modal-input-name").value=o.name,document.getElementById("modal-input-phone").value=o.phone,document.getElementById("modal-input-plate").value=o.plate,document.getElementById("modal-input-model").value=o.car_model||"",document.getElementById("modal-input-color").value=o.car_color||"",document.getElementById("modal-input-status").value=o.status):o.type==="edit-user"?(document.getElementById("modal-input-matricula").style.display="block",document.getElementById("modal-input-name").style.display="block",document.getElementById("modal-input-password").style.display="block",document.getElementById("modal-input-company").style.display="block",document.getElementById("modal-input-address").parentElement.style.display="block",document.getElementById("modal-input-phone").style.display="block",document.getElementById("modal-input-matricula").value=o.matricula,document.getElementById("modal-input-name").value=o.name,document.getElementById("modal-input-company").value=o.company,document.getElementById("modal-input-address").value=o.address,document.getElementById("modal-input-phone").value=o.phone):o.type==="driver-password"?document.getElementById("modal-input-driver-password").style.display="block":o.type==="delete-with-password"&&(document.getElementById("modal-input-admin-password").style.display="block")):l.classList.add("hidden"),n.onclick=e,r.style.display=s?"inline-block":"none",n.textContent=s?"Confirmar":"OK",s||(n.onclick=I);const u=document.getElementById("modal");u.classList.remove("hidden"),u.classList.add("flex")}function I(){const t=document.getElementById("modal");t.classList.add("hidden"),t.classList.remove("flex"),Array.from(document.getElementById("modal-input-container").children).forEach(e=>{(e.tagName==="INPUT"||e.tagName==="SELECT")&&(e.value="",e.style.display="none"),e.classList.contains("autocomplete-container")&&(e.style.display="none",e.querySelector("input"))})}function j(){a.currentUserId=null,a.currentDriverId=null,localStorage.removeItem("sessionType"),localStorage.removeItem("loggedInUserId"),localStorage.removeItem("loggedInDriverId"),h("initial-screen")}async function ue(){const t=document.getElementById("admin-password").value,e=document.getElementById("admin-login-error");t==="789512"?(e.classList.add("hidden"),document.getElementById("admin-password").value="",localStorage.setItem("sessionType","admin"),h("admin-screen")):e.classList.remove("hidden")}async function me(){const t=document.getElementById("user-id").value,e=document.getElementById("user-password").value,s=document.getElementById("user-login-error"),{data:o,error:n}=await g.from("users").select("*").eq("matricula",t).eq("password",e).single();if(n&&n.code!=="PGRST116"){console.error("Erro no Supabase ao tentar login:",n),s.textContent="Erro de comunicação com o servidor. Por favor, tente novamente.",s.classList.remove("hidden");return}o?(a.currentUserId=o.id,localStorage.setItem("sessionType","user"),localStorage.setItem("loggedInUserId",o.id),s.classList.add("hidden"),document.getElementById("user-id").value="",document.getElementById("user-password").value="",h("user-screen")):(s.textContent="Matrícula ou senha incorreta!",s.classList.remove("hidden"))}function h(t){const e=document.body;document.querySelectorAll(".screen").forEach(r=>r.classList.remove("active")),document.getElementById(t).classList.add("active"),b(),D&&clearInterval(D);const s=document.getElementById("app-container");["admin-requests-screen","admin-driver-crud-screen","admin-user-crud-screen","admin-heatmap-screen","admin-records-screen"].includes(t)?s.classList.add("pt-8"):s.classList.remove("pt-8"),["admin-requests-screen","admin-driver-crud-screen","admin-user-crud-screen","admin-heatmap-screen","admin-records-screen"].includes(t)?(e.classList.remove("items-center"),e.classList.add("justify-start")):(e.classList.contains("items-center")||e.classList.add("items-center"),e.classList.remove("justify-start")),t==="admin-requests-screen"&&(ee(),te(),pe("digital-clock")),t==="admin-driver-crud-screen"&&ne(),t==="admin-user-crud-screen"&&se(),t==="admin-heatmap-screen"&&nt(),t==="driver-selection-screen"&&F(),t==="driver-screen"&&(re(),Xe()),t==="user-screen"&&(Y(),z(),$()),t==="admin-records-screen"&&(ze(),document.getElementById("records-start-date").value="",document.getElementById("records-end-date").value="",document.getElementById("records-company-filter").value="")}function pe(t){const e=document.getElementById(t);e&&(D&&clearInterval(D),D=setInterval(()=>{const s=new Date;e.textContent=s.toLocaleTimeString("pt-BR")},1e3))}function ge(){const t=document.getElementById("modal-confirm"),e=document.getElementById("modal-cancel");e.textContent="Apenas Voltar",e.onclick=()=>{I(),h("admin-screen")},t.textContent="Exportar e Voltar",t.onclick=()=>{a.rides.length===0?(d("Nenhuma corrida para exportar. Voltando ao painel...",null,!1),setTimeout(()=>{I(),h("admin-screen")},2e3)):(ie(),I(),h("admin-screen"))},d("Deseja exportar o relatório diário antes de sair?",null,!0)}async function fe(){const t=document.getElementById("origin").value,e=document.getElementById("destination").value;if(!a.isOriginSelected){d("Por favor, selecione um endereço de ORIGEM válido da lista.",null,!1);return}if(!a.isDestinationSelected){d("Por favor, selecione um endereço de DESTINO válido da lista.",null,!1);return}const s=document.getElementById("schedule-toggle").checked,o=document.getElementById("schedule-datetime").value;let n=null;if(s){if(!o){d("Por favor, selecione a data e hora para o agendamento.",null,!1);return}if(n=new Date(o).toISOString(),new Date(n)<new Date){d("A data de agendamento não pode ser no passado.",null,!1);return}}document.getElementById("user-request-form").classList.add("hidden"),document.getElementById("user-status").classList.remove("hidden"),document.getElementById("user-status-message").textContent="Solicitando corrida...";try{let r=null;try{const f=J(e),v=await V(t,f);v!==null&&(r=parseFloat(v.toFixed(1)))}catch(f){console.error("Erro ao calcular distância na solicitação:",f)}const l=a.currentUserOrigin.properties,c={lat:l.lat,lon:l.lon},u=a.users.find(f=>f.id===a.currentUserId),i={destination:e,origin_address:t,status:"requested",userId:u.id,userName:u.name,userCompany:u.company,requestTime:new Date().toISOString(),userLocation:c,request_type:s?"scheduled":"immediate",scheduled_datetime:n,km:r},{data:m,error:p}=await g.from("rides").insert([i]).select().single();if(p){console.error("Erro ao solicitar corrida:",p),d("Não foi possível solicitar a corrida. Verifique os endereços.",null,!1),document.getElementById("user-request-form").classList.remove("hidden"),document.getElementById("user-status").classList.add("hidden");return}a.currentUserRideId=m.id,document.getElementById("user-status-message").textContent="Aguardando um motorista aceitar...",Z(),a.currentUserOrigin=null,a.currentUserDestination=null,a.isOriginSelected=!1,a.isDestinationSelected=!1}catch(r){console.error("Erro ao processar solicitação de corrida:",r),d("Não foi possível processar sua solicitação.",null,!1),document.getElementById("user-request-form").classList.remove("hidden"),document.getElementById("user-status").classList.add("hidden")}}function Y(){if(a.currentUserRideId){const t=a.rides.find(e=>e.id===a.currentUserRideId);t?(document.getElementById("user-request-form").classList.add("hidden"),document.getElementById("user-status").classList.remove("hidden"),Q(t),Z()):(a.currentUserRideId=null,document.getElementById("user-request-form").classList.remove("hidden"),document.getElementById("user-status").classList.add("hidden"),document.getElementById("user-status-message").textContent="Sua viagem foi finalizada ou cancelada.")}}function Z(){a.userStatusInterval&&clearInterval(a.userStatusInterval),a.userStatusInterval=setInterval(async()=>{if(!a.currentUserRideId){clearInterval(a.userStatusInterval);return}const{data:t,error:e}=await g.from("rides").select("*").eq("id",a.currentUserRideId).single();t?Q(t):(clearInterval(a.userStatusInterval),a.currentUserRideId=null,document.getElementById("user-request-form").classList.remove("hidden"),document.getElementById("user-status").classList.add("hidden"),document.getElementById("user-status-message").textContent="Sua viagem foi finalizada ou cancelada (pelo sistema).")},5e3)}function Q(t){const e=document.getElementById("status-icon-searching"),s=document.getElementById("status-icon-en-route"),o=document.getElementById("status-icon-arrived-pickup"),n=document.getElementById("status-icon-in-progress"),r=document.getElementById("cancel-ride-btn");let l="Aguardando um motorista...";switch(e.classList.add("hidden"),s.classList.add("hidden"),o.classList.add("hidden"),n.classList.add("hidden"),s.innerHTML="",o.innerHTML="",n.innerHTML="",t.status==="requested"||t.status==="assigned"||t.status==="accepted"||t.status==="arrived_pickup"?r.classList.remove("hidden"):r.classList.add("hidden"),t.status){case"assigned":l=`Motorista ${t.driverName} foi designado. Aguardando aceite...`,e.classList.remove("hidden");break;case"accepted":l=`Motorista ${t.driverName} está a caminho!`;const c=document.createElement("img");c.src="images/aceitou.png",c.alt="Motorista Aceitou",c.className="h-20 w-20 mx-auto",s.appendChild(c),s.classList.remove("hidden");break;case"arrived_pickup":l=`Seu motorista, ${t.driverName}, chegou no local de embarque.`;const u=document.createElement("img");u.src="images/final.png",u.alt="Motorista Chegou",u.className="h-20 w-20 mx-auto",o.appendChild(u),o.classList.remove("hidden");break;case"in_progress":l=`Viagem para ${E(t.destination)} em andamento.`;const i=document.createElement("img");i.src="images/destino.png",i.alt="Viagem Iniciada",i.className="h-20 w-20 mx-auto animate-bounce",n.appendChild(i),n.classList.remove("hidden"),r.classList.add("hidden");break;case"completed":l="Viagem finalizada! Obrigado por escolher a GARCIA TAXI.",clearInterval(a.userStatusInterval),a.currentUserRideId=null,setTimeout(()=>{document.getElementById("user-request-form").classList.remove("hidden"),document.getElementById("user-status").classList.add("hidden"),document.getElementById("destination").value="",$()},5e3);break;case"canceled":l="Sua viagem foi cancelada.",clearInterval(a.userStatusInterval),a.currentUserRideId=null,setTimeout(()=>{document.getElementById("user-request-form").classList.remove("hidden"),document.getElementById("user-status").classList.add("hidden"),document.getElementById("destination").value="",$()},3e3);break}document.getElementById("user-status-message").textContent=l}async function ye(){if(a.currentUserRideId){y&&(navigator.geolocation.clearWatch(y),y=null);const{error:t}=await g.from("rides").update({status:"canceled"}).eq("id",a.currentUserRideId);t&&d("Não foi possível cancelar a corrida.",null,!1)}}function ee(){const t=document.getElementById("admin-requests-list");t.innerHTML="";const e=a.rides.filter(i=>i.status==="requested"||i.status==="approved"||i.status==="pending_approval"||i.status==="scheduled");e.sort((i,m)=>new Date(i.request_type==="scheduled"&&i.scheduled_datetime||i.requestTime).getTime()-new Date(m.request_type==="scheduled"&&m.scheduled_datetime||m.requestTime).getTime());const s=a.rides.filter(i=>["requested","approved","pending_approval"].includes(i.status)).length,o=a.rides.filter(i=>i.status==="scheduled").length,n=a.rides.filter(i=>i.status==="assigned").length,r=a.rides.filter(i=>["accepted","arrived_pickup","in_progress"].includes(i.status)).length,l=a.rides.filter(i=>i.status==="completed").length;document.getElementById("status-agendada-count").textContent=String(o),document.getElementById("status-solicitado-count").textContent=String(s),document.getElementById("status-designado-count").textContent=String(n),document.getElementById("status-em-andamento-count").textContent=String(r),document.getElementById("status-concluidas-count").textContent=String(l);const c=a.drivers.filter(i=>i.status==="active").length,u=a.drivers.length;document.getElementById("total-drivers-count").textContent=String(u),document.getElementById("active-drivers-count").textContent=String(c),document.getElementById("inactive-drivers-count").textContent=String(u-c),Oe(c,u-c),e.length===0?t.innerHTML='<p class="text-center text-gray-400">Nenhuma nova solicitação.</p>':e.forEach(i=>{const m=document.createElement("div");m.className="card-gradient p-4 rounded-lg shadow-md";const p=T(i.origin_address),f=E(i.destination);let v='<p class="text-sm text-gray-400">Distância: N/A</p>';i.km&&(v=`<p class="font-semibold">Distância: <span class="font-normal">${i.km} km</span></p>`);let R="";i.request_type==="scheduled"&&i.scheduled_datetime?R=`<span class="text-xs font-bold py-1 px-2 rounded-full bg-orange-500 text-white">AGENDADA ${new Date(i.scheduled_datetime).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})}</span>`:R='<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white">IMEDIATA</span>';let _="";if(i.status==="pending_approval")_='<div class="mt-4 text-center p-2 rounded-lg bg-yellow-700 text-white font-semibold">Aguardando Aprovação</div>';else{const q=a.drivers.filter(C=>C.status==="active");let M=q.map(C=>`<option value="${C.id}">${C.name}</option>`).join("");q.length===0&&(M='<option value="" disabled>Nenhum motorista ativo</option>'),_=`
                    <div class="mt-4 flex gap-2">
                        <select id="driver-select-${i.id}" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white">
                            <option value="" class="text-gray-400">Selecione um motorista</option>
                            ${M}
                        </select>
                        <button onclick="assignDriver(${i.id})" class="py-2 px-4 font-semibold rounded-lg button-gradient whitespace-nowrap text-white">Marcar</button>
                    </div>`}m.innerHTML=`
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold text-lg">Nova Solicitação</h4>
                    ${R}
                </div>
                <p class="font-semibold">Origem: <span class="font-normal">${p||"Não informado"}</span></p>
                <p class="font-semibold">Destino: <span class="font-normal">${f}</span></p>
                <p class="font-semibold">Observação: <span class="font-normal text-yellow-300">${i.observation||"Nenhuma"}</span></p>
                ${v}
                <p class="text-sm text-gray-400">De: ${i.userName} ${i.userCompany?`(${i.userCompany})`:""}</p>
                <p class="text-sm text-gray-300">Solicitado em: ${new Date(i.requestTime).toLocaleTimeString()}</p>
                ${_}
            `,t.appendChild(m)})}function te(){const t=document.getElementById("admin-ongoing-rides-table"),e=a.rides.filter(n=>!["requested","approved","pending_approval","rejected","completed","canceled"].includes(n.status));if(e.length===0){t.innerHTML='<p class="text-center text-gray-400">Nenhuma corrida em andamento no momento.</p>';return}const s=e.map(n=>({...n,distanceKm:n.km?n.km:"N/D",cleanedOrigin:T(n.origin_address),formattedDestination:E(n.destination)}));let o=`
        <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                <tr>
                    <th scope="col" class="px-4 py-3">Usuário</th>
                    <th scope="col" class="px-4 py-3">Origem</th>
                    <th scope="col" class="px-4 py-3">Destino</th>
                    <th scope="col" class="px-4 py-3">Observação</th>
                    <th scope="col" class="px-4 py-3">Distância (km)</th>
                    <th scope="col" class="px-4 py-3">Motorista</th>
                    <th scope="col" class="px-4 py-3">Status</th>
                    <th scope="col" class="px-4 py-3">Tipo</th>
                    <th scope="col" class="px-4 py-3">Data/Hora</th>
                    <th scope="col" class="px-4 py-3">Ações</th>
                </tr>
            </thead>
            <tbody>
    `;s.sort((n,r)=>{const l=n.request_type==="scheduled"&&n.scheduled_datetime?new Date(n.scheduled_datetime):new Date(n.requestTime),c=r.request_type==="scheduled"&&r.scheduled_datetime?new Date(r.scheduled_datetime):new Date(r.requestTime);return l.getTime()-c.getTime()}),s.forEach(n=>{const r=B(n.status);let l=n.request_type==="scheduled"?'<span class="text-xs font-bold py-1 px-2 rounded-full bg-orange-500 text-white">AGENDADA</span>':'<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white">IMEDIATA</span>';const c={day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"},u=n.request_type==="scheduled"&&n.scheduled_datetime?new Date(n.scheduled_datetime).toLocaleString("pt-BR",c):new Date(n.requestTime).toLocaleString("pt-BR",c);let i=n.driverName||"N/A",m='<div class="flex items-center gap-2">';if(n.status!=="in_progress"&&n.status!=="arrived_pickup"){let f=a.drivers.filter(v=>v.status==="active").map(v=>`<option value="${v.id}" ${n.driverId==v.id?"selected":""}>${v.name}</option>`).join("");i=`
                <select id="ongoing-driver-select-${n.id}" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-xs text-white">
                    <option value="" class="text-gray-400">Selecione...</option>
                    ${f}
                </select>`,m+=`<button onclick="updateRideDriver(${n.id})" class="py-1 px-2 text-xs font-semibold rounded-lg button-gradient whitespace-nowrap text-white">Salvar</button>`}m+=`
            <button onclick="adminCompleteRide(${n.id})" title="Marcar como Finalizada" class="p-1 rounded-lg bg-green-600 hover:bg-green-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button>
            <button onclick="adminDeleteRide(${n.id})" title="Excluir Corrida" class="p-1 rounded-lg bg-red-600 hover:bg-red-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
        </div>`,o+=`
            <tr class="border-b border-gray-700 hover:bg-gray-800/20">
                <td class="px-4 py-3 font-medium">${n.userName}</td>
                <td class="px-4 py-3">${n.cleanedOrigin||"-"}</td>
                <td class="px-4 py-3">${n.formattedDestination}</td>
                <td class="px-4 py-3 text-yellow-300">${n.observation||"-"}</td>
                <td class="px-4 py-3 font-semibold">${n.distanceKm}</td>
                <td class="px-4 py-3">${i}</td>
                <td class="px-4 py-3"><span class="status-badge ${r.colorClass}">${r.text}</span></td>
                <td class="px-4 py-3">${l}</td>
                <td class="px-4 py-3">${u}</td>
                <td class="px-4 py-3">${m}</td>
            </tr>`}),o+="</tbody></table>",t.innerHTML=o}async function ve(t){const e=document.getElementById(`ongoing-driver-select-${t}`);if(!e)return;const s=e.value;if(!s){d("Por favor, selecione um motorista para salvar.",null,!1);return}const o=a.drivers.find(r=>r.id==s);if(!o){d("Motorista selecionado não encontrado.",null,!1);return}const{error:n}=await g.from("rides").update({status:"assigned",driverId:parseInt(o.id),driverName:o.name}).eq("id",t);n?(console.error("Erro ao atualizar motorista da corrida:",n),d("Não foi possível atualizar o motorista.",null,!1)):d("Motorista atribuído com sucesso!",null,!1)}async function he(t){const e=document.getElementById(`driver-select-${t}`).value;if(!e){d("Por favor, selecione um motorista.",null,!1);return}const s=a.drivers.find(n=>n.id==e),{error:o}=await g.from("rides").update({status:"assigned",driverId:parseInt(s.id),driverName:s.name}).eq("id",t);o&&(console.error("Erro ao designar motorista:",o),d("Não foi possível designar o motorista.",null,!1))}function ne(){const t=document.getElementById("driver-crud-list");if(t.innerHTML="",a.drivers.length===0){t.innerHTML='<p class="text-center text-gray-400">Nenhum motorista cadastrado.</p>';return}const e=document.createElement("table");e.className="w-full text-sm text-left",e.innerHTML=`
        <thead class="text-xs text-gray-300 uppercase bg-gray-900/30 sticky top-0">
            <tr>
                <th scope="col" class="px-4 py-3">Motorista</th>
                <th scope="col" class="px-4 py-3">Placa</th>
                <th scope="col" class="px-4 py-3 text-right">Ações</th>
            </tr>
        </thead>`;const s=document.createElement("tbody");a.drivers.forEach(o=>{const n=document.createElement("tr");n.className="border-b border-gray-700 hover:bg-gray-800/20",n.innerHTML=`
            <td class="px-4 py-3 font-medium">
                <div class="flex items-center gap-3">
                   <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleDriverStatusAdmin(${o.id})" ${o.status==="active"?"checked":""}>
                        <span class="toggle-slider"></span>
                    </label>
                    <div>
                        <div>${o.name}</div>
                        <div class="text-xs text-gray-400">${o.phone}</div>
                        <div class="text-xs text-gray-500">${o.car_model||""} - ${o.car_color||""}</div>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3">${o.plate}</td>
            <td class="px-4 py-3 text-right">
                <button onclick="editDriver(${o.id})" class="font-medium text-yellow-400 hover:underline mr-3">Editar</button>
                <button onclick="promptDeleteDriver(${o.id})" class="font-medium text-red-500 hover:underline">Excluir</button>
            </td>
        `,s.appendChild(n)}),e.appendChild(s),t.appendChild(e)}async function we(){const t=document.getElementById("new-driver-name").value.trim(),e=document.getElementById("new-driver-phone").value.trim(),s=document.getElementById("new-driver-plate").value.trim(),o=document.getElementById("new-driver-model").value.trim(),n=document.getElementById("new-driver-color").value.trim(),r=document.getElementById("new-driver-password").value.trim();if(!t||!e||!s||!r||!o||!n){d("Todos os campos são obrigatórios.",null,!1);return}const{error:l}=await g.from("drivers").insert([{name:t,phone:e,plate:s,password:r,status:"inactive",car_model:o,car_color:n}]);l?(console.error("Error adding driver:",l),d("Erro ao adicionar motorista.",null,!1)):(["new-driver-name","new-driver-phone","new-driver-plate","new-driver-model","new-driver-color","new-driver-password"].forEach(c=>document.getElementById(c).value=""),d("Motorista adicionado com sucesso!",null,!1))}function Ee(t){const e=a.drivers.find(o=>o.id===t);if(!e)return;d("Editar dados do motorista:",async()=>{const o=document.getElementById("modal-input-name").value.trim(),n=document.getElementById("modal-input-phone").value.trim(),r=document.getElementById("modal-input-plate").value.trim(),l=document.getElementById("modal-input-model").value.trim(),c=document.getElementById("modal-input-color").value.trim(),u=document.getElementById("modal-input-password").value.trim(),i=document.getElementById("modal-input-status").value;if(o&&n&&r&&l&&c){const m={name:o,phone:n,plate:r,status:i,car_model:l,car_color:c};u&&(m.password=u);const{error:p}=await g.from("drivers").update(m).eq("id",t);p?(console.error("Error updating driver:",p),d("Erro ao atualizar motorista.",null,!1)):I()}else d("Nome, Telefone, Placa, Modelo e Cor são obrigatórios.",null,!1)},!0,{type:"edit-driver",name:e.name,phone:e.phone,plate:e.plate,car_model:e.car_model,car_color:e.car_color,status:e.status})}function Ie(t){d("Digite a senha do admin para excluir:",async()=>{document.getElementById("modal-input-admin-password").value==="789512"?xe(t):d("Senha incorreta!",null,!1)},!0,{type:"delete-with-password"})}async function xe(t){const{error:e}=await g.from("drivers").delete().eq("id",t);e?(console.error("Error deleting driver:",e),d("Erro ao excluir motorista.",null,!1)):I()}function be(){const t=[["matricula","nome","senha","empresa","endereco","telefone"]],e=XLSX.utils.aoa_to_sheet(t),s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,e,"Usuarios"),XLSX.writeFile(s,"template_usuarios.xlsx")}function Be(){const t=document.getElementById("excel-file-input"),e=t.files[0];if(!e){d("Por favor, selecione um arquivo Excel.",null,!1);return}const s=new FileReader;s.onload=function(o){try{const n=new Uint8Array(o.target.result),r=XLSX.read(n,{type:"array"}),l=r.Sheets[r.SheetNames[0]],c=XLSX.utils.sheet_to_json(l);if(c.length===0){d("O arquivo Excel está vazio.",null,!1);return}const u=Object.keys(c[0]),i=["matricula","nome","senha","empresa","endereco","telefone"];if(JSON.stringify(u.sort())!==JSON.stringify(i.sort())){d(`Cabeçalho inválido. O esperado é: ${i.join(",")}`,null,!1);return}const m=c.map(p=>({matricula:String(p.matricula).trim(),name:String(p.nome).trim(),password:String(p.senha).trim(),company:String(p.empresa||"").trim(),address:String(p.endereco||"").trim(),phone:String(p.phone||"").trim()})).filter(p=>p.matricula&&p.name&&p.senha&&p.phone);m.length>0?g.from("users").insert(m).then(({error:p})=>{p?(console.error("Error importing users:",p),d(`Erro ao importar usuários: ${p.message}`,null,!1)):d(`${m.length} usuários importados com sucesso!`,null,!1)}):d("Nenhum usuário válido encontrado no arquivo para importar.",null,!1),t.value=""}catch{d("Ocorreu um erro ao processar o arquivo. Verifique se o formato está correto.",null,!1)}},s.onerror=function(){d("Ocorreu um erro ao ler o arquivo.",null,!1)},s.readAsArrayBuffer(e)}function se(){const t=document.getElementById("user-crud-list");if(t.innerHTML="",document.getElementById("user-count").textContent=String(a.users.length),a.users.length===0){t.innerHTML='<p class="text-center text-gray-400">Nenhum usuário cadastrado.</p>';return}const e=document.createElement("table");e.className="w-full text-sm text-left",e.innerHTML=`
        <thead class="text-xs text-gray-300 uppercase bg-gray-900/30 sticky top-0">
            <tr>
                <th scope="col" class="px-4 py-3">Nome</th>
                <th scope="col" class="px-4 py-3">Telefone</th>
                <th scope="col" class="px-4 py-3 text-right">Ações</th>
            </tr>
        </thead>`;const s=document.createElement("tbody");a.users.forEach(o=>{const n=document.createElement("tr");n.className="border-b border-gray-700 hover:bg-gray-800/20",n.innerHTML=`
            <td class="px-4 py-3 font-medium">
                <div>${o.name}</div>
                <div class="text-xs text-gray-400">${o.company||""}</div>
            </td>
            <td class="px-4 py-3">${o.phone||"N/A"}</td>
            <td class="px-4 py-3 text-right">
                <button onclick="editUser(${o.id})" class="font-medium text-yellow-400 hover:underline mr-3">Editar</button>
                <button onclick="promptDeleteUser(${o.id})" class="font-medium text-red-500 hover:underline">Excluir</button>
            </td>
        `,s.appendChild(n)}),e.appendChild(s),t.appendChild(e)}async function De(){const t=document.getElementById("new-user-id"),e=document.getElementById("new-user-name"),s=document.getElementById("new-user-password"),o=document.getElementById("new-user-company"),n=document.getElementById("new-user-address"),r=document.getElementById("new-user-phone"),l=t.value.trim(),c=e.value.trim(),u=s.value.trim(),i=o.value.trim(),m=n.value.trim(),p=r.value.trim();if(!l||!c||!u||!p){d("Matrícula, Nome, Senha e Telefone são obrigatórios.",null,!1);return}const{error:f}=await g.from("users").insert([{matricula:l,name:c,password:u,company:i,address:m,phone:p}]);f?(console.error("Error adding user:",f),d("Erro ao adicionar usuário.",null,!1)):([t,e,s,o,n,r].forEach(v=>v.value=""),a.isNewUserAddressSelected=!1,d("Usuário adicionado com sucesso!",null,!1))}function Se(t){const e=a.users.find(o=>o.id==t);if(!e){console.error(`Usuário com ID ${t} não encontrado.`);return}d("Editar dados do usuário:",async()=>{const o=document.getElementById("modal-input-matricula").value.trim(),n=document.getElementById("modal-input-name").value.trim(),r=document.getElementById("modal-input-password").value.trim(),l=document.getElementById("modal-input-company").value.trim(),c=document.getElementById("modal-input-address").value.trim(),u=document.getElementById("modal-input-phone").value.trim();if(!n||!u){d("Nome completo e telefone são obrigatórios.",null,!1);return}const i={matricula:o,name:n,company:l,address:c,phone:u};r&&(i.password=r);const{error:m}=await g.from("users").update(i).eq("id",t);m?(console.error("Error updating user:",m),d("Erro ao atualizar usuário.",null,!1)):I()},!0,{type:"edit-user",matricula:e.matricula,name:e.name,company:e.company,address:e.address,phone:e.phone})}function Le(t){d("Digite a senha do admin para excluir:",async()=>{document.getElementById("modal-input-admin-password").value==="789512"?Te(t):d("Senha incorreta!",null,!1)},!0,{type:"delete-with-password"})}async function Te(t){const{error:e}=await g.from("users").delete().eq("id",t);e?(console.error("Error deleting user:",e),d("Erro ao excluir usuário.",null,!1)):I()}function Ce(){if(a.users.length===0){d("Nenhum usuário cadastrado para exportar.",null,!1);return}const t=a.users.map(o=>({Matrícula:o.matricula,"Nome Completo":o.name,Empresa:o.company||"N/A",Endereço:o.address||"N/A",Telefone:o.phone})),e=XLSX.utils.json_to_sheet(t),s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,e,"Lista de Usuários"),e["!cols"]=[{wch:15},{wch:35},{wch:20},{wch:40},{wch:20}],XLSX.writeFile(s,"relatorio_usuarios.xlsx")}function F(){const t=document.getElementById("driver-list-selection"),e=document.getElementById("driver-selection-timestamp");t.innerHTML="";const s=new Date().toLocaleString("pt-BR");e.textContent=`Status atualizado em ${s}`,a.drivers.forEach(o=>{const n=a.rides.some(l=>l.driverId===o.id&&l.status!=="completed"&&l.status!=="canceled"),r=document.createElement("button");r.className="w-full py-3 px-6 text-lg font-semibold rounded-lg card-gradient shadow-lg transform hover:scale-105 transition-transform flex justify-between items-center",r.onclick=()=>oe(o.id),r.innerHTML=`
            <span class="text-white">${o.name}</span>
            <span class="text-sm font-bold py-1 px-3 rounded-full ${o.status==="active"&&!n?"bg-green-500 text-white":"bg-red-600 text-white"}">
                ${o.status==="active"&&!n?"Livre":"Ocupado"}
            </span>
        `,t.appendChild(r)})}function oe(t){const e=a.drivers.find(o=>o.id===t);if(!e)return;const s=()=>{document.getElementById("modal-input-driver-password").value===e.password?(a.currentDriverId=t,localStorage.setItem("sessionType","driver"),localStorage.setItem("loggedInDriverId",String(t)),document.getElementById("driver-name-display").textContent=`Bem-vindo, ${e.name}`,ae(),h("driver-screen"),I()):document.getElementById("modal-message").textContent="Senha Incorreta!"};d(`Login para ${e.name}`,s,!0,{type:"driver-password"})}function re(){if(!a.currentDriverId)return;const t=document.getElementById("driver-jobs-list");t.innerHTML="";const e=a.rides.filter(n=>n.driverId===a.currentDriverId&&n.status!=="completed"&&n.status!=="canceled"),s=document.getElementById("driver-stats-display");if(s.textContent=`${e.length} solicitações carregadas em ${new Date().toLocaleString("pt-BR")}`,e.length===0){t.innerHTML='<p class="text-center text-gray-400">Nenhuma corrida para você no momento.</p>',b(),y&&(navigator.geolocation.clearWatch(y),y=null);return}let o=!1;e.forEach(n=>{const r=document.createElement("div");r.className="card-gradient p-4 rounded-lg shadow-md";const l=new Date(n.requestTime).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});let c=`
            <div class="flex justify-between items-start mb-1">
                <p class="font-semibold pr-2">Destino Final: <span class="font-normal">${E(n.destination)}</span></p>
                <p class="text-sm text-gray-300">Solicitado por: ${n.userName} ${n.userCompany?`(${n.userCompany})`:""}</p>
                <p class="text-xs text-gray-400 whitespace-nowrap">${l}</p>
            </div>
            <p class="text-sm text-gray-300 mb-4">Status: <span class="font-semibold text-yellow-300">${B(n.status).text}</span></p>
        `;n.status==="assigned"?(o=!0,c+=`<button onclick="acceptRide(${n.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">ACEITAR CORRIDA</button>`):n.status==="accepted"?c+=`<button onclick="arriveAtPickup(${n.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">CHEGUEI NO LOCAL DE EMBARQUE</button>`:n.status==="arrived_pickup"?c+=`<button onclick="startTrip(${n.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">INICIAR VIAGEM PARA O DESTINO</button>`:n.status==="in_progress"&&(c+=`<button onclick="completeRide(${n.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">FINALIZAR CORRIDA</button>`),r.innerHTML=c,t.appendChild(r)}),o?P():b()}async function Ae(t){b(),Re(t);const{error:e}=await g.from("rides").update({status:"accepted",acceptTime:new Date().toISOString()}).eq("id",t);if(e)console.error("Erro ao aceitar corrida:",e),d("Não foi possível aceitar a corrida.",null,!1);else{const s=a.rides.find(o=>o.id===t);if(s&&s.userLocation&&s.userLocation.lat&&s.userLocation.lon){const{lat:o,lon:n}=s.userLocation;window.open(`waze://?ll=${o},${n}&navigate=yes`,"_blank")}else s&&s.origin_address?window.open(`waze://?q=${encodeURIComponent(s.origin_address)}&navigate=yes`,"_blank"):d("Não foi possível obter a localização do usuário ou endereço de origem para navegação.",null,!1)}}async function ke(t){const{error:e}=await g.from("rides").update({status:"arrived_pickup"}).eq("id",t);e&&(console.error("Erro ao atualizar status para 'chegou no local':",e),d("Não foi possível marcar como 'chegou no local'.",null,!1))}async function Ne(t){const e=a.rides.find(s=>s.id===t);if(e){const{error:s}=await g.from("rides").update({status:"in_progress"}).eq("id",t);if(s)console.error("Erro ao iniciar viagem:",s),d("Não foi possível iniciar a viagem.",null,!1);else{const o=E(e.destination);window.open(`waze://?q=${encodeURIComponent(o)}&navigate=yes`,"_blank")}}}async function $e(t){const e=a.rides.find(n=>n.id===t);let s=null;if(e&&e.origin_address&&e.destination)try{const n=J(e.destination),r=await V(e.origin_address,n);r!==null&&(s=parseFloat(r.toFixed(1)))}catch(n){console.error("Erro ao calcular distância final:",n)}const{error:o}=await g.from("rides").update({status:"completed",km:s}).eq("id",t);o?(console.error("Erro ao completar corrida:",o),d("Não foi possível finalizar a corrida.",null,!1)):y&&(navigator.geolocation.clearWatch(y),y=null)}function Re(t){y&&navigator.geolocation.clearWatch(y),y=navigator.geolocation.watchPosition(async e=>{const s={lat:e.coords.latitude,lon:e.coords.longitude};a.rides.find(n=>n.id===t&&n.status!=="completed"&&n.status!=="canceled")?await g.from("rides").update({driverCurrentLocation:s}).eq("id",t):(navigator.geolocation.clearWatch(y),y=null)},e=>{console.error("Erro ao rastrear localização do motorista:",e)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}async function k(){const{data:t,error:e}=await g.from("drivers").select("*");e?console.error("Error fetching drivers:",e):a.drivers=t;const{data:s,error:o}=await g.from("users").select("*");o?console.error("Error fetching users:",o):a.users=s;const{data:n,error:r}=await g.from("rides").select("*");r?console.error("Error fetching rides:",r):a.rides=n}function _e(){g.channel("public:drivers").on("postgres_changes",{event:"*",schema:"public",table:"drivers"},t=>{k().then(()=>{var s;const e=(s=document.querySelector(".screen.active"))==null?void 0:s.id;e==="admin-driver-crud-screen"?ne():e==="driver-selection-screen"&&F(),e==="user-screen"&&z()})}).subscribe(),g.channel("public:users").on("postgres_changes",{event:"*",schema:"public",table:"users"},t=>{k().then(()=>{var e;((e=document.querySelector(".screen.active"))==null?void 0:e.id)==="admin-user-crud-screen"&&se()})}).subscribe(),g.channel("public:rides").on("postgres_changes",{event:"*",schema:"public",table:"rides"},t=>{localStorage.getItem("sessionType")==="admin"&&(t.eventType==="INSERT"&&(t.new.status==="requested"||t.new.status==="scheduled")||t.eventType==="UPDATE"&&t.new.status==="approved"&&t.old.status!=="approved")&&P(),k().then(()=>{var s;const e=(s=document.querySelector(".screen.active"))==null?void 0:s.id;e==="admin-requests-screen"?(ee(),te()):e==="driver-screen"?re():e==="user-screen"?(Y(),z(),$()):e==="driver-selection-screen"&&F()})}).subscribe()}function ae(){const t=a.drivers.find(o=>o.id===a.currentDriverId);if(!t)return;const e=document.getElementById("driver-status-toggle"),s=document.getElementById("driver-status-label");t.status==="active"?(e.checked=!0,s.textContent="ATIVO",s.className="font-bold text-green-400"):(e.checked=!1,s.textContent="INATIVO",s.className="font-bold text-red-400")}async function qe(){const t=a.drivers.find(e=>e.id===a.currentDriverId);if(t){const e=t.status==="active"?"inactive":"active",{error:s}=await g.from("drivers").update({status:e}).eq("id",t.id);s&&console.error("Error updating driver status:",s)}}async function Me(t){const e=a.drivers.find(s=>s.id===t);if(e){const s=e.status==="active"?"inactive":"active",{error:o}=await g.from("drivers").update({status:s}).eq("id",e.id);o&&console.error("Error updating driver status:",o)}}function z(){const t=a.drivers.filter(s=>{const o=a.rides.some(n=>n.driverId===s.id&&n.status!=="completed"&&n.status!=="canceled");return s.status==="active"&&!o}),e=document.getElementById("available-drivers-count");e&&(e.className="text-center mb-4 text-lg text-green-800 font-semibold",e.textContent=`Motoristas disponíveis agora: ${t.length}`)}const Ue={id:"customDataLabels",afterDraw(t,e,s){const{ctx:o,data:n}=t,r=n.datasets[0].data.reduce((u,i)=>u+i,0);if(r===0)return;const l=t.getDatasetMeta(0).data[0].x,c=t.getDatasetMeta(0).data[0].y;o.save(),o.font="bold 40px Poppins",o.fillStyle="white",o.textAlign="center",o.textBaseline="middle",o.fillText(String(r),l,c),o.restore()}};function Oe(t,e){const s=document.getElementById("driver-status-chart").getContext("2d");O&&O.destroy(),O=new Chart(s,{type:"doughnut",data:{labels:["Ativos","Inativos"],datasets:[{data:[t,e],backgroundColor:["#22c55e","#ef4444"],borderColor:"#374151",borderWidth:5,hoverBorderWidth:8}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"70%",plugins:{legend:{display:!1},tooltip:{enabled:!1}}},plugins:[Ue]})}function B(t){if(!t)return{text:"INDEFINIDO",colorClass:"status-canceled"};switch(t){case"pending_approval":return{text:"PEND. APROVAÇÃO",colorClass:"status-pending_approval"};case"approved":return{text:"APROVADA",colorClass:"status-approved"};case"rejected":return{text:"REJEITADA",colorClass:"status-rejected"};case"requested":return{text:"SOLICITADO",colorClass:"status-requested"};case"assigned":return{text:"DESIGNADO",colorClass:"status-assigned"};case"accepted":return{text:"ACEITO",colorClass:"status-accepted"};case"arrived_pickup":return{text:"NO EMBARQUE",colorClass:"status-arrived_pickup"};case"in_progress":return{text:"EM ANDAMENTO",colorClass:"status-in_progress"};case"completed":return{text:"FINALIZADA",colorClass:"status-completed"};case"canceled":return{text:"CANCELADA",colorClass:"status-canceled"};default:return{text:t.toUpperCase(),colorClass:""}}}function ie(){if(a.rides.length===0){d("Nenhuma corrida encontrada para exportar.",null,!1);return}const t=a.rides.map(r=>({"ID da Corrida":r.id,Usuário:r.userName,Empresa:r.userCompany,Destino:E(r.destination),Motorista:r.driverName||"N/A","Data da Solicitação":new Date(r.requestTime).toLocaleString("pt-BR"),"Data do Aceite":r.acceptTime?new Date(r.acceptTime).toLocaleString("pt-BR"):"N/A",Status:B(r.status).text})),e=new Date,s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,o=XLSX.utils.json_to_sheet(t),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,o,"Relatorio de Corridas"),XLSX.writeFile(n,`Relatorio_Diario_${s}.xlsx`)}function He(){const e=document.getElementById("icon-file-input").files[0];if(!e)return;const s=new FileReader;s.onload=function(o){a.appIcon=o.target.result,localStorage.setItem("appIcon",a.appIcon),G(),d("Ícone atualizado com sucesso!",null,!1)},s.readAsDataURL(e)}function G(){const t=document.getElementById("app-icon-container");if(t.innerHTML="",a.appIcon){const e=document.createElement("img");e.src=a.appIcon,e.className="h-12 w-12 object-contain",t.appendChild(e)}else{const e=document.getElementById("app-icon-container");if(e.innerHTML===""){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("class","h-12 w-12 text-black"),s.setAttribute("fill","currentColor"),s.setAttribute("viewBox","0 0 20 20"),s.innerHTML='<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />',e.appendChild(s)}}}function $(){const t=document.getElementById("user-ride-history");t.innerHTML="";const e=a.rides.filter(n=>n.userId===a.currentUserId);if(e.length===0){t.innerHTML='<p class="text-center text-gray-400">Nenhum histórico de corrida.</p>';return}const s=document.createElement("table");s.className="w-full text-sm text-left",s.innerHTML=`
        <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
            <tr>
                <th scope="col" class="px-4 py-3">Data</th>
                <th scope="col" class="px-4 py-3">Destino</th>
                <th scope="col" class="px-4 py-3">Status</th>
            </tr>
        </thead>`;const o=document.createElement("tbody");e.sort((n,r)=>new Date(r.requestTime).getTime()-new Date(n.requestTime).getTime()),e.forEach(n=>{const r=document.createElement("tr");r.className="border-b border-gray-700",r.innerHTML=`
            <td class="px-4 py-3">${new Date(n.requestTime).toLocaleDateString("pt-BR")}</td>
            <td class="px-4 py-3">${E(n.destination)}</td>
            <td class="px-4 py-3">${B(n.status).text}</td>
        `,o.appendChild(r)}),s.appendChild(o),t.appendChild(s)}function Xe(){const t=document.getElementById("driver-ride-history");t.innerHTML="";const e=a.rides.filter(n=>n.driverId===a.currentDriverId&&n.status==="completed");if(e.length===0){t.innerHTML='<p class="text-center text-gray-400">Nenhum histórico de corrida.</p>';return}const s=document.createElement("table");s.className="w-full text-sm text-left",s.innerHTML=`
        <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
            <tr>
                <th scope="col" class="px-4 py-3">Data</th>
                <th scope="col" class="px-4 py-3">Usuário</th>
                <th scope="col" class="px-4 py-3">Destino</th>
            </tr>
        </thead>`;const o=document.createElement("tbody");e.sort((n,r)=>new Date(r.requestTime).getTime()-new Date(n.requestTime).getTime()),e.forEach(n=>{const r=document.createElement("tr");r.className="border-b border-gray-700",r.innerHTML=`
            <td class="px-4 py-3">${new Date(n.requestTime).toLocaleDateString("pt-BR")}</td>
            <td class="px-4 py-3">${n.userName}</td>
            <td class="px-4 py-3">${E(n.destination)}</td>
        `,o.appendChild(r)}),s.appendChild(o),t.appendChild(s)}function Pe(){const t=a.rides.filter(n=>n.userId===a.currentUserId);if(t.length===0){d("Nenhum histórico de corrida para exportar.",null,!1);return}const e=t.map(n=>({"Data da Solicitação":new Date(n.requestTime).toLocaleString("pt-BR"),Destino:E(n.destination),Motorista:n.driverName||"N/A",Status:B(n.status).text})),s=XLSX.utils.json_to_sheet(e),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,s,"Minhas Corridas"),XLSX.writeFile(o,"meu_historico_corridas.xlsx")}function je(){const t=a.rides.filter(n=>n.driverId===a.currentDriverId&&n.status==="completed");if(t.length===0){d("Nenhum histórico de corrida para exportar.",null,!1);return}const e=t.map(n=>({"Data da Solicitação":new Date(n.requestTime).toLocaleString("pt-BR"),Usuário:n.userName,Empresa:n.userCompany,Destino:E(n.destination)})),s=XLSX.utils.json_to_sheet(e),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,s,"Minhas Corridas Concluídas"),XLSX.writeFile(o,"meu_historico_corridas_concluidas.xlsx")}function Fe(){h("admin-records-screen")}async function ze(){const t=document.getElementById("all-records-body");t.innerHTML='<tr><td colspan="9" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>';const{data:e,error:s}=await g.from("rides").select("*").order("requestTime",{ascending:!1});if(s){t.innerHTML='<tr><td colspan="9" class="text-center py-4 text-red-500">Erro ao carregar registros.</td></tr>';return}a.rides=e;const o=document.getElementById("records-company-filter");if(o&&(o.innerHTML='<option value="" class="text-gray-400">Todas as Empresas</option>',[...new Set(e.map(l=>l.userCompany||"-").filter(Boolean))].sort().forEach(l=>{l&&(o.innerHTML+=`<option value="${l}" class="text-white">${l}</option>`)})),e.length===0){t.innerHTML='<tr><td colspan="9" class="text-center py-4 text-gray-400">Nenhum registro encontrado.</td></tr>';return}const n=e.map(r=>{const l=r.km?r.km:"N/A",c=T(r.origin_address)||"-",u=E(r.destination),i=B(r.status),m=r.requestTime?new Date(r.requestTime).toLocaleString("pt-BR"):"N/A",p=r.observation||"-";return`
            <tr class="border-b border-gray-700 hover:bg-gray-800/20" data-request-time="${new Date(r.requestTime).getTime()}">
                <td class="px-4 py-3">${m}</td>
                <td class="px-4 py-3">${r.userName}</td>
                <td class="px-4 py-3">${r.userCompany||"-"}</td>
                <td class="px-4 py-3">${c}</td>
                <td class="px-4 py-3">${u}</td>
                <td class="px-4 py-3">${p}</td>
                <td class="px-4 py-3">${r.driverName||"-"}</td>
                <td class="px-4 py-3"><span class="status-badge ${i.colorClass}">${i.text}</span></td>
                <td class="px-4 py-3">${l}</td>
            </tr>
        `}).join("");t.innerHTML=n}function Ve(){const t=document.getElementById("records-start-date").value,e=document.getElementById("records-end-date").value,s=document.getElementById("records-company-filter").value,o=Array.from(document.getElementById("all-records-body").querySelectorAll("tr")),n=t?new Date(t).getTime():null,r=e?new Date(e).setHours(23,59,59,999):null;o.forEach(l=>{const c=l.dataset.requestTime,u=l.cells[2];if(c&&u){const i=parseInt(c,10);let m=!0;n&&i<n&&(m=!1),r&&i>r&&(m=!1);const p=u.textContent.trim();let f=s===""||p===s;l.style.display=m&&f?"":"none"}})}function Je(){const t=document.getElementById("all-records-table"),e=t.querySelectorAll("tbody tr"),s=[],o=Array.from(t.querySelectorAll("thead th")).map(c=>c.textContent.trim());s.push(o);let n=0;if(e.forEach(c=>{if(c.style.display!=="none"){const u=Array.from(c.querySelectorAll("td")).map(i=>i.querySelector(".status-badge")?i.querySelector(".status-badge").textContent.trim():i.textContent.trim());s.push(u),n++}}),n===0){d("Nenhum registro (visível) encontrado para exportar. Verifique seus filtros.",null,!1);return}const r=XLSX.utils.aoa_to_sheet(s),l=XLSX.utils.book_new();XLSX.utils.book_append_sheet(l,r,"Registros"),r["!cols"]=[{wch:20},{wch:25},{wch:20},{wch:40},{wch:40},{wch:30},{wch:25},{wch:15},{wch:15}],XLSX.writeFile(l,"relatorio_de_registros.xlsx")}function Ge(){document.getElementById("records-start-date").value="",document.getElementById("records-end-date").value="",document.getElementById("records-company-filter").value="",document.getElementById("all-records-body").querySelectorAll("tr").forEach(t=>{t.style.display=""})}async function We(t){if(!confirm("Tem certeza que deseja finalizar esta corrida?"))return;const e=a.rides.find(n=>n.id===t);let s=null;if(e&&e.origin_address&&e.destination)try{const n=J(e.destination),r=await V(e.origin_address,n);r!==null&&(s=parseFloat(r.toFixed(1)))}catch(n){console.error("Erro ao calcular distância final (admin):",n)}const{error:o}=await g.from("rides").update({status:"completed",km:s}).eq("id",t);alert(o?"Não foi possível finalizar a corrida.":"Corrida finalizada com sucesso!")}async function Ke(t){d("ATENÇÃO: Ação irreversível. Deseja realmente excluir esta corrida?",async()=>{const{error:s}=await g.from("rides").delete().eq("id",t);s?(console.error("Error deleting ride:",s),d(`Não foi possível excluir a corrida: ${s.message}`,null,!1)):d("Corrida excluída com sucesso!",null,!1)},!0)}async function Ye(){await k(),_e(),G();const t=localStorage.getItem("sessionType");if(t==="admin")h("admin-screen");else if(t==="user"){const e=localStorage.getItem("loggedInUserId");e&&a.users.some(s=>s.id==e)?(a.currentUserId=parseInt(e,10),h("user-screen")):j()}else if(t==="driver"){const e=localStorage.getItem("loggedInDriverId");if(e&&a.drivers.some(s=>s.id==e)){a.currentDriverId=parseInt(e,10);const s=a.drivers.find(o=>o.id===a.currentDriverId);document.getElementById("driver-name-display").textContent=`Bem-vindo, ${s.name}`,ae(),h("driver-screen")}else j()}else h("initial-screen")}function Ze(t,e,s){clearTimeout(W);const o=t.target.value;s&&(a[s]=!1),W=setTimeout(()=>{Qe(o,e,s)},300)}async function Qe(t,e,s){const o=document.getElementById(e);if(t.length<3){o.classList.remove("show");return}o.innerHTML='<div class="loading">Buscando...</div>',o.classList.add("show");try{const n=`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(t)}&apiKey=${S}&filter=countrycode:br&lang=pt`,l=await(await fetch(n)).json();l.features&&l.features.length>0?et(l.features,e,s):o.innerHTML='<div class="no-results">Nenhum resultado encontrado</div>'}catch(n){console.error("Erro na busca de endereço:",n),o.innerHTML='<div class="no-results">Erro na busca</div>'}}function et(t,e,s){const o=document.getElementById(e);o.innerHTML="",t.forEach(n=>{const r=document.createElement("div");r.className="autocomplete-item",r.innerHTML=n.properties.formatted.replace(new RegExp(o.previousElementSibling.value,"gi"),"<strong>$&</strong>"),r.onclick=()=>tt(n,e,s),o.appendChild(r)})}function tt(t,e,s){const o=document.getElementById(e.replace("List",""));o.value=t.properties.formatted,document.getElementById(e).classList.remove("show"),s&&(a[s]=!0),s==="isOriginSelected"?a.currentUserOrigin=t:s==="isDestinationSelected"&&(a.currentUserDestination=t)}async function nt(){const t=document.getElementById("heatmap-canvas");if(!t){console.error("Elemento do mapa não encontrado");return}x&&(x.remove(),x=null);const e=[-30.0346,-51.2177];try{x=L.map(t).setView(e,12),L.tileLayer(`https://maps.geoapify.com/v1/tile/dark-matter/{z}/{x}/{y}.png?apiKey=${S}`,{attribution:'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a>'}).addTo(x);const s=a.users.filter(r=>r.address&&r.address.trim()!=="").map(r=>H(r.address).catch(l=>(console.error(`Erro ao geocodificar ${r.address}:`,l),null))),n=(await Promise.all(s)).filter(r=>r).map(r=>[r.lat,r.lon]);if(n.length>0){U&&U.remove(),U=L.heatLayer(n,{radius:40,blur:20,maxZoom:18,gradient:{.4:"blue",.65:"lime",1:"red"}}).addTo(x);const r=L.latLngBounds(n);x.fitBounds(r)}else d("Não foi possível geocodificar os endereços dos usuários para gerar o mapa de calor",null,!1)}catch(s){console.error("Erro ao inicializar o mapa de calor:",s),d("Erro ao carregar o mapa de calor.",null,!1)}}document.addEventListener("click",function(t){t.target.closest(".autocomplete-container")||document.querySelectorAll(".autocomplete-list").forEach(s=>s.classList.remove("show"))});document.addEventListener("DOMContentLoaded",()=>{G(),Ye()});window.showScreen=h;window.logout=j;window.loginAdmin=ue;window.loginUser=me;window.promptToGoBack=ge;window.exportDailyReportNow=ie;window.addDriver=we;window.editDriver=Ee;window.promptDeleteDriver=Ie;window.toggleDriverStatusAdmin=Me;window.addUser=De;window.editUser=Se;window.promptDeleteUser=Le;window.downloadUserTemplate=be;window.importUsersFromExcel=Be;window.exportUsersToExcel=Ce;window.openRecordsTab=Fe;window.uploadAppIcon=He;window.requestRide=fe;window.cancelRide=ye;window.exportUserRidesToExcel=Pe;window.selectDriver=oe;window.toggleDriverStatus=qe;window.stopBeeping=b;window.exportDriverRidesToExcel=je;window.acceptRide=Ae;window.arriveAtPickup=ke;window.startTrip=Ne;window.completeRide=$e;window.filterRecords=Ve;window.clearRecordsFilter=Ge;window.exportRecordsToExcel=Je;window.updateRideDriver=ve;window.adminCompleteRide=We;window.adminDeleteRide=Ke;window.assignDriver=he;window.closeModal=I;window.handleAddressInput=Ze;
