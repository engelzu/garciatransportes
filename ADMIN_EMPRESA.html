<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA TRANSPORTES - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body, html { background-color: #000; }
        .main-gradient { background: linear-gradient(135deg, #000000, #000000); }
        .button-gradient { background: linear-gradient(to right, #000000, #000000); border: 2px solid white; position: relative; overflow: hidden; color: white !important; } /* Garante texto branco */
        .button-gradient::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.3), rgba(255,255,255,0)); transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .button-gradient:hover::before { transform: translateX(0); }
        .card-gradient { background: linear-gradient(135deg, #000000, #000000); border: 1px solid #4b5563; } /* Adiciona borda sutil */
        .screen { display: none; background-color: #000; }
        .screen.active { display: block; }
        .text-black, .text-gray-800, .text-gray-400, .text-gray-300, .text-gray-600, .text-gray-700, .text-gray-500, .text-green-300, .text-yellow-300 { color: #ffffff !important; }
        .text-cyan-400 { color: #00ffff !important; }
        h1, h2, h3, p, button, label, input::placeholder, textarea::placeholder, select, option { color: #ffffff !important; }
        input, select, textarea { background-color: #374151 !important; border-color: #4b5563 !important; color: white !important; /* Garante texto branco */}
        input:focus, select:focus, textarea:focus { border-color: #00ffff !important; ring: none !important; outline: none !important; box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.5) !important; } /* Foco ciano */
        
        /* --- MODIFICAÇÃO CHECKBOX --- */
        /* Garante que o checkbox use a cor ciano */
        input[type="checkbox"] {
            color: #00ffff !important;
            accent-color: #00ffff !important;
        }
        /* Garante que o input de endereço desabilitado fique legível */
        input:disabled, textarea:disabled {
             background-color: #4b5563 !important; /* Um pouco mais escuro/diferente */
             color: #9ca3af !important; /* Texto cinza claro */
             cursor: not-allowed;
        }
        /* --- FIM MODIFICAÇÃO CHECKBOX --- */

        #company-password-input { font-size: 14px; text-align: center; }
        #company-password-input::placeholder { text-align: center; }
        
        /* --- MODIFICAÇÃO: Layout tela cheia --- */
        #app-container { 
            position: relative;
            width: 100%;
            max-width: 100%; /* Remove a limitação de 'max-w-md' */
            padding-left: 1rem; /* Adiciona padding lateral */
            padding-right: 1rem; /* Adiciona padding lateral */
            margin: 0 auto;
        }
        /* Ajusta o container do formulário de login para não ficar gigante */
        #company-login-screen, #super-admin-login-screen {
            max-width: 28rem; /* 448px (md) */
            margin-left: auto;
            margin-right: auto;
        }
        /* Ajusta a tela de admin para não ficar colada nas bordas em telas menores */
        #admin-screen {
            max-width: 100%;
        }

        /* ESTILO PARA O AUTOCOMPLETE (CUSTOMIZADO, IGUAL AO 'mapa.html') */
        .autocomplete-container { /* Container para posicionamento */
            position: relative;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%; /* Posiciona abaixo do input */
            left: 0;
            right: 0;
            background: #374151; /* Fundo escuro do admin */
            border: 1px solid #4b5563; /* Borda do admin */
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem; /* rounded-lg */
            max-height: 200px; /* Altura máxima */
            overflow-y: auto;
            z-index: 1050; /* Sobrepor tudo */
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .autocomplete-list.show {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #4b5563; /* Separador escuro */
            color: white !important; /* Texto branco */
            transition: background-color 0.2s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #4b5563; /* Hover mais claro */
        }

        .autocomplete-item strong {
            color: #00ffff; /* Cor ciano de destaque */
        }

        .loading, .no-results {
            padding: 10px 12px;
            text-align: center;
            color: #9ca3af; /* Cinza claro */
            font-style: italic;
        }
        /* FIM DO ESTILO CUSTOMIZADO */

        /* MODAIS */
        #schedule-modal { display: none; }
        #schedule-modal.flex { display: flex; }
        #no-destination-modal { display: none; }
        #no-destination-modal.flex { display: flex; }
        
        /* ====================================================== */
        /* INÍCIO: ESTILOS DO NOVO MODAL */
        /* ====================================================== */
        #multi-schedule-modal { display: none; }
        #multi-schedule-modal.flex { display: flex; }
        
        /* Container para os inputs de data com scroll */
        #multi-schedule-date-list {
            max-height: 200px; /* Altura máxima antes de scrollar */
            overflow-y: auto; /* Scroll vertical */
            background-color: #1f2937; /* Fundo um pouco mais escuro */
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        /* Estilo para cada linha de data */
        .multi-schedule-date-item {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
            margin-bottom: 0.5rem; /* 8px */
        }
        .multi-schedule-date-item:last-child {
            margin-bottom: 0;
        }
        /* Botão de remover data */
        .remove-date-btn {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            border: none;
            border-radius: 9999px; /* rounded-full */
            width: 1.5rem; /* 24px */
            height: 1.5rem; /* 24px */
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Impede que o botão encolha */
        }
        .remove-date-btn:hover {
            background-color: #dc2626; /* bg-red-600 */
        }
        /* ====================================================== */
        /* FIM: ESTILOS DO NOVO MODAL */
        /* ====================================================== */


        /* --- CSS PARA ABAS --- */
        .tab-button { background-color: #374151; border: 1px solid #4b5563; padding: 10px 15px; cursor: pointer; transition: all 0.2s ease-in-out; border-radius: 8px; font-weight: 600; color: white !important; }
        .tab-button.active { background-color: #00ffff; color: #000 !important; border-color: #00ffff; }
        .admin-sub-screen { display: none; }
        .admin-sub-screen.active { display: block; }

        /* --- ESTILOS PARA A NOVA TABELA DE HISTÓRICO --- */
        #history-table {
            border-collapse: collapse; /* Garante que bordas fiquem limpas */
            width: 100%;
        }

        #history-table th,
        #history-table td {
            border: 1px solid #4b5563; /* Borda cinza escura */
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap; /* Impede quebra de linha, exceto onde eu forçar */
            font-size: 0.875rem; /* 14px */
            color: white;
        }

        #history-table th {
            background-color: #374151; /* Fundo cinza mais escuro para header */
            color: #e5e7eb; /* Texto do header */
        }

        /* Permite quebra de linha na coluna de destinos e observação */
	    #history-table td:nth-child(9), /* Coluna Destinos */
        #history-table td:nth-child(11) { /* Coluna Observação */
            white-space: normal;
            min-width: 250px; /* Largura mínima */
        }
        
        #history-table tbody tr:hover {
             background-color: #1f2937; /* Cor de hover na linha */
        }

    </style>
</head>
<body class="main-gradient text-white min-h-screen flex items-start justify-center p-4 pt-8">

    <div id="app-container" class="mx-auto">

        <div id="company-login-screen" class="screen active">
            <div id="admin-access-icon" title="Acesso Super Admin" onclick="showSuperAdminLogin()" style="position: absolute; top: 1rem; right: 1rem; cursor: pointer; padding: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>

            <h2 class="text-3xl font-bold mb-6 text-center">Login da Empresa</h2>
            <div class="mb-4"><label for="company-login-select" class="block mb-2 text-sm font-medium">Empresa</label><select id="company-login-select" class="w-full p-3 rounded-lg"></select></div>
            <div class="mb-4"><label for="admin-username-input" class="block mb-2 text-sm font-medium">Usuário Admin</label><input type="text" id="admin-username-input" class="w-full p-3 rounded-lg" placeholder="Digite seu usuário"></div>
            <div class="mb-4"><label for="admin-password-input" class="block mb-2 text-sm font-medium">Senha</label><input type="password" id="admin-password-input" class="w-full p-3 rounded-lg" placeholder="Digite sua senha"></div>
            <button onclick="verifyCompanyAdminPassword()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">ENTRAR</button>
            <p id="company-login-error" class="text-red-500 text-center mt-4 hidden">Usuário ou senha incorretos!</p>
            <p class="text-xs text-center text-gray-400 mt-4">
                Esqueceu a senha? Use o acesso Super Admin (ícone de escudo
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 align-text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                 no canto superior direito) para gerenciar as empresas.
            </p>
        </div>

        <div id="super-admin-login-screen" class="screen">
            <button onclick="showScreen('company-login-screen')" class="mb-4 text-cyan-400 hover:text-cyan-200">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Acesso Super Admin</h2>
            <div class="mb-4"><label for="super-admin-password-input" class="block mb-2 text-sm font-medium">Senha Mestra</label><input type="password" id="super-admin-password-input" class="w-full p-3 rounded-lg text-center" placeholder="Digite a senha mestra"></div>
            <button onclick="verifySuperAdminPassword()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">ENTRAR</button>
            <p id="super-admin-login-error" class="text-red-500 text-center mt-4 hidden">Senha mestra incorreta!</p>
        </div>

        <div id="admin-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <p id="admin-welcome-message" class="text-lg text-gray-300"></p>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 p-2 rounded-lg">Sair</button>
            </div>

            <div class="flex flex-wrap justify-center gap-2 mb-6">
                <button id="tab-request-ride" class="tab-button active" onclick="showAdminSubScreen('request-ride-screen')">Solicitar Corrida</button>
                <button id="tab-approve-ride" class="tab-button" onclick="showAdminSubScreen('approval-ride-screen')">Aprovar Solicitações</button>
                <button id="tab-history" class="tab-button" onclick="showAdminSubScreen('history-screen')">Histórico</button>
                <button id="tab-users" class="tab-button" onclick="showAdminSubScreen('user-management-screen')">Gerenciar Usuários</button>
                <button id="tab-motivos" class="tab-button" onclick="showAdminSubScreen('motivos-management-screen')">Gerenciar Motivos</button>
            </div>

            <div id="request-ride-screen" class="admin-sub-screen active">
                 <h2 class="text-2xl font-bold text-center mb-4">Solicitar Corrida</h2>
                <div id="admin-request-form" class="card-gradient p-6 rounded-lg max-w-2xl mx-auto">
                    <div class="mb-4">
                        <label for="motivo-select" class="block mb-2 text-sm font-medium">SELECIONE O MOTIVO DA SOLICITAÇÃO</label>
                        <select id="motivo-select" class="w-full p-3 rounded-lg">
                            <option value="">-- Selecione o Motivo --</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="passenger-quantity-select" class="block mb-2 text-sm font-medium">SELECIONE A QUANTIDADE DE PASSAGEIROS</label>
                        <select id="passenger-quantity-select" class="w-full p-3 rounded-lg">
                            <option value="">-- Quantidade --</option>
                            <option value="1">1 Passageiro</option>
                            <option value="2">2 Passageiros</option>
                            <option value="3">3 Passageiros</option>
                            <option value="4">4 Passageiros</option>
                        </select>
                    </div>
                    <div id="collaborators-container" class="space-y-4">
                        </div>
                    <div id="admin-ride-details" class="hidden">
                        <hr class="border-gray-600 my-6">
                        <h3 class="text-lg font-semibold mb-4 text-center">Detalhes da Viagem</h3>
                        <div class="mb-4">
                            <label for="admin-observation" class="block mb-2 text-sm font-medium">Observação</label>
                            <textarea id="admin-observation" class="w-full p-3 rounded-lg" placeholder="Ex: Ponto de referência..." rows="2"></textarea>
                        </div>
                        <div class="mt-6 space-y-3">
                            <button id="admin-request-immediate-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">SOLICITAR AGORA</button>
                            <button id="admin-request-scheduled-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">AGENDAR</button>
                            <button id="admin-request-multi-schedule-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg border-2 border-cyan-400">AGENDAR VÁRIOS DIAS</button>
                            </div>
                    </div>
                </div>
            </div>

            <div id="approval-ride-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Aprovar Solicitações Pendentes</h2>
                <div id="pending-rides-container" class="space-y-4 max-w-2xl mx-auto">
                    </div>
            </div>

            <div id="history-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Histórico de Corridas</h2>
                
                <div id="history-filters" class="card-gradient p-4 rounded-lg mb-4 space-y-3 max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label for="history-filter-start-date" class="block mb-1 text-xs font-medium">Data Inicial</label>
                            <input type="date" id="history-filter-start-date" class="w-full p-2 rounded-lg" style="color-scheme: dark;">
                        </div>
                        <div>
                            <label for="history-filter-end-date" class="block mb-1 text-xs font-medium">Data Final</label>
                            <input type="date" id="history-filter-end-date" class="w-full p-2 rounded-lg" style="color-scheme: dark;">
                        </div>
                        <div>
                            <label for="history-filter-type" class="block mb-1 text-xs font-medium">Tipo</label>
                            <select id="history-filter-type" class="w-full p-2 rounded-lg">
                                <option value="">-- Todos os Tipos --</option>
                                <option value="immediate">Imediato</option>
                                <option value="scheduled">Agendado</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="history-filter-status" class="block mb-1 text-xs font-medium">Status</label>
                        <select id="history-filter-status" class="w-full p-2 rounded-lg">
                            <option value="">-- Todos os Status --</option>
                            </select>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="applyHistoryFilter()" class="flex-grow py-2 px-4 font-semibold rounded-lg bg-cyan-600 hover:bg-cyan-700">Filtrar</button>
                        <button onclick="clearHistoryFilter()" class="flex-grow py-2 px-4 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700">Limpar</button>
                    </div>
                    <button onclick="exportHistoryToExcel('history-table', 'historico_corridas')" class="w-full py-2 px-4 font-semibold rounded-lg button-gradient mt-2">Exportar para Excel</button>
                    
                    <p id="history-filter-display" class="text-center text-xs text-gray-400 h-4"></p>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-700">
                    <table id="history-table" class="w-full min-w-[1200px]" style="display: none;"> <thead class="bg-gray-800">
                            <tr>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Solicitante</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Motivo</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Data Solicitação</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Data Agendada</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Data Aceite</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Origem</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Destinos</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Passag.</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Motorista</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Observação</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Admin Solicitante</th>
                                <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-gray-900 divide-y divide-gray-700">
                            </tbody>
                    </table>
                </div>
                <div id="history-rides-container">
                    </div>
            </div>
            <div id="user-management-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Gerenciar Usuários</h2>
                <div class="max-w-2xl mx-auto">
                    <div class="card-gradient p-4 rounded-lg mb-6">
                        <h3 id="user-form-title" class="text-lg font-semibold mb-2">Adicionar Usuário</h3>
                        <input type="hidden" id="editing-user-id">
                        <div class="space-y-2">
                            <input type="text" id="new-user-matricula" placeholder="Matrícula" class="w-full p-2 rounded-lg">
                            <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-2 rounded-lg">
                            
                            <div class="autocomplete-container">
                                <input type="text" id="new-user-address" placeholder="Endereço" class="w-full p-2 rounded-lg"
                                        oninput="handleAddressInput(event, 'new-user-addressList')">
                                <input type="hidden" id="new-user-address-validated">
                                <div class="autocomplete-list" id="new-user-addressList"></div>
                            </div>
                            
                            <input type="tel" id="new-user-phone" placeholder="Telefone" class="w-full p-2 rounded-lg">
                            <input type="text" id="new-user-password" placeholder="Senha" class="w-full p-2 rounded-lg">
                        </div>
                        <button onclick="addOrUpdateUser()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700 mt-3">Salvar</button>
                        <button id="cancel-user-edit-btn" onclick="cancelUserEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                    </div>
                    <div id="user-list-container" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                        </div>
                </div>
            </div>

            <div id="motivos-management-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Gerenciar Motivos</h2>
                <div class="max-w-2xl mx-auto">
                    <div class="card-gradient p-4 rounded-lg mb-6">
                        <h3 id="motivo-form-title" class="text-lg font-semibold mb-2">Adicionar Motivo</h3>
                        <input type="hidden" id="editing-motivo-id">
                        <div class="space-y-2">
                            <input type="text" id="new-motivo-name" placeholder="Nome do Motivo (Ex: Reunião, Entrega de Documentos)" class="w-full p-2 rounded-lg">
                        </div>
                        <button onclick="addOrUpdateMotivo()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700 mt-3">Salvar</button>
                        <button id="cancel-motivo-edit-btn" onclick="cancelMotivoEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                    </div>
                    <div id="motivo-list-container" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                    </div>
                </div>
            </div>
        </div>

        <div id="company-management-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Gerenciar Empresas</h2>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 p-2 rounded-lg">Sair</button>
            </div>
            <div class="max-w-2xl mx-auto">
                <div class="card-gradient p-4 rounded-lg mb-6">
                    <h3 id="company-form-title" class="text-lg font-semibold mb-2">Adicionar Empresa</h3>
                    <input type="hidden" id="editing-company-id">
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-company-name" placeholder="Nome da Empresa" class="w-full p-2 rounded-lg">
                    </div>
                    <button onclick="addOrUpdateCompany()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700">Salvar</button>
                    <button id="cancel-edit-btn" onclick="cancelEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                </div>
                <div id="company-list-container" class="space-y-3">
                    </div>
            </div>
        </div>

        <div id="admin-management-screen" class="screen">
             </div>
        </div>

    <div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"> <div class="card-gradient p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4">Agendar Corrida</h3>
            <div class="mb-4 text-left">
                <label for="schedule-date" class="block mb-2 text-sm font-medium">Data</label>
                <input type="date" id="schedule-date" class="w-full p-3 rounded-lg" style="color-scheme: dark;"> </div>
            <div class="mb-6 text-left">
                <label for="schedule-time" class="block mb-2 text-sm font-medium">Hora</label>
                <input type="time" id="schedule-time" class="w-full p-3 rounded-lg" style="color-scheme: dark;"> </div>
            <div class="flex justify-center gap-4">
                <button onclick="closeScheduleModal()" class="py-2 px-6 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button onclick="confirmAdminSchedule()" class="py-2 px-8 font-semibold rounded-lg button-gradient">AGENDAR</button>
            </div>
        </div>
    </div>

    <div id="multi-schedule-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-center">Agendar Vários Dias</h3>
            
            <div class="mb-4 text-left">
                <label for="multi-schedule-time" class="block mb-2 text-sm font-medium">Horário (para todos os dias)</label>
                <input type="time" id="multi-schedule-time" class="w-full p-3 rounded-lg" style="color-scheme: dark;">
            </div>

            <div class="mb-4 text-left">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium">Datas</label>
                    <button onclick="addDateToMultiSchedule()" class="py-1 px-3 text-sm font-semibold rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white">+ Adicionar Data</button>
                </div>
                <div id="multi-schedule-date-list">
                    <p id="multi-schedule-placeholder" class="text-center text-gray-400 p-4">Clique em "+ Adicionar Data" para começar.</p>
                </div>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button onclick="closeMultiScheduleModal()" class="py-2 px-6 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button onclick="confirmAdminMultiSchedule()" class="py-2 px-8 font-semibold rounded-lg button-gradient">AGENDAR TODOS</button>
            </div>
        </div>
    </div>
    <div id="no-destination-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Confirmar Solicitação</h3>
            <p class="text-lg mb-6">NÃO TERÁ DESTINO FINAL?</p>
            <div class="flex justify-center gap-4">
                <button id="no-destination-btn-no" class="py-2 px-8 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">NÃO</button>
                <button id="no-destination-btn-yes" class="py-2 px-8 font-semibold rounded-lg button-gradient">SIM</button>
            </div>
        </div>
    </div>
    

    <script>
        // ========================================================================
        // NOVA CONSTANTE - CHAVE DA API GEOAPIFY
        // ========================================================================
        const GEOAPIFY_API_KEY = '9452fa947c234c90b794bf2d1b8c5eb4';

        const SUPABASE_URL = 'https://jowsbmuqbzxukbbxbeqv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let state = { loggedInCompany: null, loggedInAdmin: null, allUsers: [] };
        let adminSelectedRequestType = '';
        let adminScheduledDateTime = null;
        let companyUsersCache = [];
        let currentManagingCompany = { id: null, name: null };
        let debounceTimer; // Adicionado para o autocomplete manual
        
        // ========================================================================
        // INÍCIO: NOVA VARIÁVEL GLOBAL
        // ========================================================================
        let tempMultiScheduleRideData = null; // Armazena os dados da corrida para o modal de multi-agendamento
        // ========================================================================
        // FIM: NOVA VARIÁVEL GLOBAL
        // ========================================================================


        // ========================================================================
        // NOVAS FUNÇÕES (do mapa.html) - LÓGICA DE AUTOCOMPLETE MANUAL
        // ========================================================================
        
        // ========================================================================
        // FUNÇÃO MODIFICADA - handleAddressInput
        // ========================================================================
        function handleAddressInput(event, listId) {
            // --- MODIFICAÇÃO ---
            // Se o input for o 'new-user-address' (tela de Gerenciar Usuários),
            // limpa o valor validado. Isso força o usuário a *selecionar* da lista.
            if (event.target.id === 'new-user-address') {
                const hiddenInput = document.getElementById('new-user-address-validated');
                if (hiddenInput) {
                    hiddenInput.value = ''; // Limpa o valor validado
                }
            }
            // --- FIM MODIFICAÇÃO ---

            clearTimeout(debounceTimer);
            const query = event.target.value;
            debounceTimer = setTimeout(() => {
                searchAddress(query, listId);
            }, 300); // 300ms de debounce
        }

        async function searchAddress(query, listId) {
            if (query.length < 3) {
                hideList(listId);
                return;
            }

            const list = document.getElementById(listId);
            if (!list) return; // Segurança
            list.innerHTML = '<div class="loading">Buscando...</div>';
            list.classList.add('show');

            try {
                // Usa a chave API já definida
                // ========================================================================
                // CORREÇÃO DO ERRO
                // ========================================================================
                const response = await fetch(
                    `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&lang=pt&limit=5&apiKey=${GEOAPIFY_API_KEY}`
                );
                // ========================================================================
                // FIM DA CORREÇÃO
                // ========================================================================
                
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    displayResults(data.features, listId);
                } else {
                    list.innerHTML = '<div class="no-results">Nenhum resultado encontrado</div>';
                }
            } catch (error) {
                console.error('Erro ao buscar endereços:', error);
                list.innerHTML = '<div class="no-results">Erro ao buscar endereços</div>';
            }
        }

        function displayResults(features, listId) {
            const list = document.getElementById(listId);
            if (!list) return; // Segurança
            list.innerHTML = '';

            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                
                const formatted = feature.properties.formatted;
                const city = feature.properties.city || '';
                const state = feature.properties.state || '';
                
                item.innerHTML = `
                    <strong>${formatted}</strong>
                    ${city || state ? `<br><small style="color: #999;">${city}${city && state ? ', ' : ''}${state}</small>` : ''}
                `;
                
                // Modificado para chamar a nova 'selectAddress'
                item.onclick = () => selectAddress(feature, listId);
                list.appendChild(item);
            });

            list.classList.add('show');
        }

        // ========================================================================
        // FUNÇÃO MODIFICADA - selectAddress
        // ========================================================================
        function selectAddress(feature, listId) {
            const inputId = listId.replace('List', ''); // Ex: 'address-input-0List' -> 'address-input-0'
            const input = document.getElementById(inputId);
            const formattedAddress = feature.properties.formatted; // Endereço formatado
            
            if (input) {
                input.value = formattedAddress; // Apenas preenche o input
            }

            // --- MODIFICAÇÃO ---
            // Se for o input de 'new-user-address' (Gerenciar Usuários), 
            // salva o valor validado no input oculto.
            if (inputId === 'new-user-address') {
                const hiddenInput = document.getElementById('new-user-address-validated');
                if (hiddenInput) {
                    hiddenInput.value = formattedAddress; // Salva o valor exato no input escondido
                }
            }
            // --- FIM MODIFICAÇÃO ---

            hideList(listId); // Esconde a lista
        }

        function hideList(listId) {
            const list = document.getElementById(listId);
            if (list) {
                list.classList.remove('show');
            }
        }

        // Fechar listas ao clicar fora (copiado do mapa.html)
        document.addEventListener('click', function(e) {
            // Se o clique NÃO for dentro de um container de autocomplete
            if (!e.target.closest('.autocomplete-container')) {
                // Esconde todas as listas de autocomplete
                document.querySelectorAll('.autocomplete-list').forEach(list => list.classList.remove('show'));
            }
        });
        // ========================================================================
        // FIM DAS NOVAS FUNÇÕES
        // ========================================================================


        // ========================================================================
        // FUNÇÃO ATUALIZADA - parseDestinations (Lida com o novo formato JSON)
        // ========================================================================
        function parseDestinations(destinationString) {
            if (!destinationString || typeof destinationString !== 'string') {
                console.warn("parseDestinations: Input inválido ou vazio:", destinationString);
                return [];
            }
            const str = destinationString.trim();

            // 1. Tenta interpretar como um array JSON formal (ex: ["addr1", "addr2"] ou [{"name": "n", "address": "a"}, ...])
            if (str.startsWith('[') && str.endsWith(']')) {
                try {
                    const parsed = JSON.parse(str);
                    if (Array.isArray(parsed)) {
                        // Se for array de objetos {name, address}, retorna direto
                        if (parsed.length > 0 && typeof parsed[0] === 'object' && parsed[0] !== null && 'address' in parsed[0]) {
                           return parsed.filter(d => d.address); // Retorna objetos válidos
                        }
                        // Senão, trata como array de strings e converte para o formato {name, address}
                         return parsed.map((addr, index) => ({
                             name: index === parsed.length - 1 ? 'Destino Final' : `Parada ${index + 1}`,
                             address: String(addr || '').trim()
                         })).filter(d => d.address); // Filtra endereços vazios
                    }
                } catch (e) {
                    console.warn('parseDestinations: Não foi possível interpretar como JSON, tentando extração manual.', str, e);
                    // 2. Método Alternativo: Se JSON.parse falhar, extrai manualmente.
                    const content = str.substring(1, str.length - 1);
                    const parts = content.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                    if (parts.length > 0) {
                        // Converte para o formato {name, address}
                        return parts.map((part, index) => ({
                             name: index === parts.length - 1 ? 'Destino Final' : `Parada ${index + 1}`,
                             address: part.replace(/^"|"$/g, '').trim()
                        })).filter(d => d.address);
                    }
                }
            }

            // 3. Fallback: Trata como um único destino e converte para o formato {name, address}
             const cleanedAddr = str.replace(/^"|"$/g, '').trim();
             if (cleanedAddr) {
                 return [{ name: 'Destino', address: cleanedAddr }];
             } else {
                 return [];
             }
        }


        function resetAdminForm() {
            const passengerSelect = document.getElementById('passenger-quantity-select');
             if (passengerSelect) passengerSelect.value = '';
            const collaboratorsContainer = document.getElementById('collaborators-container');
             if (collaboratorsContainer) collaboratorsContainer.innerHTML = '';
            const rideDetails = document.getElementById('admin-ride-details');
             if (rideDetails) rideDetails.classList.add('hidden');
            const observationInput = document.getElementById('admin-observation');
             if (observationInput) observationInput.value = '';
            // Reseta também o select de motivos
            const motivoSelect = document.getElementById('motivo-select');
            if (motivoSelect) motivoSelect.value = '';
        }


        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        }

        function logout() {
            state.loggedInCompany = null;
            state.loggedInAdmin = null;
            document.getElementById('admin-username-input').value = '';
            document.getElementById('admin-password-input').value = '';
            document.getElementById('super-admin-password-input').value = '';
            resetAdminForm(); // Limpa o formulário de solicitação
            showScreen('company-login-screen');
        }

        function showSuperAdminLogin() {
            showScreen('super-admin-login-screen');
        }

        async function verifySuperAdminPassword() {
            const passwordInput = document.getElementById('super-admin-password-input');
            const password = passwordInput.value;
            const errorEl = document.getElementById('super-admin-login-error');
            errorEl.classList.add('hidden');

            if (password === '789512') { // SENHA MESTRA - MANTENHA SECRETA
                state.loggedInCompany = { name: "Super Admin" }; // Objeto genérico
                state.loggedInAdmin = { username: "Super Admin" }; // Objeto genérico
                await loadCompanyManagement(); // Carrega a tela de gerenciar empresas
                showScreen('company-management-screen');
                passwordInput.value = ''; // Limpa o campo
            } else {
                errorEl.classList.remove('hidden');
            }
        }

        async function verifyCompanyAdminPassword() {
            const companyName = document.getElementById('company-login-select').value;
            const username = document.getElementById('admin-username-input').value.trim();
            const password = document.getElementById('admin-password-input').value.trim();
            const errorEl = document.getElementById('company-login-error');
            errorEl.classList.add('hidden');

            if (!companyName || !username || !password) {
                errorEl.textContent = 'Preencha todos os campos.';
                errorEl.classList.remove('hidden');
                return;
            }

            // 1. Busca a empresa pelo nome
            const { data: company, error: companyError } = await supabaseClient
                .from('companies')
                .select('id, name')
                .eq('name', companyName)
                .single();

            if (companyError || !company) {
                errorEl.textContent = 'Empresa não encontrada.';
                errorEl.classList.remove('hidden');
                console.error("Login Error: Company not found", companyError);
                return;
            }

            // 2. Busca o admin pelo company_id, username e password
            const { data: admin, error: adminError } = await supabaseClient
                .from('company_admins')
                .select('*')
                .eq('company_id', company.id)
                .eq('username', username)
                .eq('password', password) // Comparação direta de senha (não ideal para produção)
                .single();

            if (adminError || !admin) {
                errorEl.textContent = 'Usuário ou senha incorretos.';
                errorEl.classList.remove('hidden');
                 console.error("Login Error: Admin not found or credentials mismatch", adminError);
            } else {
                // Login bem-sucedido
                state.loggedInCompany = company;
                state.loggedInAdmin = admin;
                await setupAdminScreen(); // Prepara a tela do admin logado
                showScreen('admin-screen'); // Mostra a tela do admin
                showAdminSubScreen('request-ride-screen'); // Mostra a primeira aba
                // Limpa campos de login
                document.getElementById('admin-username-input').value = '';
                document.getElementById('admin-password-input').value = '';
            }
        }

        async function refreshAllUsers() {
            const { data: users, error: usersError } = await supabaseClient
                .from('users')
                .select('id, name, company, address'); // Pega só os campos necessários

            if (usersError) {
                console.error("Erro ao recarregar todos os usuários:", usersError);
                state.allUsers = []; // Limpa em caso de erro
                return;
            }
            state.allUsers = users || []; // Garante que seja um array
        }
        
        // ========================================================================
        // INÍCIO: FUNÇÃO (Carregar Motivos no Select) - CORRIGIDA
        // ========================================================================
        async function populateMotivosSelect() {
            const select = document.getElementById('motivo-select');
            if (!select) return;

            // ======================================================
            // CORREÇÃO (Usa ID da empresa e coluna 'empresa_id')
            // ======================================================
            if (!state.loggedInCompany || !state.loggedInCompany.id) return; // Precisa do ID

            const { data, error } = await supabaseClient
                .from('motivos')
                .select('id, nome') // 'nome' é a coluna da sua tabela
                .eq('empresa_id', state.loggedInCompany.id) // Compara 'empresa_id' com o ID da empresa logada
                .order('nome'); // Ordena por 'nome'
            // ======================================================
            // FIM DA CORREÇÃO
            // ======================================================

            if (error) {
                console.error("Erro ao carregar motivos para select:", error);
                select.innerHTML = '<option value="">Erro ao carregar motivos</option>';
                return;
            }
            
            select.innerHTML = '<option value="">-- Selecione o Motivo --</option>'; // Reset
            if (data) {
                data.forEach(motivo => {
                    select.innerHTML += `<option value="${motivo.id}">${motivo.nome}</option>`; // Usa 'motivo.nome'
                });
            }
        }
        // ========================================================================
        // FIM: FUNÇÃO
        // ========================================================================


        async function setupAdminScreen() {
            document.getElementById('admin-welcome-message').textContent = `Bem-vindo, Admin (${state.loggedInCompany.name})`;
            resetAdminForm();

            await refreshAllUsers(); // Carrega todos os usuários para o seletor
            await populateMotivosSelect(); // <<== ADICIONADO: Carrega os motivos

            // Configura o listener para a quantidade de passageiros
            const passengerSelect = document.getElementById('passenger-quantity-select');
            // Remove listener antigo para evitar duplicação
            passengerSelect.removeEventListener('change', handlePassengerQuantityChange);
            passengerSelect.addEventListener('change', handlePassengerQuantityChange);

             // Define a aba inicial como ativa
             document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
             document.getElementById('tab-request-ride').classList.add('active');
             document.querySelectorAll('.admin-sub-screen').forEach(scr => scr.classList.remove('active'));
             document.getElementById('request-ride-screen').classList.add('active');
        }

        // ========================================================================
        // FUNÇÃO MODIFICADA - handlePassengerQuantityChange (Adiciona Checkbox)
        // ========================================================================
        function handlePassengerQuantityChange(event) {
            const quantity = parseInt(event.target.value, 10);
            const container = document.getElementById('collaborators-container');
            const rideDetails = document.getElementById('admin-ride-details');
            container.innerHTML = ''; // Limpa container

            if (isNaN(quantity) || quantity < 1) {
                rideDetails.classList.add('hidden'); // Esconde detalhes se inválido
                return;
            }

            rideDetails.classList.remove('hidden'); // Mostra detalhes

            // Filtra usuários da empresa logada e ordena por nome
            const companyUsers = state.allUsers
                .filter(user => user.company === state.loggedInCompany.name)
                .sort((a, b) => a.name.localeCompare(b.name));

            const optionsHtml = companyUsers.map(user => `<option value="${user.id}">${user.name}</option>`).join('');

            // Cria HTML para os inputs
            let inputsHtml = '';
            for (let i = 0; i < quantity; i++) {
                inputsHtml += `
                    <div class="border border-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-md mb-2">Origem (Passageiro ${i + 1})</p>
                        <div class="mb-2">
                            <label for="collaborator-select-${i}" class="block mb-1 text-xs font-medium">Colaborador</label>
                            <select id="collaborator-select-${i}" data-index="${i}" class="w-full p-2 rounded-lg collaborator-selector">
                                <option value="">-- Selecione --</option>
                                ${optionsHtml}
                            </select>
                        </div>
                        
                        <div class="flex justify-between items-center mb-1 mt-3">
                            <label for="address-input-${i}" class="block text-xs font-medium">Endereço</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="use-collab-address-${i}" data-index="${i}" class="use-collab-address-cb w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500">
                                <label for="use-collab-address-${i}" class="ml-2 text-xs font-medium text-gray-300" style="color: #e5e7eb !important;">USAR ENDEREÇO DO COLABORADOR</label>
                            </div>
                        </div>
                        <div class="autocomplete-container">
                            <input type="text" id="address-input-${i}" class="w-full p-2 rounded-lg" placeholder="Endereço autocompletado ou manual"
                                   oninput="handleAddressInput(event, 'address-input-${i}List')">
                            <div class="autocomplete-list" id="address-input-${i}List"></div>
                        </div>
                    </div>
                `;
            }

            // ======================================================
            // INÍCIO DA ALTERAÇÃO SOLICITADA
            // ======================================================
            inputsHtml += `
                <div class="border border-cyan-400 p-3 rounded-lg mt-4">
                    <p class="font-semibold text-md mb-2 text-cyan-400">Destino Final</p>
                    
                    <div class="mb-2">
                        <label for="collaborator-select-destination" class="block mb-1 text-xs font-medium">Colaborador (Opcional)</label>
                        <select id="collaborator-select-destination" data-index="destination" class="w-full p-2 rounded-lg collaborator-selector">
                            <option value="">-- Selecione --</option>
                            ${optionsHtml}
                        </select>
                    </div>
                    
                    <div class="flex justify-between items-center mb-1 mt-3">
                        <label for="address-input-destination" class="block text-xs font-medium">Endereço de Destino</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="use-collab-address-destination" data-index="destination" class="use-collab-address-cb w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500">
                            <label for="use-collab-address-destination" class="ml-2 text-xs font-medium text-gray-300" style="color: #e5e7eb !important;">USAR ENDEREÇO DO COLABORADOR</label>
                        </div>
                    </div>
                    <div class="autocomplete-container">
                        <input type="text" id="address-input-destination" class="w-full p-2 rounded-lg" placeholder="Digite o endereço de destino da viagem"
                               oninput="handleAddressInput(event, 'address-input-destinationList')">
                        <div class="autocomplete-list" id="address-input-destinationList"></div>
                    </div>
                </div>
            `;
            // ======================================================
            // FIM DA ALTERAÇÃO SOLICITADA
            // ======================================================

            // Adiciona o HTML ao container de uma vez
            container.innerHTML = inputsHtml;

            // ---- MODIFICAÇÃO ----
            // Adiciona listener para autocompletar endereço ao selecionar colaborador
             document.querySelectorAll('.collaborator-selector').forEach(select => {
                // Remove listener antigo para evitar duplicatas
                select.removeEventListener('change', handleCollaboratorSelection);
                select.addEventListener('change', handleCollaboratorSelection);
             });
             
            // ======================================================
            // INÍCIO: MODIFICAÇÃO SOLICITADA (LISTENER DO CHECKBOX)
            // ======================================================
            document.querySelectorAll('.use-collab-address-cb').forEach(checkbox => {
                checkbox.removeEventListener('change', handleUseCollaboratorAddress); // Evita duplicatas
                checkbox.addEventListener('change', handleUseCollaboratorAddress);
            });
            // ======================================================
            // FIM: MODIFICAÇÃO SOLICITADA
            // ======================================================
        }


        // ========================================================================
        // FUNÇÃO MODIFICADA - handleCollaboratorSelection (Respeita o Checkbox)
        // ========================================================================
        function handleCollaboratorSelection(event) {
            const selectedUserId = event.target.value;
            const index = event.target.dataset.index; // Pega o índice do input (0, 1, 2... ou 'destination')
            const addressInput = document.getElementById(`address-input-${index}`);
            const checkbox = document.getElementById(`use-collab-address-${index}`); // Pega o checkbox

            let selectedUserAddress = ''; // Guarda o endereço para reuso

            if (selectedUserId) {
                const selectedUser = state.allUsers.find(user => user.id == selectedUserId);
                // Apenas busca o endereço, não o aplica ainda
                selectedUserAddress = (selectedUser && selectedUser.address) ? selectedUser.address : '';
                
                // ======================================================
                // INÍCIO DA MODIFICAÇÃO SOLICITADA
                // ======================================================
                
                // Verifica se o checkbox JÁ ESTÁ MARCADO
                if (checkbox && checkbox.checked) {
                    // Se sim, atualiza o campo com o endereço do NOVO colaborador
                    addressInput.value = selectedUserAddress;
                    addressInput.disabled = true; // Garante que continue travado
                } else {
                    // Se não estiver marcado, garanta que está habilitado
                    // Não preenchemos nem limpamos o campo, deixamos como está para o usuário digitar.
                    addressInput.disabled = false;
                }
                // ======================================================
                // FIM DA MODIFICAÇÃO SOLICITADA
                // ======================================================

            } else {
                // Se desmarcou o colaborador (selecionou "-- Selecione --")
                addressInput.value = ''; // Limpa o endereço
                addressInput.disabled = false; // Garante que está habilitado
                if (checkbox) {
                    checkbox.checked = false; // Desmarca o checkbox também
                }
                selectedUserAddress = ''; // Garante que está vazio para a lógica abaixo
            }

            // --- Lógica existente (sem alteração) ---
            // Verifica se este é o último passageiro
            const totalPassengers = parseInt(document.getElementById('passenger-quantity-select').value, 10);
            const lastPassengerIndex = totalPassengers - 1;

            // ======================================================
            // INÍCIO DA MODIFICAÇÃO SOLICITADA
            // ======================================================
            // Se o índice do seletor que mudou for igual ao índice do último passageiro...
            if (parseInt(index, 10) === lastPassengerIndex) { // parseInt('destination') vira NaN, o que é seguro aqui
                const destinationInput = document.getElementById('address-input-destination');
                if (destinationInput) {
                    // ...NÃO FAZ NADA. Deixa o campo em branco para o usuário.
                    // destinationInput.value = selectedUserAddress; // <-- LINHA REMOVIDA
                }
            }
            // ======================================================
            // FIM DA MODIFICAÇÃO SOLICITADA
            // ======================================================
        }
        
        // ========================================================================
        // INÍCIO: NOVA FUNÇÃO (Lógica do Checkbox)
        // ========================================================================
        function handleUseCollaboratorAddress(event) {
            const checkbox = event.target;
            const index = checkbox.dataset.index;
            const addressInput = document.getElementById(`address-input-${index}`);
            const collaboratorSelect = document.getElementById(`collaborator-select-${index}`);

            if (!addressInput || !collaboratorSelect) return; // Segurança

            const selectedUserId = collaboratorSelect.value;

            if (checkbox.checked) {
                // Se marcou o checkbox
                if (!selectedUserId) {
                    // Se não tiver colaborador, apenas desmarca o checkbox
                    // (Evita alerts que travam a UI)
                    console.warn("Selecione um colaborador primeiro.");
                    checkbox.checked = false;
                    return;
                }

                const selectedUser = state.allUsers.find(user => user.id == selectedUserId);
                if (selectedUser) {
                    addressInput.value = selectedUser.address || ''; // Garante o endereço correto
                    addressInput.disabled = true; // Trava o campo
                    hideList(`address-input-${index}List`); // Esconde autocomplete se estiver aberto
                } else {
                    checkbox.checked = false; // Colaborador não encontrado (não deve acontecer)
                }
            } else {
                // Se desmarcou o checkbox
                addressInput.disabled = false; // Destrava o campo
                // ======================================================
                // INÍCIO DA MODIFICAÇÃO SOLICITADA
                // ======================================================
                addressInput.value = ''; // Limpa o campo para o usuário digitar
                // ======================================================
                // FIM DA MODIFICAÇÃO SOLICITADA
                // ======================================================
            }
        }
        // ========================================================================
        // FIM: NOVA FUNÇÃO
        // ========================================================================

        // ========================================================================
        // INÍCIO: NOVAS FUNÇÕES (Modal Destino Final)
        // ========================================================================
        function openNoDestinationModal() {
            document.getElementById('no-destination-modal').classList.add('flex');
        }
        function closeNoDestinationModal() {
            document.getElementById('no-destination-modal').classList.remove('flex');
        }
        // ========================================================================
        // FIM: NOVAS FUNÇÕES
        // ========================================================================


        // --- Funções openAdminScheduleModal, closeScheduleModal, confirmAdminSchedule --- (sem alterações)
         function openAdminScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            const today = new Date();
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');

            // Define o mínimo como hoje
             dateInput.min = today.toISOString().split('T')[0];
            // Define o valor padrão como hoje
             dateInput.value = today.toISOString().split('T')[0];
            // Define a hora padrão como a hora atual
             timeInput.value = today.toTimeString().slice(0, 5);

            modal.classList.add('flex'); // Mostra o modal
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('flex'); // Esconde o modal
        }

        function confirmAdminSchedule() {
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            if (!dateInput.value || !timeInput.value) { return alert('Por favor, selecione data e hora.'); }

            const scheduledDate = new Date(`${dateInput.value}T${timeInput.value}`);

            // Validação de data no passado
             const now = new Date();
             // Compara apenas a data e hora, ignorando segundos/milissegundos
             const scheduledMinutes = Math.floor(scheduledDate.getTime() / 60000);
             const nowMinutes = Math.floor(now.getTime() / 60000);

             if (scheduledMinutes < nowMinutes) {
                return alert("A data e hora do agendamento não podem ser no passado.");
            }


            adminScheduledDateTime = scheduledDate.toISOString();
            // adminSelectedRequestType = 'scheduled'; // <-- Movido

            closeScheduleModal();
            // adminRequestRide(); // <-- Chamada antiga
            validateAndInitiateRide('scheduled'); // <-- NOVA CHAMADA
        }
        
        // ========================================================================
        // INÍCIO: NOVAS FUNÇÕES (Agendamento Múltiplo)
        // ========================================================================
        
        function openMultiScheduleModal() {
            const modal = document.getElementById('multi-schedule-modal');
            const timeInput = document.getElementById('multi-schedule-time');
            const dateList = document.getElementById('multi-schedule-date-list');
            const placeholder = document.getElementById('multi-schedule-placeholder');
            
            // Limpa a lista de datas
            dateList.innerHTML = '';
            placeholder.style.display = 'block'; // Mostra o placeholder
            dateList.appendChild(placeholder);
            
            // Define a hora padrão
            timeInput.value = new Date().toTimeString().slice(0, 5);
            
            modal.classList.add('flex');
        }
        
        function closeMultiScheduleModal() {
            document.getElementById('multi-schedule-modal').classList.remove('flex');
            tempMultiScheduleRideData = null; // Limpa os dados temporários ao fechar/cancelar
        }

        function addDateToMultiSchedule() {
            const dateList = document.getElementById('multi-schedule-date-list');
            const placeholder = document.getElementById('multi-schedule-placeholder');
            
            // Esconde o placeholder se ele existir
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            const today = new Date().toISOString().split('T')[0];

            // Cria o wrapper
            const itemDiv = document.createElement('div');
            itemDiv.className = 'multi-schedule-date-item';

            // Cria o input de data
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'w-full p-2 rounded-lg multi-schedule-date-input'; // Adiciona classe para facilitar a busca
            dateInput.style.colorScheme = 'dark';
            dateInput.min = today; // Define data mínima
            dateInput.value = today; // Define data padrão

            // Cria o botão de remover
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-date-btn';
            removeBtn.innerHTML = 'X';
            removeBtn.onclick = () => removeDateFromMultiSchedule(itemDiv); // Passa o 'itemDiv' para remoção

            // Adiciona na div
            itemDiv.appendChild(dateInput);
            itemDiv.appendChild(removeBtn);
            
            // Adiciona a div na lista
            dateList.appendChild(itemDiv);
        }
        
        function removeDateFromMultiSchedule(itemElement) {
            const dateList = document.getElementById('multi-schedule-date-list');
            dateList.removeChild(itemElement);
            
            // Se a lista ficar vazia, mostra o placeholder novamente
            if (dateList.querySelectorAll('.multi-schedule-date-item').length === 0) {
                 const placeholder = document.getElementById('multi-schedule-placeholder');
                 if (placeholder) placeholder.style.display = 'block';
            }
        }
        
        // Esta é a função de validação (Etapa 1 do Multi-Schedule)
        function validateAndInitiateMultiSchedule() {
            // 1. Valida o formulário principal (passageiros, endereços, MOTIVO)
            const motivoId = document.getElementById('motivo-select').value;
            if (!motivoId) { return alert('Selecione o Motivo da solicitação.'); }

            const passengerCount = parseInt(document.getElementById('passenger-quantity-select').value, 10);
            if (!passengerCount || passengerCount < 1) { return alert('Selecione a quantidade de passageiros.'); }

            const firstCollaboratorId = document.getElementById('collaborator-select-0').value;
            if (!firstCollaboratorId) { return alert('Selecione o Colaborador para a Origem 1.'); }
            const collaborator = state.allUsers.find(u => u.id == firstCollaboratorId);
            if (!collaborator) return alert('Colaborador da Origem 1 não encontrado.');

            const originAddress = document.getElementById('address-input-0').value.trim();
            if (!originAddress) { return alert('O Endereço da Origem 1 é obrigatório.'); }

            for (let i = 1; i < passengerCount; i++) {
                const collabId = document.getElementById(`collaborator-select-${i}`)?.value;
                const addressValue = document.getElementById(`address-input-${i}`)?.value.trim();
                if (!collabId || !addressValue) {
                    return alert(`Preencha o Colaborador e o Endereço para a Origem ${i + 1}.`);
                }
            }
            
            // NO AGENDAMENTO MÚLTIPLO, O DESTINO FINAL É OBRIGATÓRIO
            const destinationAddress = document.getElementById('address-input-destination').value.trim();
            if (!destinationAddress) {
                return alert('O Destino Final é obrigatório para agendamentos múltiplos.');
            }

            // 2. Monta o objeto de dados *base* (sem data/hora)
            const destinationsArray = [];
            for (let i = 1; i < passengerCount; i++) {
                const collabId = document.getElementById(`collaborator-select-${i}`)?.value;
                const addressValue = document.getElementById(`address-input-${i}`)?.value.trim();
                const additionalCollaborator = state.allUsers.find(u => u.id == collabId);
                destinationsArray.push({
                    name: `Origem ${additionalCollaborator.name}`,
                    address: addressValue
                });
            }
            destinationsArray.push({
                name: 'Destino Final',
                address: destinationAddress
            });

            // 3. Salva os dados base na variável global temporária
            tempMultiScheduleRideData = {
                userId: collaborator.id,
                userName: collaborator.name,
                userCompany: collaborator.company,
                origin_address: originAddress,
                destination: JSON.stringify(destinationsArray),
                passenger_count: passengerCount,
                observation: document.getElementById('admin-observation').value.trim(),
                requestTime: new Date().toISOString(), // A solicitação é feita agora
                requested_by_admin_name: state.loggedInAdmin.username,
                motivo_id: motivoId // <<== ADICIONADO: Salva o ID do motivo
            };
            
            // 4. Se tudo estiver OK, abre o modal de multi-agendamento
            openMultiScheduleModal();
        }
        
        // Esta é a função de submissão (Etapa 2 do Multi-Schedule)
        async function confirmAdminMultiSchedule() {
            if (!tempMultiScheduleRideData) {
                return alert('Erro: Dados da corrida não encontrados. Tente novamente.');
            }
            
            const timeInput = document.getElementById('multi-schedule-time');
            const timeValue = timeInput.value;
            if (!timeValue) {
                return alert('Por favor, defina um horário.');
            }
            
            const dateInputs = document.querySelectorAll('.multi-schedule-date-input');
            if (dateInputs.length === 0) {
                return alert('Adicione pelo menos uma data.');
            }
            
            const now = new Date();
            const nowMinutes = Math.floor(now.getTime() / 60000);
            const ridesToInsert = [];
            
            for (const dateInput of dateInputs) {
                const dateValue = dateInput.value;
                if (!dateValue) {
                    return alert('Todas as datas devem ser preenchidas.');
                }
                
                const scheduledDate = new Date(`${dateValue}T${timeValue}`);
                const scheduledMinutes = Math.floor(scheduledDate.getTime() / 60000);
                
                if (scheduledMinutes < nowMinutes) {
                    return alert(`A data ${dateValue} às ${timeValue} está no passado. Por favor, corrija.`);
                }
                
                // Cria uma cópia dos dados base e adiciona as informações de agendamento
                const newRideData = {
                    ...tempMultiScheduleRideData,
                    status: 'scheduled',
                    request_type: 'scheduled',
                    scheduled_datetime: scheduledDate.toISOString()
                };
                
                ridesToInsert.push(newRideData);
            }
            
            if (ridesToInsert.length === 0) {
                return alert('Nenhuma data válida para agendar.');
            }
            
            // Insere todas as corridas em lote
            const { data, error } = await supabaseClient
                .from('rides')
                .insert(ridesToInsert)
                .select();

            if (error) {
                alert(`Erro ao criar agendamentos: ${error.message}`);
                console.error("Erro Supabase (Multi-Schedule):", error);
            } else {
                alert(`${data.length} corridas foram agendadas com sucesso!`);
                resetAdminForm(); // Limpa o formulário principal
                closeMultiScheduleModal(); // Fecha o modal
                // tempMultiScheduleRideData já é limpo pelo closeMultiScheduleModal()
            }
        }
        
        // ========================================================================
        // FIM: NOVAS FUNÇÕES (Agendamento Múltiplo)
        // ========================================================================


        // ========================================================================
        // NOVA FUNÇÃO DE VALIDAÇÃO (Etapa 1 - Agendamento Único ou Imediato)
        // ========================================================================
        async function validateAndInitiateRide(requestType) {
            // Define o tipo de requisição (usado por executeRideRequest)
            adminSelectedRequestType = requestType;
            if (requestType === 'immediate') {
                adminScheduledDateTime = null;
            }
            // (Se 'scheduled', adminScheduledDateTime já foi setado por confirmAdminSchedule)

            // Validações que eram do adminRequestRide
            const motivoId = document.getElementById('motivo-select').value;
            if (!motivoId) { return alert('Selecione o Motivo da solicitação.'); }

            const passengerCount = parseInt(document.getElementById('passenger-quantity-select').value, 10);
            if (!passengerCount || passengerCount < 1) { return alert('Selecione a quantidade de passageiros.'); }

            const firstCollaboratorId = document.getElementById('collaborator-select-0').value;
            if (!firstCollaboratorId) { return alert('Selecione o Colaborador para a Origem 1.'); }
            const collaborator = state.allUsers.find(u => u.id == firstCollaboratorId);
            if (!collaborator) return alert('Colaborador da Origem 1 não encontrado.'); // Segurança

            const originAddress = document.getElementById('address-input-0').value.trim();
            if (!originAddress) { return alert('O Endereço da Origem 1 é obrigatório.'); }

            // Validação dos passageiros 2, 3, 4
            for (let i = 1; i < passengerCount; i++) {
                const collabId = document.getElementById(`collaborator-select-${i}`)?.value;
                const addressValue = document.getElementById(`address-input-${i}`)?.value.trim();

                if (!collabId || !addressValue) {
                    return alert(`Preencha o Colaborador e o Endereço para a Origem ${i + 1}.`);
                }
                const additionalCollaborator = state.allUsers.find(u => u.id == collabId);
                 if (!additionalCollaborator) return alert(`Colaborador da Origem ${i + 1} não encontrado.`);
            }

            // ======================================================
            // INÍCIO DA MODIFICAÇÃO SOLICITADA (Validação Destino)
            // ======================================================
            const destinationAddress = document.getElementById('address-input-destination').value.trim();
            if (!destinationAddress) {
                // Se o destino está vazio, abre o modal de confirmação
                openNoDestinationModal();
                // A função executeRideRequest() será chamada pelo botão "SIM" do modal
                return; // Para a execução aqui
            }
            // ======================================================
            // FIM DA MODIFICAÇÃO SOLICITADA
            // ======================================================

            // Se o destino foi preenchido, executa a solicitação imediatamente
            executeRideRequest();
        }


        // ========================================================================
        // FUNÇÃO DE SUBMISSÃO (Etapa 2 - Agendamento Único ou Imediato)
        // (Anteriormente 'adminRequestRide', agora sem validações de destino)
        // ========================================================================
        async function executeRideRequest() {
            // As validações (exceto destino) já foram feitas em validateAndInitiateRide
            const motivoId = document.getElementById('motivo-select').value;
            const passengerCount = parseInt(document.getElementById('passenger-quantity-select').value, 10);
            const firstCollaboratorId = document.getElementById('collaborator-select-0').value;
            const collaborator = state.allUsers.find(u => u.id == firstCollaboratorId);
            const originAddress = document.getElementById('address-input-0').value.trim();

            // Pega o destino final (pode estar vazio, foi validado/confirmado)
            const destinationAddress = document.getElementById('address-input-destination').value.trim();

            const destinationsArray = [];

            // Adiciona as origens dos passageiros 2, 3, 4
            for (let i = 1; i < passengerCount; i++) {
                const collabId = document.getElementById(`collaborator-select-${i}`)?.value;
                const addressValue = document.getElementById(`address-input-${i}`)?.value.trim();
                const additionalCollaborator = state.allUsers.find(u => u.id == collabId);

                destinationsArray.push({
                    name: `Origem ${additionalCollaborator.name}`,
                    address: addressValue
                });
            }

            // Adiciona o destino final ao array (mesmo se estiver vazio)
            destinationsArray.push({
                name: 'Destino Final',
                address: destinationAddress
            });


            // Monta o objeto da corrida
            let rideData = {
                userId: collaborator.id, // ID do primeiro passageiro (quem solicitou)
                userName: collaborator.name,
                userCompany: collaborator.company,
                origin_address: originAddress, // Endereço de origem do primeiro passageiro
                // Salva o array de destinos como uma string JSON
                destination: JSON.stringify(destinationsArray),
                passenger_count: passengerCount,
                observation: document.getElementById('admin-observation').value.trim(),
                requestTime: new Date().toISOString(),
                requested_by_admin_name: state.loggedInAdmin.username, // Nome do admin que solicitou
                motivo_id: motivoId // <<== ADICIONADO: Salva o ID do motivo
            };

            // Define o status e tipo (variáveis globais setadas em validateAndInitiateRide)
            if (adminSelectedRequestType === 'scheduled' && adminScheduledDateTime) {
                rideData.status = 'scheduled'; 
                rideData.request_type = 'scheduled';
                rideData.scheduled_datetime = adminScheduledDateTime;
            } else {
                 rideData.status = 'approved'; // Aprovado direto, pois é o Admin solicitando
                rideData.request_type = 'immediate';
            }

            // Insere no Supabase
            const { data, error } = await supabaseClient.from('rides').insert([rideData]).select().single();

            if (error) {
                // ======================================================
                // INÍCIO DA CORREÇÃO DO ERRO DE SINTAXE
                // ======================================================
                alert('Erro ao solicitar corrida: ' + error.message);
                // ======================================================
                // FIM DA CORREÇÃO
                // ======================================================
                console.error("Erro Supabase:", error);
            } else {
                alert(`Corrida para ${collaborator.name} ${passengerCount > 1 ? `e mais ${passengerCount - 1}` : ''} solicitada com sucesso! Status: ${rideData.status}.`);
                resetAdminForm(); // Limpa o formulário
            }

            // Reseta as variáveis de controle
            adminSelectedRequestType = '';
            adminScheduledDateTime = null;
        }

        // ========================================================================
        // INÍCIO DA CORREÇÃO: Função showAdminSubScreen (corrigida)
        // ========================================================================
        function showAdminSubScreen(subScreenId) {
            // Esconde todas as sub-telas e remove a classe 'active' das abas
            document.querySelectorAll('.admin-sub-screen').forEach(screen => screen.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            // Mostra a sub-tela correta e ativa a aba correspondente
            const screenToShow = document.getElementById(subScreenId);
            if (screenToShow) screenToShow.classList.add('active');

            let tabToActivateId = '';
            switch (subScreenId) {
                case 'request-ride-screen':
                    tabToActivateId = 'tab-request-ride';
                     handlePassengerQuantityChange({ target: document.getElementById('passenger-quantity-select') });
                    break;
                case 'approval-ride-screen':
                    tabToActivateId = 'tab-approve-ride';
                    loadPendingRides(); // Carrega dados ao mostrar a aba
                    break;
                case 'history-screen':
                    tabToActivateId = 'tab-history';
                    loadHistoryRides(); // Carrega dados ao mostrar a aba
                    break;
                case 'user-management-screen':
                    tabToActivateId = 'tab-users';
                    loadCompanyUsers(); // Carrega dados ao mostrar a aba
                    break;
                case 'motivos-management-screen': // Corrigido para corresponder ao ID do botão
                    tabToActivateId = 'tab-motivos';
                    loadMotivos(); // <<== ADICIONADO: Carrega a lista de motivos
                    break;
            }
            const tabToActivate = document.getElementById(tabToActivateId);
            if (tabToActivate) tabToActivate.classList.add('active');
        }
        // ========================================================================
        // FIM DA CORREÇÃO
        // ========================================================================


        // ========================================================================
        // INÍCIO DA CORREÇÃO: Função loadPendingRides (corrigida)
        // ========================================================================
        async function loadPendingRides() {
            const container = document.getElementById('pending-rides-container');
            container.innerHTML = '<p class="text-center">Carregando solicitações...</p>';

            if (!state.loggedInCompany || !state.loggedInCompany.name) {
                 container.innerHTML = '<p class="text-center text-red-500">Erro: Empresa não identificada.</p>';
                 return;
            }

            // Busca corridas 'pending_approval' (status antigo) E 'approved' (novo status do admin)
            // A lógica original era buscar 'solicitacoes' pendentes. A nova é buscar 'rides'
            // Vamos assumir que 'pending_approval' é o status que o Admin deve aprovar.
            const { data: rides, error } = await supabaseClient
                .from('rides')
                .select(`
                    *,
                    motivos ( nome ) 
                `) // <<== ADICIONADO: Busca o nome do motivo
                .eq('userCompany', state.loggedInCompany.name) // Filtra pela empresa logada
                .eq('status', 'pending_approval') // <<== ALTERADO: Busca SÓ o que está pendente de aprovação
                .order('requestTime', { ascending: true }); // Mais antigos primeiro

            if (error) {
                container.innerHTML = '<p class="text-center text-red-500">Erro ao carregar solicitações.</p>';
                console.error("Erro ao buscar corridas pendentes:", error);
                return;
            }

            const pendingRides = rides || [];

            if (pendingRides.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">Nenhuma solicitação pendente de aprovação no momento.</p>';
                return;
            }

            // Renderiza os cards
            container.innerHTML = pendingRides.map(ride => {
                const requestDate = new Date(ride.requestTime).toLocaleString('pt-BR');
                const scheduledDate = ride.scheduled_datetime ? new Date(ride.scheduled_datetime).toLocaleString('pt-BR') : null;
                const destinations = parseDestinations(ride.destination);
                
                // <<== ADICIONADO: Pega o nome do motivo
                const motivoName = ride.motivos ? ride.motivos.nome : 'N/A'; // Usa 'nome'

                 let destinationsHtml = destinations.map(destObj => `<p><strong>${destObj.name || 'Destino'}:</strong> ${destObj.address || 'N/A'}</p>`).join('');

                 const statusLabel = 'PENDENTE';
                 const statusColor = 'bg-yellow-600';

                return `
                    <div id="ride-card-${ride.id}" class="card-gradient p-4 rounded-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-2">
                             <div>
                                 <p class="font-bold text-lg">${ride.userName}</p>
                                 <p class="text-xs text-gray-400">Solicitado em: ${requestDate}</p>
                                 ${ride.requested_by_admin_name ? `<p class="text-xs text-gray-400">Solicitado por Admin: ${ride.requested_by_admin_name}</p>` : ''}
                                 ${scheduledDate ? `<p class="text-xs text-orange-400 font-semibold">Agendado para: ${scheduledDate}</p>` : ''}
                             </div>
                             <span class="text-xs font-bold py-1 px-3 rounded-full ${statusColor} text-white">${statusLabel}</span>
                        </div>
                        <div class="text-sm space-y-1 border-t border-gray-700 pt-2 mt-2">
                            <p><strong>Motivo:</strong> ${motivoName}</p> <p><strong>Origem:</strong> ${ride.origin_address || 'N/A'}</p>
                            ${destinationsHtml || '<p>Destino: N/A</p>'}
                            ${ride.observation ? `<p class="mt-2"><strong>Observação:</strong> ${ride.observation}</p>` : ''}
                            <p class="text-xs text-gray-500 mt-1">Passageiros: ${ride.passenger_count || 1}</p>
                        </div>
                        <div class="flex justify-end gap-3 mt-4">
                             <button onclick="rejectRide(${ride.id})" class="py-2 px-5 font-semibold rounded-lg bg-red-600 hover:bg-red-700">REJEITAR</button>
                             <button onclick="approveRide(${ride.id})" class="py-2 px-5 font-semibold rounded-lg bg-green-600 hover:bg-green-700">APROVAR</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // ========================================================================
        // FIM DA CORREÇÃO
        // ========================================================================

        // ========================================================================
        // INÍCIO: FUNÇÃO DE SUPORTE (Extrai todos os nomes)
        // ========================================================================
        function extractAllPassengersNames(userName, destinationString) {
            let names = new Set();
            if (userName) {
                names.add(userName);
            }
            
            const destinations = parseDestinations(destinationString);
            
            destinations.forEach(dest => {
                // Heurística: Se o nome do destino começar com 'Origem ', assumimos que o restante é o nome de um passageiro adicional.
                // Ex: "Origem Nome do Colaborador"
                const match = dest.name ? dest.name.match(/^(Origem |Parada )\s*(.+)/) : null;
                if (match) {
                    names.add(match[2].trim()); // Adiciona o nome extraído
                }
            });

            // Converte o Set para Array e junta com vírgula, limitando a 3 para brevidade
            const nameArray = Array.from(names);
            if (nameArray.length > 3) {
                return `${nameArray.slice(0, 3).join(', ')} e mais ${nameArray.length - 3}`;
            }
            return nameArray.join(', ') || 'N/A';
        }
        // ========================================================================
        // FIM: FUNÇÃO DE SUPORTE
        // ========================================================================

        // ========================================================================
        // INÍCIO: SEÇÃO DE HISTÓRICO (Unificada e corrigida)
        // ========================================================================
        
        let allHistoryRidesCache = [];
        const statusMap = {
            'approved': { text: 'Aprovada', color: 'text-teal-400' },
            'rejected': { text: 'Rejeitada', color: 'text-red-500' },
            'scheduled': { text: 'Agendada', color: 'text-orange-400' },
            'requested': { text: 'Solicitada', color: 'text-blue-400' },
            'assigned': { text: 'Designada', color: 'text-yellow-400' },
            'accepted': { text: 'Aceita', color: 'text-lime-400' },
            'arrived_pickup': { text: 'No Embarque', color: 'text-fuchsia-400' },
            'in_progress': { text: 'Em Andamento', color: 'text-purple-400' },
            'completed': { text: 'Concluída', color: 'text-green-500' },
            'canceled': { text: 'Cancelada (Usuário/Admin)', color: 'text-gray-500' },
            'canceled_by_driver': { text: 'Cancelada (Motorista)', color: 'text-pink-500' },
            'pending_approval': { text: 'Pendente', color: 'text-yellow-400' } // Adicionado caso apareça
        };

        async function loadHistoryRides() {
            const container = document.getElementById('history-rides-container'); // Usado para mensagens
            const tableBody = document.getElementById('history-table-body');
            const tableElement = document.getElementById('history-table');
            
            container.innerHTML = '<p class="text-center mt-4">Carregando histórico...</p>';
            if (tableBody) tableBody.innerHTML = ''; // Limpa a tabela
            if (tableElement) tableElement.style.display = 'none'; // Esconde a tabela enquanto carrega

            if (!state.loggedInCompany || !state.loggedInCompany.name) {
                 container.innerHTML = '<p class="text-center text-red-500 mt-4">Erro: Empresa não identificada.</p>';
                 return;
            }

            const { data: rides, error } = await supabaseClient
                .from('rides')
                .select(`
                    *,
                    motivos ( nome )
                `) // <<== MODIFICADO: Busca o nome do motivo
                .eq('userCompany', state.loggedInCompany.name)
                // .not('status', 'eq', 'pending_approval') // Mostra tudo, inclusive pendentes
                .order('requestTime', { ascending: false }); // Mais recentes primeiro

            if (error) {
                container.innerHTML = '<p class="text-center text-red-500 mt-4">Erro ao carregar o histórico.</p>';
                console.error("Erro ao buscar histórico de corridas:", error);
                allHistoryRidesCache = []; // Limpa o cache em caso de erro
                return;
            }

            if (!rides || rides.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-4">Nenhum registro de corrida encontrado.</p>';
                allHistoryRidesCache = []; // Limpa o cache
                if (tableElement) tableElement.style.display = 'none';
                return;
            }

            allHistoryRidesCache = rides; // Salva os dados no cache
            populateStatusFilter();
            renderHistoryTable();
            
            container.innerHTML = '';
            if (tableElement) tableElement.style.display = 'table'; // Mostra a tabela
        }

        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            try {
                return new Date(isoString).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Data Inválida';
            }
        }

        function populateStatusFilter() {
            const statusFilter = document.getElementById('history-filter-status');
            if (!statusFilter) return;

            const firstOption = statusFilter.options[0];
            statusFilter.innerHTML = '';
            statusFilter.appendChild(firstOption);

            const uniqueStatuses = [...new Set(allHistoryRidesCache.map(ride => ride.status))];

            uniqueStatuses.sort().forEach(statusKey => {
                const statusInfo = statusMap[statusKey] || { text: statusKey.toUpperCase() };
                const option = document.createElement('option');
                option.value = statusKey;
                option.textContent = statusInfo.text;
                statusFilter.appendChild(option);
            });
        }

        function applyHistoryFilter() {
            const startDate = document.getElementById('history-filter-start-date').value;
            const endDate = document.getElementById('history-filter-end-date').value;
            const status = document.getElementById('history-filter-status').value;
            const type = document.getElementById('history-filter-type').value;
            
            renderHistoryTable({ startDate, endDate, status, type });
        }

        function clearHistoryFilter() {
            document.getElementById('history-filter-start-date').value = '';
            document.getElementById('history-filter-end-date').value = '';
            document.getElementById('history-filter-status').value = '';
            document.getElementById('history-filter-type').value = '';
            
            renderHistoryTable(); // Renderiza sem filtros
            document.getElementById('history-filter-display').textContent = '';
        }

        function renderHistoryTable(filters = {}) {
            const tableBody = document.getElementById('history-table-body');
            const container = document.getElementById('history-rides-container'); // Para mensagens
            const tableElement = document.getElementById('history-table');
            const filterDisplay = document.getElementById('history-filter-display');
            
            if (!tableBody || !container || !tableElement || !filterDisplay) return; // Segurança

            tableBody.innerHTML = ''; // Limpa a tabela

            let filteredRides = [...allHistoryRidesCache];
            let filterText = [];

            if (filters.status) {
                filteredRides = filteredRides.filter(ride => ride.status === filters.status);
                const statusText = statusMap[filters.status]?.text || filters.status;
                filterText.push(`Status: ${statusText}`);
            }

            if (filters.type) {
                filteredRides = filteredRides.filter(ride => ride.request_type === filters.type);
                const typeText = filters.type === 'immediate' ? 'Imediato' : 'Agendado';
                filterText.push(`Tipo: ${typeText}`);
            }

            if (filters.startDate) {
                try {
                    const startDate = new Date(`${filters.startDate}T00:00:00`);
                    if (!isNaN(startDate)) {
                        filteredRides = filteredRides.filter(ride => new Date(ride.requestTime) >= startDate);
                        filterText.push(`De: ${startDate.toLocaleDateString('pt-BR')}`);
                    }
                } catch(e) { console.warn("Data inicial inválida"); }
            }

            if (filters.endDate) {
                 try {
                    const endDate = new Date(`${filters.endDate}T23:59:59`);
                     if (!isNaN(endDate)) {
                        filteredRides = filteredRides.filter(ride => new Date(ride.requestTime) <= endDate);
                        filterText.push(`Até: ${endDate.toLocaleDateString('pt-BR')}`);
                     }
                 } catch(e) { console.warn("Data final inválida"); }
            }

            if (filterText.length > 0) {
                filterDisplay.textContent = `Filtros Ativos: ${filterText.join(', ')}`;
            } else {
                filterDisplay.textContent = 'Mostrando todos os resultados.';
            }

            if (filteredRides.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-4">Nenhum registro encontrado para os filtros aplicados.</p>';
                tableElement.style.display = 'none'; // Esconde a tabela
                return;
            }
            
            container.innerHTML = '';
            tableElement.style.display = 'table'; // Garante que a tabela está visível

            filteredRides.forEach(ride => {
                const statusInfo = statusMap[ride.status] || { text: ride.status.toUpperCase(), color: 'text-gray-300' };
                const destinations = parseDestinations(ride.destination);
                
                let destinationsHtml = destinations
                    .map(destObj => `<strong>${destObj.name || 'Destino'}:</strong> ${destObj.address || 'N/A'}`)
                    .join('<br>');
                
                const typeText = ride.request_type === 'immediate' ? 'Imediato' : (ride.request_type === 'scheduled' ? 'Agendado' : (ride.request_type || 'N/A'));
                
                // <<== MODIFICADO: Pega o nome do motivo e a lista de passageiros
                const motivoName = ride.motivos ? ride.motivos.nome : 'N/A'; // Usa 'nome'
                const allPassengersNames = extractAllPassengersNames(ride.userName, ride.destination); // Usa a nova função

                const row = `
                    <tr class="hover:bg-gray-800">
                        <td class="p-3 text-sm">${ride.id}</td>
                        <td class="p-3 text-sm font-medium ${statusInfo.color}">${statusInfo.text}</td>
                        <td class="p-3 text-sm">${allPassengersNames}</td>
                        <td class="p-3 text-sm">${motivoName}</td>
                        <td class="p-3 text-sm">${formatDateTime(ride.requestTime)}</td>
                        <td class="p-3 text-sm">${formatDateTime(ride.scheduled_datetime)}</td>
                        <td class="p-3 text-sm">${formatDateTime(ride.acceptTime)}</td>
                        <td class="p-3 text-sm">${ride.origin_address || 'N/A'}</td>
                        <td class="p-3 text-sm">${destinationsHtml || 'N/A'}</td>
                        <td class="p-3 text-sm">${ride.passenger_count || 1}</td>
                        <td class="p-3 text-sm">${ride.driverName || 'N/A'}</td>
                        <td class="p-3 text-sm">${ride.observation || 'N/A'}</td>
                        <td class="p-3 text-sm">${ride.requested_by_admin_name || 'N/A'}</td>
                        <td class="p-3 text-sm">${typeText}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        // ========================================================================
        // FIM: SEÇÃO DE HISTÓRICO
        // ========================================================================

        // ========================================================================
        // INÍCIO: BLOCO RESTAURADO (que foi cortado na resposta anterior)
        // ========================================================================

        function exportHistoryToExcel(tableID, filename = ''){
            const table = document.getElementById(tableID);
            if (!table) {
                alert('Erro: Tabela não encontrada para exportação.');
                return;
            }
            
            const tableClone = table.cloneNode(true);
            
            tableClone.querySelectorAll('td, th').forEach(cell => {
                cell.className = '';
            });

            let tableHTML = tableClone.outerHTML
                .replace(/<br\s*\/?>/gi, "; "); 

            const dataType = 'application/vnd.ms-excel';
            filename = filename ? filename + '.xls' : 'export_excel.xls';

            const downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);
            
            if(navigator.msSaveOrOpenBlob){
                const blob = new Blob(['\ufeff', tableHTML], { type: dataType });
                navigator.msSaveOrOpenBlob( blob, filename);
            } else {
                downloadLink.href = 'data:' + dataType + ', ' + '\ufeff' + encodeURIComponent(tableHTML);
                downloadLink.download = filename;
                downloadLink.click();
            }
            document.body.removeChild(downloadLink);
        }

         async function approveRide(rideId) {
            if (!confirm('Tem certeza que deseja APROVAR esta solicitação de corrida?')) return;

             const { data: ride, error: fetchError } = await supabaseClient
                 .from('rides')
                 .select('request_type')
                 .eq('id', rideId)
                 .single();

             if (fetchError || !ride) {
                 alert('Erro ao buscar detalhes da corrida para aprovação.');
                 console.error("Erro Supabase (approveRide fetch):", fetchError);
                 return;
             }

             // Status 'approved' (Aprovado pelo Admin, pronto para motorista)
             const nextStatus = 'approved';

            const { error: updateError } = await supabaseClient
                .from('rides')
                .update({ status: nextStatus })
                .eq('id', rideId);

            if (updateError) {
                alert('Erro ao aprovar a corrida: ' + updateError.message);
                console.error("Erro Supabase (approveRide update):", updateError);
            } else {
                alert('Corrida aprovada! Status atualizado para: ' + nextStatus.toUpperCase());
                loadPendingRides();
            }
        }

        async function rejectRide(rideId) {
            if (!confirm('Tem certeza que deseja REJEITAR esta solicitação de corrida?')) return;

            const { error } = await supabaseClient
                .from('rides')
                .update({ status: 'rejected' })
                .eq('id', rideId);

            if (error) {
                alert('Erro ao rejeitar a corrida: ' + error.message);
                 console.error("Erro Supabase (rejectRide):", error);
            } else {
                alert('Solicitação de corrida rejeitada.');
                loadPendingRides();
            }
        }

        // --- FUNÇÃO PARA CARREGAR EMPRESAS NO SELECT DE LOGIN ---
        async function populateLoginCompanies() {
            const select = document.getElementById('company-login-select');
            
            if (!select) {
                console.error("Erro: Elemento 'company-login-select' não encontrado no DOM.");
                return;
            }
            
            select.innerHTML = '<option value="">Carregando...</option>';
            
            const { data, error } = await supabaseClient
                .from('companies')
                .select('id, name')
                .order('name');

            if (error) {
                console.error("Erro ao carregar empresas:", error);
                select.innerHTML = '<option value="">Erro ao carregar empresas</option>';
                return;
            }

            if (!data || data.length === 0) {
                select.innerHTML = '<option value="">Nenhuma empresa cadastrada</option>';
                return;
            }

            select.innerHTML = '<option value="">-- Selecione a Empresa --</option>' + 
                               data.map(company => `<option value="${company.name}">${company.name}</option>`).join('');
        }

        // --- FUNÇÃO DE INICIALIZAÇÃO PRINCIPAL ---
        async function initApp() {
            await populateLoginCompanies();

            const immediateBtn = document.getElementById('admin-request-immediate-btn');
            const scheduledBtn = document.getElementById('admin-request-scheduled-btn');
            const multiScheduleBtn = document.getElementById('admin-request-multi-schedule-btn');

            if (immediateBtn) {
                immediateBtn.onclick = () => {
                    validateAndInitiateRide('immediate');
                };
            }
            if (scheduledBtn) {
                scheduledBtn.onclick = openAdminScheduleModal;
            }
            if (multiScheduleBtn) {
                multiScheduleBtn.onclick = validateAndInitiateMultiSchedule;
            }

            const noDestNoBtn = document.getElementById('no-destination-btn-no');
            const noDestYesBtn = document.getElementById('no-destination-btn-yes');

            if (noDestNoBtn) {
                noDestNoBtn.onclick = closeNoDestinationModal;
            }
            if (noDestYesBtn) {
                noDestYesBtn.onclick = () => {
                    closeNoDestinationModal();
                    executeRideRequest();
                };
            }

             supabaseClient
                .channel('public:rides')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, async (payload) => {
                    const activeScreen = document.querySelector('.screen.active');
                    if (!activeScreen || !state.loggedInCompany) return;

                    const companyName = state.loggedInCompany.name;
                    const rideCompany = payload.new?.userCompany || payload.old?.userCompany;

                    if (rideCompany === companyName) {
                        const activeSubScreen = activeScreen.querySelector('.admin-sub-screen.active');
                        if (activeSubScreen) {
                            if (activeSubScreen.id === 'approval-ride-screen') {
                                await loadPendingRides();
                            } else if (activeSubScreen.id === 'history-screen') {
                                await loadHistoryRides();
                            }
                             else if (activeSubScreen.id === 'request-ride-screen') {
                                const passengerSelect = document.getElementById('passenger-quantity-select');
                                if (passengerSelect.value) {
                                    await refreshAllUsers();
                                    handlePassengerQuantityChange({ target: passengerSelect });
                                }
                             }
                        }
                    }
                })
                .subscribe((status, err) => {
                     if (status === 'SUBSCRIBED') { console.log('Admin Empresa: Conectado ao canal RIDES'); }
                     if (err) { console.error('Admin Empresa: Erro RIDES subscription', err); }
                });


             supabaseClient
                .channel('public:users')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, async (payload) => {
                     const activeScreen = document.querySelector('.screen.active');
                     if (!activeScreen || !state.loggedInCompany) return;

                     await refreshAllUsers();

                     const companyName = state.loggedInCompany.name;
                     const userCompany = payload.new?.company || payload.old?.company;

                     if (userCompany === companyName) {
                        const activeSubScreen = activeScreen.querySelector('.admin-sub-screen.active');
                        if (activeSubScreen && activeSubScreen.id === 'user-management-screen') {
                           await loadCompanyUsers();
                        }
                         else if (activeSubScreen && activeSubScreen.id === 'request-ride-screen') {
                             const passengerSelect = document.getElementById('passenger-quantity-select');
                             if (passengerSelect.value) {
                                 handlePassengerQuantityChange({ target: passengerSelect });
                             }
                         }
                     }
                })
                .subscribe((status, err) => {
                     if (status === 'SUBSCRIBED') { console.log('Admin Empresa: Conectado ao canal USERS'); }
                     if (err) { console.error('Admin Empresa: Erro USERS subscription', err); }
                });

                  supabaseClient
                    .channel('public:companies')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'companies' }, async (payload) => {
                        console.log("Mudança na tabela de empresas detectada.");
                        await populateLoginCompanies();

                        const activeScreenId = document.querySelector('.screen.active')?.id;
                        if (state.loggedInAdmin?.username === "Super Admin" && activeScreenId === 'company-management-screen') {
                            await loadCompanyManagement();
                        }
                    })
                    .subscribe((status, err) => {
                         if (status === 'SUBSCRIBED') { console.log('Admin Empresa: Conectado ao canal COMPANIES'); }
                         if (err) { console.error('Admin Empresa: Erro COMPANIES subscription', err); }
                    });

            // ========================================================================
            // INÍCIO: NOVA SUBSCRIPTION (Motivos) - CORRIGIDA
            // ========================================================================
             supabaseClient
                .channel('public:motivos')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'motivos' }, async (payload) => {
                    const activeScreen = document.querySelector('.screen.active');
                    if (!activeScreen || !state.loggedInCompany) return;

                    // ======================================================
                    // CORREÇÃO (Usa ID da empresa e coluna 'empresa_id')
                    // ======================================================
                    const companyId = state.loggedInCompany.id; // Usa ID
                    const motivoCompanyId = payload.new?.empresa_id || payload.old?.empresa_id; // Usa 'empresa_id'

                    if (motivoCompanyId === companyId) { // Compara IDs
                    // ======================================================
                    // FIM DA CORREÇÃO
                    // ======================================================
                    
                        // Atualiza o select de motivos em 'Solicitar Corrida'
                        await populateMotivosSelect(); 
                        
                        const activeSubScreen = activeScreen.querySelector('.admin-sub-screen.active');
                        // Se a aba de gerenciar motivos estiver ativa
                        if (activeSubScreen && activeSubScreen.id === 'motivos-management-screen') {
                            await loadMotivos(); // Recarrega a lista de motivos
                        }
                    }
                })
                .subscribe((status, err) => {
                     if (status === 'SUBSCRIBED') { console.log('Admin Empresa: Conectado ao canal MOTIVOS'); }
                     if (err) { console.error('Admin Empresa: Erro MOTIVOS subscription', err); }
                });
            // ========================================================================
            // FIM: NOVA SUBSCRIPTION
            // ========================================================================

        }

        // Chama initApp quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initApp);

        // --- SUPER ADMIN: COMPANY CRUD FUNCTIONS ---
        async function loadCompanyManagement() {
            const container = document.getElementById('company-list-container');
            container.innerHTML = '<p class="text-center">Carregando empresas...</p>';
            const { data, error } = await supabaseClient.from('companies').select('*').order('name');
            if (error) {
                container.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar empresas.</p>';
                console.error(error);
                return;
            }
             if (!data || data.length === 0) {
                 container.innerHTML = '<p class="text-gray-400 text-center">Nenhuma empresa cadastrada.</p>';
                 return;
             }
            container.innerHTML = data.map(c => `
                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-lg">${c.name}</p>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-end"> <button onclick="manageAdminsForCompany(${c.id},'${c.name}')" class="py-1 px-3 text-sm font-semibold rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white">Admins</button>
                        <button onclick="editCompany(${c.id},'${c.name}')" class="py-1 px-3 text-sm font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Renomear</button>
                        <button onclick="deleteCompany(${c.id},'${c.name}')" class="py-1 px-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700">X</button> </div>
                </div>
            `).join('');
        }

        function editCompany(id, name) {
            document.getElementById('editing-company-id').value = id;
            document.getElementById('new-company-name').value = name;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('company-form-title').textContent = 'Editar Nome da Empresa';
            window.scrollTo(0, 0);
        }

        function cancelEdit() {
            document.getElementById('editing-company-id').value = '';
            document.getElementById('new-company-name').value = '';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('company-form-title').textContent = 'Adicionar Empresa';
        }

        async function addOrUpdateCompany() {
            const id = document.getElementById('editing-company-id').value;
            const name = document.getElementById('new-company-name').value.trim();
            if (!name) return alert('Nome da empresa é obrigatório.');

            let result;
            if (id) {
                result = await supabaseClient.from('companies').update({ name }).eq('id', id).select();
            } else {
                result = await supabaseClient.from('companies').insert({ name }).select();
            }

            const { data, error } = result;
            if (error) {
                alert('Erro ao salvar empresa: ' + error.message);
                console.error("Erro Supabase (Company Save):", error);
            } else {
                alert(`Empresa "${data[0].name}" ${id ? 'atualizada' : 'adicionada'} com sucesso!`);
                cancelEdit();
            }
        }

        async function deleteCompany(id, name) {
            if (!confirm(`ATENÇÃO!\n\nExcluir a empresa "${name}" também removerá:\n- Todos os Administradores associados.\n- Todos os Usuários (colaboradores) associados.\n- O histórico de corridas NÃO será removido, mas ficará sem referência de empresa.\n\nDeseja continuar?`)) return;

            console.log(`Tentando excluir empresa ID: ${id}, Nome: ${name}`);
            const { error } = await supabaseClient.from('companies').delete().eq('id', id);

            if (error) {
                alert(`Erro ao excluir empresa "${name}": ${error.message}\nVerifique se há dependências não resolvidas.`);
                console.error("Erro Supabase (Company Delete):", error);
            } else {
                alert(`Empresa "${name}" excluída com sucesso.`);
            }
        }


        // --- SUPER ADMIN: ADMINS CRUD FUNCTIONS ---
        function manageAdminsForCompany(companyId, companyName) {
            currentManagingCompany = { id: companyId, name: companyName };
            showScreen('admin-management-screen');
            loadCompanyAdmins();
        }

        async function loadCompanyAdmins() {
            const container = document.getElementById('admin-management-screen');
            if (!currentManagingCompany.id) {
                container.innerHTML = `<button onclick="showScreen('company-management-screen')" class="mb-4 text-cyan-400 hover:text-cyan-200">← Voltar</button><p class="text-red-500 text-center">Erro: ID da empresa inválido.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Admins: ${currentManagingCompany.name}</h2>
                        <button onclick="showScreen('company-management-screen')" class="text-sm bg-gray-600 hover:bg-gray-700 p-2 rounded-lg">← Voltar</button>
                    </div>
                    <div class="card-gradient p-4 rounded-lg mb-6">
                        <h3 id="admin-form-title" class="text-lg font-semibold mb-2">Adicionar Novo Admin</h3>
                        <input type="hidden" id="editing-admin-id">
                        <div class="space-y-2">
                            <input type="text" id="new-admin-username" placeholder="Usuário" class="w-full p-2 rounded-lg">
                            <input type="text" id="new-admin-password" placeholder="Senha" class="w-full p-2 rounded-lg">
                        </div>
                        <button onclick="addOrUpdateCompanyAdmin()" class="w-full mt-3 py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700">Salvar Admin</button>
                        <button id="cancel-admin-edit-btn" onclick="cancelCompanyAdminEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                    </div>
                    <div id="admin-list-container" class="space-y-3">Carregando admins...</div>
                </div>
            `;

            const adminListContainer = document.getElementById('admin-list-container');
            const { data, error } = await supabaseClient
                .from('company_admins')
                .select('*')
                .eq('company_id', currentManagingCompany.id)
                .order('username');

            if (error) {
                adminListContainer.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar admins.</p>';
                 console.error("Erro Supabase (Load Admins):", error);
                return;
            }
            if (!data || data.length === 0) {
                adminListContainer.innerHTML = '<p class="text-gray-400 text-center">Nenhum admin cadastrado para esta empresa.</p>';
                return;
            }

            adminListContainer.innerHTML = data.map(admin => `
                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-lg">${admin.username}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='editCompanyAdmin(${JSON.stringify(admin)})' class="py-1 px-3 text-sm font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Editar</button>
                        <button onclick="deleteCompanyAdmin(${admin.id}, '${admin.username}')" class="py-1 px-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700">X</button>
                    </div>
                </div>
            `).join('');
        }

        function editCompanyAdmin(admin) {
            document.getElementById('editing-admin-id').value = admin.id;
            document.getElementById('new-admin-username').value = admin.username;
            document.getElementById('new-admin-password').value = admin.password;
            document.getElementById('cancel-admin-edit-btn').classList.remove('hidden');
            document.getElementById('admin-form-title').textContent = 'Editar Admin';
            window.scrollTo(0, 0);
        }

        function cancelCompanyAdminEdit() {
            document.getElementById('editing-admin-id').value = '';
            document.getElementById('new-admin-username').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('cancel-admin-edit-btn').classList.add('hidden');
            document.getElementById('admin-form-title').textContent = 'Adicionar Novo Admin';
        }

        async function addOrUpdateCompanyAdmin() {
            const id = document.getElementById('editing-admin-id').value;
            const username = document.getElementById('new-admin-username').value.trim();
            const password = document.getElementById('new-admin-password').value.trim();

            if (!username || !password) return alert('Usuário e Senha são obrigatórios.');
            if (!currentManagingCompany.id) return alert('Erro: Empresa não selecionada.');

            const adminData = {
                company_id: currentManagingCompany.id,
                username,
                password
            };

            const { data, error } = id
                ? await supabaseClient.from('company_admins').update(adminData).eq('id', id).select()
                : await supabaseClient.from('company_admins').insert([adminData]).select();

            if (error) {
                alert('Erro ao salvar admin: ' + error.message);
                 console.error("Erro Supabase (Admin Save):", error);
            } else {
                 alert(`Admin "${data[0].username}" ${id ? 'atualizado' : 'adicionado'} com sucesso!`);
                cancelCompanyAdminEdit();
                await loadCompanyAdmins();
            }
        }

        async function deleteCompanyAdmin(id, username) {
            if (!confirm(`Tem certeza que deseja excluir o admin "${username}"?`)) return;
            const { error } = await supabaseClient.from('company_admins').delete().eq('id', id);
            if (error) {
                alert('Erro ao excluir admin: ' + error.message);
                console.error("Erro Supabase (Admin Delete):", error);
            } else {
                 alert(`Admin "${username}" excluído com sucesso.`);
                await loadCompanyAdmins();
            }
        }


        // --- COMPANY ADMIN: USER CRUD FUNCTIONS ---
        async function loadCompanyUsers() {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '<p class="text-center">Carregando usuários...</p>';

            if (!state.loggedInCompany || !state.loggedInCompany.name) {
                container.innerHTML = '<p class="text-red-500 text-center">Erro: Empresa não identificada.</p>';
                return;
            }

            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('company', state.loggedInCompany.name)
                .order('name');

            if (error) {
                container.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar usuários.</p>';
                console.error("Erro Supabase (Load Users):", error);
                return;
            }
             companyUsersCache = data || [];

            if (companyUsersCache.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">Nenhum usuário cadastrado para esta empresa.</p>';
                return;
            }

            container.innerHTML = companyUsersCache.map(user => `
                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-lg">${user.name}</p>
                        <p class="text-sm text-gray-400">Matrícula: ${user.matricula || 'N/A'}</p>
                        <p class="text-sm text-gray-400">Endereço: ${user.address || 'N/A'}</p>
                         <p class="text-sm text-gray-400">Telefone: ${user.phone || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='editUserById(${user.id})' class="py-1 px-3 text-sm font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Editar</button>
                        <button onclick="deleteUser(${user.id},'${user.name}')" class="py-1 px-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700">X</button>
                    </div>
                </div>
            `).join('');
        }

        function editUserById(userId) {
            const user = companyUsersCache.find(u => u.id === userId);
            if (!user) return alert('Usuário não encontrado no cache.');

            document.getElementById('editing-user-id').value = user.id;
            document.getElementById('new-user-matricula').value = user.matricula || '';
            document.getElementById('new-user-name').value = user.name || '';
            document.getElementById('new-user-address').value = user.address || '';
            document.getElementById('new-user-address-validated').value = user.address || ''; 
            document.getElementById('new-user-phone').value = user.phone || '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-password').placeholder = 'Nova Senha (deixe em branco para manter)';

            document.getElementById('cancel-user-edit-btn').classList.remove('hidden');
            document.getElementById('user-form-title').textContent = 'Editar Usuário';
            window.scrollTo(0, 0);
        }

        function cancelUserEdit() {
            document.getElementById('editing-user-id').value = '';
            document.getElementById('new-user-matricula').value = '';
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-address').value = '';
            document.getElementById('new-user-address-validated').value = '';
            document.getElementById('new-user-phone').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-password').placeholder = 'Senha';

            document.getElementById('cancel-user-edit-btn').classList.add('hidden');
            document.getElementById('user-form-title').textContent = 'Adicionar Usuário';
        }


        async function addOrUpdateUser() {
            const id = document.getElementById('editing-user-id').value;
            const matricula = document.getElementById('new-user-matricula').value.trim();
            const name = document.getElementById('new-user-name').value.trim();
            
            const addressInput = document.getElementById('new-user-address');
            const address = addressInput.value.trim();
            const validatedAddressInput = document.getElementById('new-user-address-validated');
            const validatedAddress = validatedAddressInput ? validatedAddressInput.value.trim() : address; 

            if (address && address !== validatedAddress) {
                return alert('Endereço inválido! Por favor, selecione um endereço da lista de sugestões. Se o endereço não for obrigatório, pode deixar o campo em branco.');
            }

            const phone = document.getElementById('new-user-phone').value.trim();
            const password = document.getElementById('new-user-password').value.trim();

            if (!matricula || !name) {
                return alert('Matrícula e Nome são obrigatórios.');
            }
             if (!id && !password) {
                return alert('Senha é obrigatória para novos usuários.');
            }

            let userData = {
                matricula,
                name,
                address,
                phone,
                company: state.loggedInCompany.name
            };

            if (password) {
                userData.password = password;
            }

            let result;
            if (id) {
                result = await supabaseClient.from('users').update(userData).eq('id', id).select();
            } else {
                userData.password = password;
                result = await supabaseClient.from('users').insert([userData]).select();
            }

            const { data, error } = result;

            if (error) {
                alert('Erro ao salvar usuário: ' + error.message);
                console.error("Erro Supabase (User Save):", error);
            } else {
                alert(`Usuário "${data[0].name}" ${id ? 'atualizado' : 'adicionado'} com sucesso!`);
                cancelUserEdit();
            }
        }

        async function deleteUser(id, name) {
            if (!confirm(`Tem certeza que deseja excluir o usuário "${name}"? Esta ação não pode ser desfeita.`)) return;

            const { error } = await supabaseClient.from('users').delete().eq('id', id);

            if (error) {
                alert('Erro ao excluir usuário: ' + error.message);
                console.error("Erro Supabase (User Delete):", error);
            } else {
                alert(`Usuário "${name}" excluído com sucesso.`);
            }
        }
        
        // ========================================================================
        // INÍCIO: NOVO BLOCO (CRUD de Motivos) - CORRIGIDO
        // ========================================================================

        async function loadMotivos() {
            const container = document.getElementById('motivo-list-container');
            container.innerHTML = '<p class="text-center">Carregando motivos...</p>';

            // ======================================================
            // CORREÇÃO (Usa ID da empresa e coluna 'empresa_id')
            // ======================================================
            if (!state.loggedInCompany || !state.loggedInCompany.id) { // Precisa do ID
                container.innerHTML = '<p class="text-red-500 text-center">Erro: Empresa não identificada.</p>';
                return;
            }
            
            const { data, error } = await supabaseClient
                .from('motivos')
                .select('*')
                .eq('empresa_id', state.loggedInCompany.id) // Compara 'empresa_id' com o ID da empresa logada
                .order('nome'); // Ordena por 'nome'
            // ======================================================
            // FIM DA CORREÇÃO
            // ======================================================

            if (error) {
                container.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar motivos.</p>';
                console.error("Erro Supabase (Load Motivos):", error);
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">Nenhum motivo cadastrado.</p>';
                return;
            }

            container.innerHTML = data.map(motivo => `
                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-lg">${motivo.nome}</p> </div>
                    <div class="flex gap-2">
                        <button onclick='editMotivo(${JSON.stringify(motivo)})' class="py-1 px-3 text-sm font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Editar</button>
                        <button onclick="deleteMotivo(${motivo.id},'${motivo.nome}')" class="py-1 px-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700">X</button>
                    </div>
                </div>
            `).join('');
        }

        async function addOrUpdateMotivo() {
            const id = document.getElementById('editing-motivo-id').value;
            const name = document.getElementById('new-motivo-name').value.trim();

            if (!name) {
                return alert('O nome do motivo é obrigatório.');
            }
            if (!state.loggedInCompany || !state.loggedInCompany.id) { // Precisa do ID
                return alert('Erro: Empresa não logada.');
            }

            // ======================================================
            // CORREÇÃO (Usa 'nome' e 'empresa_id')
            // ======================================================
            const motivoData = {
                nome: name, // Coluna 'nome' da tabela 'motivos'
                empresa_id: state.loggedInCompany.id // Salva o ID da empresa na coluna 'empresa_id'
            };
            // ======================================================
            // FIM DA CORREÇÃO
            // ======================================================

            let result;
            if (id) { // Editando
                result = await supabaseClient.from('motivos').update(motivoData).eq('id', id).select();
            } else { // Adicionando
                result = await supabaseClient.from('motivos').insert([motivoData]).select();
            }

            const { data, error } = result;

            if (error) {
                alert('Erro ao salvar motivo: ' + error.message);
                console.error("Erro Supabase (Motivo Save):", error);
            } else {
                alert(`Motivo "${data[0].nome}" ${id ? 'atualizado' : 'adicionado'} com sucesso!`);
                cancelMotivoEdit();
                // As subscriptions de realtime (agora adicionadas) cuidarão de atualizar as listas
            }
        }

        function editMotivo(motivo) {
            if (!motivo) return;
            document.getElementById('editing-motivo-id').value = motivo.id;
            document.getElementById('new-motivo-name').value = motivo.nome; // Usa 'nome'
            document.getElementById('cancel-motivo-edit-btn').classList.remove('hidden');
            document.getElementById('motivo-form-title').textContent = 'Editar Motivo';
            window.scrollTo(0, 0);
        }

        function cancelMotivoEdit() {
            document.getElementById('editing-motivo-id').value = '';
            document.getElementById('new-motivo-name').value = '';
            document.getElementById('cancel-motivo-edit-btn').classList.add('hidden');
            document.getElementById('motivo-form-title').textContent = 'Adicionar Motivo';
        }

        async function deleteMotivo(id, name) {
            if (!confirm(`Tem certeza que deseja excluir o motivo "${name}"?`)) return;

            const { error } = await supabaseClient.from('motivos').delete().eq('id', id);

            if (error) {
                alert('Erro ao excluir motivo: ' + error.message);
                console.error("Erro Supabase (Motivo Delete):", error);
            } else {
                alert(`Motivo "${name}" excluído com sucesso.`);
                // As subscriptions de realtime (agora adicionadas) cuidarão de atualizar as listas
            }
        }
        // ========================================================================
        // FIM: NOVO BLOCO
        // ========================================================================


    </script>
</body>

</html>
