
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA TRANSPORTES - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body, html { background-color: #000; }
        .main-gradient { background: linear-gradient(135deg, #000000, #000000); }
        .button-gradient { background: linear-gradient(to right, #000000, #000000); border: 2px solid white; position: relative; overflow: hidden; }
        .button-gradient::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.3), rgba(255,255,255,0)); transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .button-gradient:hover::before { transform: translateX(0); }
        .card-gradient { background: linear-gradient(135deg, #000000, #000000); }
        .screen { display: none; background-color: #000; }
        .screen.active { display: block; }
        .text-black, .text-gray-800, .text-gray-400, .text-gray-300, .text-gray-600, .text-gray-700, .text-gray-500, .text-green-300, .text-yellow-300 { color: #ffffff !important; }
        .text-cyan-400 { color: #00ffff !important; }
        h1, h2, h3, p, button, label, input::placeholder, textarea::placeholder, select, option { color: #ffffff !important; }
        input, select, textarea { background-color: #374151 !important; border-color: #4b5563 !important; }
        #company-password-input { font-size: 14px; text-align: center; }
        #company-password-input::placeholder { text-align: center; }
        #app-container { position: relative; }
        #admin-access-icon:hover svg { stroke: #fff; }
        .pac-container { background-color: #374151; border-radius: 8px; border: 1px solid #4b5563; z-index: 1050 !important; }
        .pac-item { padding: 10px; font-size: 14px; color: #d1d5db; cursor: pointer; }
        .pac-item:hover { background-color: #4b5563; }
        .pac-item-query { font-weight: 600; color: #f3f4f6; }
        #schedule-modal { display: none; }
        #schedule-modal.flex { display: flex; }

        /* --- CSS PARA ABAS --- */
        .tab-button { background-color: #374151; border: 1px solid #4b5563; padding: 10px 15px; cursor: pointer; transition: all 0.2s ease-in-out; border-radius: 8px; font-weight: 600; }
        .tab-button.active { background-color: #00ffff; color: #000 !important; border-color: #00ffff; }
        .admin-sub-screen { display: none; }
        .admin-sub-screen.active { display: block; }

    </style>
</head>
<body class="main-gradient text-white min-h-screen flex items-start justify-center p-4 pt-8">

    <div id="app-container" class="w-full max-w-md mx-auto"> 

        <div id="company-login-screen" class="screen active">
            <div id="admin-access-icon" title="Acesso Super Admin" onclick="showSuperAdminLogin()" style="position: absolute; top: 1rem; right: 1rem; cursor: pointer; padding: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>
           
            <h2 class="text-3xl font-bold mb-6 text-center">Login da Empresa</h2>
            <div class="mb-4"><label for="company-login-select" class="block mb-2 text-sm font-medium">Empresa</label><select id="company-login-select" class="w-full p-3 rounded-lg"></select></div>
            <div class="mb-4"><label for="company-password-input" class="block mb-2 text-sm font-medium">Senha da Empresa</label><input type="password" id="company-password-input" class="w-full p-3 rounded-lg" placeholder="Digite a senha"></div>
            <button onclick="verifyCompanyPassword()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">ENTRAR</button>
            <p id="company-login-error" class="text-red-500 text-center mt-4 hidden">Senha da empresa incorreta!</p>
            <p class="text-xs text-center text-gray-400 mt-4">
                Esqueceu a senha? Use o acesso Super Admin (ícone de escudo <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 align-text-bottom" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> no canto superior direito) para gerenciar as empresas.
            </p>
        </div>

        <div id="super-admin-login-screen" class="screen">
            <button onclick="showScreen('company-login-screen')" class="mb-4 text-cyan-400 hover:text-cyan-200">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Acesso Super Admin</h2>
            <div class="mb-4"><label for="super-admin-password-input" class="block mb-2 text-sm font-medium">Senha Mestra</label><input type="password" id="super-admin-password-input" class="w-full p-3 rounded-lg text-center" placeholder="Digite a senha mestra"></div>
            <button onclick="verifySuperAdminPassword()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">ENTRAR</button>
            <p id="super-admin-login-error" class="text-red-500 text-center mt-4 hidden">Senha mestra incorreta!</p>
        </div>
       
        <div id="admin-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <p id="admin-welcome-message" class="text-lg text-gray-300"></p>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 p-2 rounded-lg">Sair</button>
            </div>

            <div class="flex flex-wrap justify-center gap-2 mb-6">
                <button id="tab-request-ride" class="tab-button active" onclick="showAdminSubScreen('request-ride-screen')">Solicitar Corrida</button>
                <button id="tab-approve-ride" class="tab-button" onclick="showAdminSubScreen('approval-ride-screen')">Aprovar Solicitações</button>
                <button id="tab-history" class="tab-button" onclick="showAdminSubScreen('history-screen')">Histórico</button>
                <button id="tab-users" class="tab-button" onclick="showAdminSubScreen('user-management-screen')">Gerenciar Usuários</button>
            </div>

            <div id="request-ride-screen" class="admin-sub-screen active">
                <h2 class="text-2xl font-bold text-center mb-4">Solicitar Corrida</h2>
                <div id="admin-request-form" class="card-gradient p-6 rounded-lg">
                    <div class="mb-6"><label for="collaborator-select" class="block mb-2 text-sm font-medium">Colaborador</label><select id="collaborator-select" class="w-full p-3 rounded-lg"><option value="">-- Carregando... --</option></select></div>
                    <div id="admin-ride-details" class="hidden">
                        <hr class="border-gray-600 my-6"><h3 class="text-lg font-semibold mb-4 text-center">Detalhes da Viagem</h3>
                        <div class="mb-4"><label for="admin-origin" class="block mb-2 text-sm font-medium">Origem <span class="text-red-400">(Obrigatório)</span></label><input type="text" id="admin-origin" class="w-full p-3 rounded-lg" placeholder="Digite o endereço de partida"></div>
                        <div class="mb-4"><label for="admin-passenger-count" class="block mb-2 text-sm font-medium">Passageiros</label><select id="admin-passenger-count" class="w-full p-3 rounded-lg"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                        <div id="admin-destinations-container" class="w-full"></div>
                        <div class="mb-4"><label for="admin-observation" class="block mb-2 text-sm font-medium">Observação</label><textarea id="admin-observation" class="w-full p-3 rounded-lg" placeholder="Ex: Ponto de referência..." rows="2"></textarea></div>
                        <div class="mt-6 space-y-3">
                            <button id="admin-request-immediate-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">SOLICITAR AGORA</button>
                            <button id="admin-request-scheduled-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">AGENDAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="approval-ride-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Aprovar Solicitações Pendentes</h2>
                <div id="pending-rides-container" class="space-y-4">
                </div>
            </div>

            <div id="history-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Histórico de Corridas</h2>
                <div id="history-rides-container" class="space-y-4">
                </div>
            </div>

            <div id="user-management-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Gerenciar Usuários</h2>
                <div class="card-gradient p-4 rounded-lg mb-6">
                    <h3 id="user-form-title" class="text-lg font-semibold mb-2">Adicionar Usuário</h3>
                    <input type="hidden" id="editing-user-id">
                    <div class="space-y-2">
                        <input type="text" id="new-user-matricula" placeholder="Matrícula" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-address" placeholder="Endereço" class="w-full p-2 rounded-lg">
                        <input type="tel" id="new-user-phone" placeholder="Telefone" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-password" placeholder="Senha" class="w-full p-2 rounded-lg">
                    </div>
                    <button onclick="addOrUpdateUser()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700 mt-3">Salvar</button>
                    <button id="cancel-user-edit-btn" onclick="cancelUserEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                </div>
                <div id="user-list-container" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div id="company-management-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Gerenciar Empresas</h2>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 p-2 rounded-lg">Sair</button>
            </div>
            <div class="card-gradient p-4 rounded-lg mb-6">
                <h3 id="company-form-title" class="text-lg font-semibold mb-2">Adicionar Empresa</h3>
                <input type="hidden" id="editing-company-id">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="new-company-name" placeholder="Nome da Empresa" class="w-full p-2 rounded-lg">
                    <input type="text" id="new-company-password" placeholder="Senha" class="w-full p-2 rounded-lg">
                </div>
                <button onclick="addOrUpdateCompany()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700">Salvar</button>
                <button id="cancel-edit-btn" onclick="cancelEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
            </div>
            <div id="company-list-container" class="space-y-3"></div>
        </div>
    </div>
   
    <div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4">Agendar Corrida</h3>
            <div class="mb-4 text-left">
                <label for="schedule-date" class="block mb-2 text-sm font-medium">Data</label>
                <input type="date" id="schedule-date" class="w-full p-3 rounded-lg">
            </div>
            <div class="mb-6 text-left">
                <label for="schedule-time" class="block mb-2 text-sm font-medium">Hora</label>
                <input type="time" id="schedule-time" class="w-full p-3 rounded-lg">
            </div>
            <div class="flex justify-center gap-4">
                <button onclick="closeScheduleModal()" class="py-2 px-6 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button onclick="confirmAdminSchedule()" class="py-2 px-8 font-semibold rounded-lg button-gradient">AGENDAR</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jowsbmuqbzxukbbxbeqv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w';
        const GOOGLE_MAPS_API_KEY = 'AIzaSyADSCUHjzyFUwjfcui_lk6vDSQ3PU0bu7g';
       
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
       
        let state = { loggedInCompany: null, allUsers: [] };
        let adminSelectedRequestType = '';
        let adminScheduledDateTime = null;
        let originalCollaboratorAddress = '';
        let companyUsersCache = [];

        function initializeGoogleMaps() {
            if (document.getElementById('google-maps-script-tag')) return;
            const script = document.createElement('script');
            script.id = 'google-maps-script-tag';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`;
            script.async = true;
            document.head.appendChild(script);
        }

        function initAutocomplete(inputElement) {
            if (inputElement && typeof google !== 'undefined' && google.maps && google.maps.places) {
                new google.maps.places.Autocomplete(inputElement, {
                    types: ['address'],
                    componentRestrictions: { 'country': 'br' }
                });
            }
        }
       
        function resetAdminForm() {
            document.getElementById('collaborator-select').value = '';
            document.getElementById('admin-ride-details').classList.add('hidden');
            document.getElementById('admin-origin').value = '';
            document.getElementById('admin-passenger-count').value = '1';
            document.getElementById('admin-destinations-container').innerHTML = '';
            document.getElementById('admin-observation').value = '';
            originalCollaboratorAddress = '';
            document.getElementById('admin-origin').oninput = null;
        }

        function showScreen(screenId) { 
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active')); 
            document.getElementById(screenId)?.classList.add('active'); 
        }
       
        function logout() { 
            state.loggedInCompany = null; 
            document.getElementById('company-password-input').value = ''; 
            document.getElementById('super-admin-password-input').value = ''; 
            resetAdminForm();
            showScreen('company-login-screen'); 
        }

        function showSuperAdminLogin() {
            showScreen('super-admin-login-screen');
        }

        async function verifySuperAdminPassword() {
            const passwordInput = document.getElementById('super-admin-password-input');
            const password = passwordInput.value;
            const errorEl = document.getElementById('super-admin-login-error');
            errorEl.classList.add('hidden');
            
            // A senha mestra do Super Admin é '789512'
            if (password === '789512') {
                state.loggedInCompany = { name: "Super Admin" };
                await loadCompanyManagement();
                showScreen('company-management-screen');
                passwordInput.value = '';
            } else {
                errorEl.classList.remove('hidden');
            }
        }

        async function verifyCompanyPassword() {
            const companyName = document.getElementById('company-login-select').value;
            const password = document.getElementById('company-password-input').value.trim();
            const errorEl = document.getElementById('company-login-error');
            errorEl.classList.add('hidden');

            if (!companyName || !password) {
                errorEl.textContent = 'Preencha todos os campos.';
                errorEl.classList.remove('hidden');
                return;
            }
           
            const { data, error } = await supabaseClient.from('companies').select('*').eq('name', companyName).eq('password', password).single();
           
            if (error || !data) {
                errorEl.textContent = 'Senha da empresa incorreta!';
                errorEl.classList.remove('hidden');
            } else {
                state.loggedInCompany = data;
                await setupAdminScreen();
                showScreen('admin-screen');
                showAdminSubScreen('request-ride-screen'); // Go to default tab after login
            }
        }
        
        async function refreshAllUsers() {
            const { data: users, error: usersError } = await supabaseClient.from('users').select('id, name, company, address');
            if (usersError) { 
                console.error("Erro ao recarregar todos os usuários:", usersError); 
                return; 
            }
            state.allUsers = users;
        }

        async function refreshCollaboratorDropdown() {
             const collaboratorSelect = document.getElementById('collaborator-select');
             const loggedInCompanyName = state.loggedInCompany.name;
             const collaborators = state.allUsers.filter(user => user.company === loggedInCompanyName);

             collaborators.sort((a, b) => a.name.localeCompare(b.name));
            
             const selectedValue = collaboratorSelect.value;
             collaboratorSelect.innerHTML = '<option value="">-- Selecione o Colaborador --</option>';
             collaborators.forEach(user => {
                 collaboratorSelect.innerHTML += `<option value="${user.id}">${user.name}</option>`;
             });
             collaboratorSelect.value = selectedValue; // Preserve selection if possible
             collaboratorSelect.disabled = false;
        }

        async function setupAdminScreen() {
            document.getElementById('admin-welcome-message').textContent = `Bem-vindo, ${state.loggedInCompany.name}!`;
            resetAdminForm(); 

            await refreshAllUsers();
            await refreshCollaboratorDropdown();
           
            document.getElementById('collaborator-select').removeEventListener('change', handleCollaboratorChange);
            document.getElementById('collaborator-select').addEventListener('change', handleCollaboratorChange);

            document.getElementById('admin-passenger-count').removeEventListener('change', (e) => adminUpdateDestinationFields(e.target.value));
            document.getElementById('admin-passenger-count').addEventListener('change', (e) => adminUpdateDestinationFields(e.target.value));
        }

        function handleCollaboratorChange(event) {
            const rideDetails = document.getElementById('admin-ride-details');
            const selectedUserId = event.target.value;
            const showDetails = !!selectedUserId;
           
            rideDetails.classList.toggle('hidden', !showDetails);
           
            document.getElementById('admin-origin').oninput = null;

            if (showDetails) {
                const selectedUser = state.allUsers.find(user => user.id == selectedUserId);
               
                originalCollaboratorAddress = (selectedUser && selectedUser.address) ? selectedUser.address : '';
                document.getElementById('admin-origin').value = originalCollaboratorAddress;
               
                if (originalCollaboratorAddress) {
                    confirm("ORIGEM RESIDÊNCIA do COLABORADOR, EDITE ou MARQUE OK");
                }
               
                initAutocomplete(document.getElementById('admin-origin'));
                adminUpdateDestinationFields(document.getElementById('admin-passenger-count').value);
            } else {
                 resetAdminForm();
            }
        }

        function adminUpdateDestinationFields(passengerCount) {
            const container = document.getElementById('admin-destinations-container');
            container.innerHTML = '';
            for (let i = 1; i <= passengerCount; i++) {
                const labelText = i === 1 ? 'Destino Passageiro 1 <span class="text-red-400">(Obrigatório)</span>' : `Destino Passageiro ${i}`;
                container.innerHTML += `<div class="mb-4"><label class="block mb-2 text-sm font-medium">${labelText}</label><input type="text" id="admin-destination-${i}" class="w-full p-3 rounded-lg" placeholder="Digite o endereço completo"></div>`;
            }

            for (let i = 1; i <= passengerCount; i++) {
                initAutocomplete(document.getElementById(`admin-destination-${i}`));
            }
        }
       
        function openAdminScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            const today = new Date();
            document.getElementById('schedule-date').value = today.toISOString().split('T')[0];
            document.getElementById('schedule-time').value = today.toTimeString().slice(0, 5);
            modal.classList.add('flex');
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('flex');
        }

        function confirmAdminSchedule() {
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            if (!dateInput.value || !timeInput.value) { return alert('Por favor, selecione data e hora.'); }
           
            const scheduledDate = new Date(`${dateInput.value}T${timeInput.value}`);

            adminScheduledDateTime = scheduledDate.toISOString();
            adminSelectedRequestType = 'scheduled';
           
            closeScheduleModal();
            adminRequestRide();
        }

        async function adminRequestRide() {
            const collaboratorId = document.getElementById('collaborator-select').value;
            if (!collaboratorId) return alert('Selecione um colaborador.');

            const collaborator = state.allUsers.find(u => u.id == collaboratorId);
            const passengerCount = document.getElementById('admin-passenger-count').value;
            const destinations = [];
            for (let i = 1; i <= passengerCount; i++) {
                const destValue = document.getElementById(`admin-destination-${i}`)?.value.trim();
                if (destValue) destinations.push(destValue);
            }

            if (!document.getElementById('admin-origin').value.trim() || destinations.length === 0) {
                return alert('Origem e pelo menos um Destino são obrigatórios.');
            }

            let rideData = {
                userId: collaborator.id,
                userName: collaborator.name,
                userCompany: collaborator.company,
                origin_address: document.getElementById('admin-origin').value.trim(),
                destination: JSON.stringify(destinations),
                passenger_count: parseInt(passengerCount),
                observation: document.getElementById('admin-observation').value.trim(),
                requestTime: new Date().toISOString(),
                requested_by_admin_name: state.loggedInCompany.name,
            };

            if (adminSelectedRequestType === 'scheduled' && adminScheduledDateTime) {
                rideData.status = 'scheduled';
                rideData.request_type = 'scheduled';
                rideData.scheduled_datetime = adminScheduledDateTime;
            } else {
                rideData.status = 'requested';
                rideData.request_type = 'immediate';
            }

            const { error } = await supabaseClient.from('rides').insert([rideData]);
           
            if (error) {
                alert('Erro ao solicitar corrida: ' + error.message);
            } else {
                alert(`Corrida para ${collaborator.name} solicitada com sucesso!`);
                resetAdminForm();
                document.getElementById('admin-ride-details').classList.add('hidden');
            }

            adminSelectedRequestType = '';
            adminScheduledDateTime = null;
        }

        async function populateLoginCompanies() {
            const select = document.getElementById('company-login-select');
            select.innerHTML = '<option>Carregando...</option>';
            const { data, error } = await supabaseClient.from('companies').select('id, name').order('name');
            if (error) { 
                select.innerHTML = '<option>Erro</option>'; 
                console.error("ERRO AO CARREGAR EMPRESAS:", error);
                return; 
            }
            select.innerHTML = data.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }
       
        function showAdminSubScreen(subScreenId) {
            document.querySelectorAll('.admin-sub-screen').forEach(screen => screen.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            document.getElementById(subScreenId).classList.add('active');
            if (subScreenId === 'request-ride-screen') {
                document.getElementById('tab-request-ride').classList.add('active');
            } else if (subScreenId === 'approval-ride-screen') {
                document.getElementById('tab-approve-ride').classList.add('active');
                loadPendingRides();
            } else if (subScreenId === 'history-screen') {
                document.getElementById('tab-history').classList.add('active');
                loadHistoryRides();
            } else if (subScreenId === 'user-management-screen') {
                document.getElementById('tab-users').classList.add('active');
                loadCompanyUsers();
            }
        }
       
        async function loadPendingRides() {
            const container = document.getElementById('pending-rides-container');
            container.innerHTML = '<p class="text-center">Carregando solicitações...</p>';

            const { data: rides, error } = await supabaseClient
                .from('rides')
                .select('*')
                .eq('userCompany', state.loggedInCompany.name)
                .eq('status', 'pending_approval')
                .order('requestTime', { ascending: true });

            if (error) {
                container.innerHTML = '<p class="text-center text-red-500">Erro ao carregar solicitações.</p>';
                console.error("Erro ao buscar corridas pendentes:", error);
                return;
            }

            if (rides.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">Nenhuma solicitação pendente no momento.</p>';
                return;
            }

            container.innerHTML = rides.map(ride => {
                const destinations = JSON.parse(ride.destination || '[]');
                const requestDate = new Date(ride.requestTime).toLocaleString('pt-BR');
               
                return `
                    <div id="ride-card-${ride.id}" class="card-gradient p-4 rounded-lg border border-gray-700">
                        <p class="font-bold text-lg">${ride.userName}</p>
                        <p class="text-sm text-gray-400 mb-3">Solicitado em: ${requestDate}</p>
                        <div class="text-sm space-y-1">
                            <p><strong>De:</strong> ${ride.origin_address}</p>
                            <p><strong>Para:</strong> ${destinations.join(', ')}</p>
                            ${ride.observation ? `<p><strong>Obs:</strong> ${ride.observation}</p>` : ''}
                        </div>
                        <div class="flex justify-end gap-3 mt-4">
                             <button onclick="rejectRide(${ride.id})" class="py-2 px-5 font-semibold rounded-lg bg-red-600 hover:bg-red-700">NÃO ACEITAR</button>
                             <button onclick="approveRide(${ride.id})" class="py-2 px-5 font-semibold rounded-lg bg-green-600 hover:bg-green-700">ACEITE</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadHistoryRides() {
            const container = document.getElementById('history-rides-container');
            container.innerHTML = '<p class="text-center">Carregando histórico...</p>';

            const { data: rides, error } = await supabaseClient
                .from('rides')
                .select('*')
                .eq('userCompany', state.loggedInCompany.name)
                .not('status', 'eq', 'pending_approval')
                .order('requestTime', { ascending: false });

            if (error) {
                container.innerHTML = '<p class="text-center text-red-500">Erro ao carregar o histórico.</p>';
                console.error("Erro ao buscar histórico de corridas:", error);
                return;
            }

            if (rides.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">Nenhum registro de corrida encontrado.</p>';
                return;
            }

            const statusMap = {
                'approved': { text: 'Aprovada', color: 'text-green-400' },
                'rejected': { text: 'Rejeitada', color: 'text-red-500' },
                'scheduled': { text: 'Agendada', color: 'text-cyan-400' },
                'completed': { text: 'Concluída', color: 'text-purple-400' },
                'cancelled': { text: 'Cancelada', color: 'text-yellow-500' },
                'requested': { text: 'Solicitada (Aguardando Motorista)', color: 'text-yellow-300'}
            };

            container.innerHTML = rides.map(ride => {
                const destinations = JSON.parse(ride.destination || '[]');
                const requestDate = new Date(ride.requestTime).toLocaleString('pt-BR');
                const statusInfo = statusMap[ride.status] || { text: ride.status, color: 'text-gray-300' };
               
                return `
                    <div class="card-gradient p-4 rounded-lg border border-gray-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">${ride.userName}</p>
                                <p class="text-sm text-gray-400 mb-3">Solicitado em: ${requestDate}</p>
                            </div>
                            <span class="font-bold ${statusInfo.color}">${statusInfo.text}</span>
                        </div>
                        <div class="text-sm space-y-1">
                            <p><strong>De:</strong> ${ride.origin_address}</p>
                            <p><strong>Para:</strong> ${destinations.join(', ')}</p>
                            ${ride.observation ? `<p><strong>Obs:</strong> ${ride.observation}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function approveRide(rideId) {
            if (!confirm('Tem certeza que deseja APROVAR esta corrida?')) return;

            const { error } = await supabaseClient
                .from('rides')
                .update({ status: 'approved' })
                .eq('id', rideId);

            if (error) {
                alert('Erro ao aprovar a corrida: ' + error.message);
            } else {
                alert('Corrida aprovada com sucesso!');
                loadPendingRides(); // Recarrega a lista
            }
        }

        async function rejectRide(rideId) {
            if (!confirm('Tem certeza que deseja NÃO ACEITAR esta corrida?')) return;
           
            const { error } = await supabaseClient
                .from('rides')
                .update({ status: 'rejected' })
                .eq('id', rideId);

            if (error) {
                alert('Erro ao rejeitar a corrida: ' + error.message);
            } else {
                alert('Corrida não aceita.');
                loadPendingRides(); // Recarrega a lista
            }
        }
       
        function initApp() {
            initializeGoogleMaps();
            populateLoginCompanies();
           
            document.getElementById('admin-request-immediate-btn').onclick = () => {
                adminSelectedRequestType = 'immediate';
                adminScheduledDateTime = null;
                adminRequestRide();
            };
            document.getElementById('admin-request-scheduled-btn').onclick = openAdminScheduleModal;

             supabaseClient
                .channel('public:rides')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, payload => {
                    const activeScreen = document.querySelector('.screen.active');
                    if (!activeScreen) return;

                    const activeSubScreen = activeScreen.querySelector('.admin-sub-screen.active');
                    if (activeSubScreen) {
                        if (activeSubScreen.id === 'approval-ride-screen') {
                            loadPendingRides();
                        } else if (activeSubScreen.id === 'history-screen') {
                            loadHistoryRides();
                        }
                    }
                })
                .subscribe();
             supabaseClient
                .channel('public:users')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, async (payload) => {
                    await refreshAllUsers(); // Refresh the global user list
                    const activeScreen = document.querySelector('.screen.active');
                     if (!activeScreen || !state.loggedInCompany) return;
                    
                     // Refresh collaborator dropdown if we are on the request screen
                     if (activeScreen.querySelector('#request-ride-screen.active')) {
                         await refreshCollaboratorDropdown();
                     }

                     // Refresh user management list if we are on that screen
                     const activeSubScreen = activeScreen.querySelector('.admin-sub-screen.active');
                     if (activeSubScreen && activeSubScreen.id === 'user-management-screen') {
                        if(payload.new?.company === state.loggedInCompany.name || payload.old?.company === state.loggedInCompany.name) {
                           await loadCompanyUsers();
                        }
                     }
                })
                .subscribe();
        }

        document.addEventListener('DOMContentLoaded', initApp);

        // --- COMPANY CRUD FUNCTIONS ---

        async function loadCompanyManagement() {
            const container = document.getElementById('company-list-container');
            container.innerHTML = '<p>Carregando...</p>';
            const { data, error } = await supabaseClient.from('companies').select('*').order('name');
            if (error) {
                container.innerHTML = '<p>Erro ao carregar.</p>';
                console.error(error);
                return;
            }
            container.innerHTML = data.map(c => `
                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-lg">${c.name}</p>
                        <p class="text-sm text-gray-400">Senha: ${c.password}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCompany(${c.id},'${c.name}','${c.password}')" class="py-1 px-3 font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Editar</button>
                        <button onclick="deleteCompany(${c.id},'${c.name}')" class="py-1 px-3 font-semibold rounded-lg bg-red-600 hover:bg-red-700">X</button>
                    </div>
                </div>
            `).join('');
        }

        function editCompany(id, name, password) {
            document.getElementById('editing-company-id').value = id;
            document.getElementById('new-company-name').value = name;
            document.getElementById('new-company-password').value = password;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('company-form-title').textContent = 'Editar Empresa';
            window.scrollTo(0, 0); // Rola para o topo para ver o formulário
        }

        function cancelEdit() {
            document.getElementById('editing-company-id').value = '';
            document.getElementById('new-company-name').value = '';
            document.getElementById('new-company-password').value = '';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('company-form-title').textContent = 'Adicionar Empresa';
        }

        async function addOrUpdateCompany() {
            const id = document.getElementById('editing-company-id').value;
            const name = document.getElementById('new-company-name').value.trim();
            const password = document.getElementById('new-company-password').value.trim();
            if (!name || !password) return alert('Nome e Senha são obrigatórios.');

            let result;
            if (id) {
                // UPDATE
                result = await supabaseClient.from('companies').update({ name, password }).eq('id', id);
            } else {
                // CREATE (with upsert to prevent duplicates by name on creation)
                result = await supabaseClient.from('companies').upsert({ name, password }, { onConflict: 'name' });
            }
           
            const { error } = result;

            if (error) {
                alert('Erro ao salvar empresa: ' + error.message);
                console.error(error);
            } else {
                cancelEdit(); // Limpa o formulário e reseta o estado de edição
                await populateLoginCompanies();
                await loadCompanyManagement();
            }
        }

        async function deleteCompany(id, name) {
            if (!confirm(`Tem certeza que deseja excluir a empresa "${name}"? Esta ação não pode ser desfeita.`)) return;
           
            const { error } = await supabaseClient.from('companies').delete().eq('id', id);
           
            if (error) {
                alert('Erro ao excluir empresa: ' + error.message);
            } else {
                alert(`Empresa "${name}" excluída com sucesso.`);
                await populateLoginCompanies(); // Atualiza o dropdown de login
                await loadCompanyManagement(); // Atualiza a lista de empresas
            }
        }

        // --- USER CRUD FUNCTIONS (COMPANY ADMIN) ---

        async function loadCompanyUsers() {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '<p>Carregando usuários...</p>';

            if (!state.loggedInCompany || !state.loggedInCompany.name) {
                container.innerHTML = '<p>Erro: Empresa não identificada.</p>';
                return;
            }

            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('company', state.loggedInCompany.name)
                .order('name');

            if (error) {
                container.innerHTML = '<p class="text-red-500">Erro ao carregar usuários.</p>';
                console.error(error);
                return;
            }
             companyUsersCache = data;

            if (data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">Nenhum usuário cadastrado para esta empresa.</p>';
                return;
            }

            container.innerHTML = data.map(user => `
                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-lg">${user.name}</p>
                        <p class="text-sm text-gray-400">Matrícula: ${user.matricula || 'N/A'}</p>
                        <p class="text-sm text-gray-400">Endereço: ${user.address || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='editUserById(${user.id})' class="py-1 px-3 font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Editar</button>
                        <button onclick="deleteUser(${user.id},'${user.name}')" class="py-1 px-3 font-semibold rounded-lg bg-red-600 hover:bg-red-700">X</button>
                    </div>
                </div>
            `).join('');
        }

        function editUserById(userId) {
            const user = companyUsersCache.find(u => u.id === userId);
            if (!user) return alert('Usuário não encontrado');

            document.getElementById('editing-user-id').value = user.id;
            document.getElementById('new-user-matricula').value = user.matricula || '';
            document.getElementById('new-user-name').value = user.name || '';
            document.getElementById('new-user-address').value = user.address || '';
            document.getElementById('new-user-phone').value = user.phone || '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-password').placeholder = 'Nova Senha (deixe em branco para manter)';

            document.getElementById('cancel-user-edit-btn').classList.remove('hidden');
            document.getElementById('user-form-title').textContent = 'Editar Usuário';
            window.scrollTo(0, 0);
        }

        function cancelUserEdit() {
            document.getElementById('editing-user-id').value = '';
            document.getElementById('new-user-matricula').value = '';
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-address').value = '';
            document.getElementById('new-user-phone').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-password').placeholder = 'Senha';

            document.getElementById('cancel-user-edit-btn').classList.add('hidden');
            document.getElementById('user-form-title').textContent = 'Adicionar Usuário';
        }

        async function addOrUpdateUser() {
            const id = document.getElementById('editing-user-id').value;
            const matricula = document.getElementById('new-user-matricula').value.trim();
            const name = document.getElementById('new-user-name').value.trim();
            const address = document.getElementById('new-user-address').value.trim();
            const phone = document.getElementById('new-user-phone').value.trim();
            const password = document.getElementById('new-user-password').value.trim();
            
            if (!matricula || !name) {
                return alert('Matrícula e Nome são obrigatórios.');
            }

            let userData = {
                matricula,
                name,
                address,
                phone,
                company: state.loggedInCompany.name
            };

            if (password) {
                userData.password = password;
            }

            let result;
            if (id) {
                // UPDATE
                result = await supabaseClient.from('users').update(userData).eq('id', id);
            } else {
                // CREATE
                if (!password) return alert('Senha é obrigatória para novos usuários.');
                userData.password = password;
                result = await supabaseClient.from('users').insert([userData]);
            }
        
            const { error } = result;

            if (error) {
                alert('Erro ao salvar usuário: ' + error.message);
                console.error(error);
            } else {
                alert('Usuário salvo com sucesso!');
                cancelUserEdit();
                // No need to call Supabase again, just update local state and re-render
                await loadCompanyUsers(); 
                await refreshAllUsers(); 
                await refreshCollaboratorDropdown(); 
            }
        }

        async function deleteUser(id, name) {
            if (!confirm(`Tem certeza que deseja excluir o usuário "${name}"?`)) return;
        
            const { error } = await supabaseClient.from('users').delete().eq('id', id);
        
            if (error) {
                alert('Erro ao excluir usuário: ' + error.message);
            } else {
                alert(`Usuário "${name}" excluído com sucesso.`);
                await loadCompanyUsers();
                await refreshAllUsers();
                await refreshCollaboratorDropdown();
            }
        }
    </script>
</body>

</html>
